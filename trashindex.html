<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de QR para Indumentaria</title>
    <meta name="theme-color" content="#4f46e5">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icono.png">
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-100 font-sans">
    <div id="app-container" class="max-w-2xl mx-auto p-4 md:p-6">
        <header class="text-center mb-8 flex items-center justify-center">
            <!-- LOGO: Added logo.png next to the title -->
            <img src="logo.png" alt="Logo de la aplicación" class="w-8 h-8 mr-3 rounded-md"
                onerror="this.onerror=null; this.src='https://placehold.co/32x32/4f46e5/ffffff?text=G&font=sans'">
            <h1 class="text-4xl font-bold text-indigo-600 mr-2">Gestor de QR</h1>
            <!-- VERSION: Updated to v.2.8 (Restored Venta Manual + Photo Fix) -->
            <span class="text-xs font-normal text-gray-600">v.2.8 (Restored Venta Manual + Photo Fix)</span>
        </header>
        <!-- Menú Principal -->
        <main id="main-menu" class="space-y-4">
            <!-- NUEVO BOTÓN DE INSTALACIÓN PWA -->
            <button id="install-app-modal-btn" class="w-full bg-blue-500 text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:bg-blue-600 transition duration-300 flex items-center justify-center text-lg hidden">
                <i class="fas fa-mobile-alt mr-3"></i> Descargar Aplicación
            </button>
            <button id="show-generation-btn" class="w-full bg-indigo-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition duration-300 flex items-center justify-center text-lg">
                <i class="fas fa-plus-circle mr-3"></i> Generar QR
            </button>
            <button id="show-scanner-btn" class="w-full bg-purple-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:bg-purple-700 transition duration-300 flex items-center justify-center text-lg">
                <i class="fas fa-qrcode mr-3"></i> Escanear QR
            </button>
            <button id="show-history-btn" class="w-full bg-gray-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:bg-gray-800 transition duration-300 flex items-center justify-center text-lg">
                <i class="fas fa-history mr-3"></i> Historial de QR
            </button>
            <button id="show-metrics-btn" class="w-full bg-teal-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:bg-teal-700 transition duration-300 flex items-center justify-center text-lg">
                <i class="fas fa-chart-line mr-3"></i> Métricas
            </button>
        </main>
        <!-- Sección de Generación -->
        <section id="generation-section" class="hidden">
            <button class="back-to-menu text-indigo-600 mb-4 font-semibold"><i class="fas fa-arrow-left mr-2"></i> Volver al menú</button>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Registrar Prenda</h2>
                <form id="qr-form" class="space-y-4">
                    <!-- CAMPO DE FOTO/CÁMARA/IMPORTAR (MODIFICADO) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Foto de la Prenda (Opcional)</label>
                        <div class="flex space-x-3">
                            <!-- Input para la CÁMARA (Fuerza la apertura de la cámara si es compatible) -->
                            <input type="file" id="camera-photo-input" name="cameraPhoto" accept="image/*" capture="environment" class="hidden">
                            <button type="button" id="open-camera-btn" class="flex-1 bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-600 transition flex items-center justify-center text-sm">
                                <i class="fas fa-camera mr-2"></i> Usar Cámara
                            </button>
                            <!-- Input para IMPORTAR ARCHIVO (Abre el selector de archivos) -->
                            <input type="file" id="import-photo-input" name="importPhoto" accept="image/*" class="hidden">
                            <button type="button" id="import-file-btn" class="flex-1 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 transition flex items-center justify-center text-sm">
                                <i class="fas fa-file-upload mr-2"></i> Importar Foto
                            </button>
                        </div>
                        <div id="photo-preview-container" class="mt-4 hidden">
                            <p class="text-xs text-gray-500 mb-1">Previsualización:</p>
                            <img id="photo-preview" src="" alt="Previsualización de la foto" class="max-w-full h-32 object-contain rounded-lg border border-gray-300 w-full">
                            <button type="button" id="remove-photo-btn" class="mt-2 text-red-500 hover:text-red-700 text-sm font-semibold"><i class="fas fa-trash-alt mr-1"></i> Quitar Foto</button>
                        </div>
                    </div>
                    <!-- FIN CAMPO FOTO (MODIFICADO) -->
                    <div>
                        <label for="precio-efectivo" class="block text-sm font-medium text-gray-700">Precio Efectivo (ARS) *</label>
                        <input type="number" id="precio-efectivo" name="precioEfectivo" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="precio-lista" class="block text-sm font-medium text-gray-700">Precio de Lista (ARS) *</label>
                        <input type="number" id="precio-lista" name="precioLista" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="talle" class="block text-sm font-medium text-gray-700">Talle *</label>
                        <input type="text" id="talle" name="talle" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tipo de Ropa *</label>
                        <div id="tipo-ropa-container" class="mt-2 space-y-2">
                            <div class="flex items-center">
                                <input id="tipo_importada" name="tipo_ropa" type="checkbox" value="Importada" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="tipo_importada" class="ml-3 block text-sm text-gray-900">Importada</label>
                            </div>
                            <div class="flex items-center">
                                <input id="tipo_nacional" name="tipo_ropa" type="checkbox" value="Nacional" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="tipo_nacional" class="ml-3 block text-sm text-gray-900">Nacional</label>
                            </div>
                            <div class="flex items-center">
                                <input id="tipo_nuevo" name="tipo_ropa" type="checkbox" value="Nuevo" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="tipo_nuevo" class="ml-3 block text-sm text-gray-900">Nuevo</label>
                            </div>
                        </div>
                        <button type="button" id="add-custom-tipo" class="mt-2 bg-blue-500 text-white font-semibold py-1 px-2 rounded-lg shadow-md hover:bg-blue-600 transition"><i class="fas fa-plus mr-1"></i> Añadir tipo personalizado</button>
                    </div>
                    <div>
                        <label for="vendedora" class="block text-sm font-medium text-gray-700">Vendedora (Opcional)</label>
                        <input type="text" id="vendedora" name="vendedora" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripción (Opcional)</label>
                        <textarea id="descripcion" name="descripcion" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                    <div class="pt-2 border-t border-gray-200 space-y-3">
                        <button type="button" id="generate-desc-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-purple-700 transition duration-300 flex items-center justify-center">
                            Generar Descripción Inteligente
                        </button>
                        <!-- BOTÓN PARA ANÁLISIS DE RIESGO DE STOCK -->
                        <button type="button" id="analyze-stock-risk-btn" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-orange-600 transition duration-300 flex items-center justify-center">
                            Analizar Riesgo de Stock
                        </button>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Generar QR y Guardar</button>
                </form>
            </div>
            <div id="gemini-output-section" class="hidden mt-6 bg-purple-50 p-6 rounded-xl shadow-inner">
                <h3 class="text-xl font-bold text-purple-800 mb-3" id="gemini-output-title">Sugerencia de la IA</h3>
                <textarea id="gemini-output" readonly class="w-full h-40 p-2 border border-purple-200 rounded-md bg-white resize-none"></textarea>
                <button id="copy-desc-btn" class="mt-2 py-2 px-4 bg-purple-500 text-white font-semibold rounded-lg shadow-md hover:bg-purple-600 transition"><i class="fas fa-copy mr-2"></i>Copiar Texto</button>
            </div>
            <div id="qr-display" class="hidden mt-6 bg-white p-6 rounded-xl shadow-lg text-center"></div>
        </section>
        <!-- Sección de Edición -->
        <section id="edit-section" class="hidden">
            <button class="back-to-history text-indigo-600 mb-4 font-semibold"><i class="fas fa-arrow-left mr-2"></i> Volver al historial</button>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Editar Prenda</h2>
                <form id="edit-form" class="space-y-4">
                    <input type="hidden" id="edit-id" name="id">
                    <!-- CAMPO DE FOTO/CÁMARA/IMPORTAR EDICIÓN (MODIFICADO) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Foto de la Prenda (Opcional)</label>
                        <div class="flex space-x-3">
                            <!-- Input para la CÁMARA (Fuerza la apertura de la cámara si es compatible) -->
                            <input type="file" id="edit-camera-photo-input" name="editCameraPhoto" accept="image/*" capture="environment" class="hidden">
                            <button type="button" id="edit-open-camera-btn" class="flex-1 bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-600 transition flex items-center justify-center text-sm">
                                <i class="fas fa-camera mr-2"></i> Usar Cámara
                            </button>
                            <!-- Input para IMPORTAR ARCHIVO (Abre el selector de archivos) -->
                            <input type="file" id="edit-import-photo-input" name="editImportPhoto" accept="image/*" class="hidden">
                            <button type="button" id="edit-import-file-btn" class="flex-1 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 transition flex items-center justify-center text-sm">
                                <i class="fas fa-file-upload mr-2"></i> Importar Foto
                            </button>
                        </div>
                        <div id="edit-photo-preview-container" class="mt-4 hidden">
                            <p class="text-xs text-gray-500 mb-1">Previsualización Actual:</p>
                            <img id="edit-photo-preview" src="" alt="Previsualización de la foto" class="max-w-full h-32 object-contain rounded-lg border border-gray-300 w-full">
                            <button type="button" id="edit-remove-photo-btn" class="mt-2 text-red-500 hover:text-red-700 text-sm font-semibold"><i class="fas fa-trash-alt mr-1"></i> Quitar Foto</button>
                        </div>
                    </div>
                    <!-- FIN CAMPO FOTO EDICIÓN (MODIFICADO) -->
                    <div>
                        <label for="edit-precio-efectivo" class="block text-sm font-medium text-gray-700">Precio Efectivo (ARS) *</label>
                        <input type="number" id="edit-precio-efectivo" name="precioEfectivo" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="edit-precio-lista" class="block text-sm font-medium text-gray-700">Precio de Lista (ARS) *</label>
                        <input type="number" id="edit-precio-lista" name="precioLista" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="edit-talle" class="block text-sm font-medium text-gray-700">Talle *</label>
                        <input type="text" id="edit-talle" name="talle" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tipo de Ropa *</label>
                        <div id="edit-tipo-ropa-container" class="mt-2 space-y-2">
                            <div class="flex items-center">
                                <input id="edit-tipo_importada" name="tipo_ropa" type="checkbox" value="Importada" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="edit-tipo_importada" class="ml-3 block text-sm text-gray-900">Importada</label>
                            </div>
                            <div class="flex items-center">
                                <input id="edit-tipo_nacional" name="tipo_ropa" type="checkbox" value="Nacional" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="edit-tipo_nacional" class="ml-3 block text-sm text-gray-900">Nacional</label>
                            </div>
                            <div class="flex items-center">
                                <input id="edit-tipo_nuevo" name="tipo_ropa" type="checkbox" value="Nuevo" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="edit-tipo_nuevo" class="ml-3 block text-sm text-gray-900">Nuevo</label>
                            </div>
                        </div>
                        <button type="button" id="add-edit-custom-tipo" class="mt-2 bg-blue-500 text-white font-semibold py-1 px-2 rounded-lg shadow-md hover:bg-blue-600 transition"><i class="fas fa-plus mr-1"></i> Añadir tipo personalizado</button>
                    </div>
                    <div>
                        <label for="edit-vendedora" class="block text-sm font-medium text-gray-700">Vendedora (Opcional)</label>
                        <input type="text" id="edit-vendedora" name="vendedora" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="edit-descripcion" class="block text-sm font-medium text-gray-700">Descripción (Opcional)</label>
                        <textarea id="edit-descripcion" name="descripcion" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Guardar Cambios</button>
                </form>
            </div>
        </section>
        <!-- Sección de Escaneo -->
        <section id="scanner-section" class="hidden">
            <button class="back-to-menu text-indigo-600 mb-4 font-semibold"><i class="fas fa-arrow-left mr-2"></i> Volver al menú</button>
            <div class="bg-white p-4 rounded-xl shadow-lg">
                <div id="reader" class="w-full rounded-lg overflow-hidden"></div>
            </div>
            <div id="scan-result" class="mt-6"></div>
        </section>
        <!-- Sección de Historial -->
        <section id="history-section" class="hidden">
            <button class="back-to-menu text-indigo-600 mb-4 font-semibold"><i class="fas fa-arrow-left mr-2"></i> Volver al menú</button>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Historial de QR</h2>
                <div class="mb-4">
                    <input type="text" id="search-bar" placeholder="Buscar por ID, Talle, Tipo, Cliente o Vendedora..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex justify-between mb-4">
                    <p id="stock-count" class="text-lg font-semibold text-gray-800">Stock actual: 0</p>
                    <p id="sold-sum" class="text-lg font-semibold text-red-700">Vendidos: $0</p>
                    <p id="speculation-sum" class="text-lg font-semibold text-green-700">Especulación: $0</p>
                </div>
                <div class="flex justify-between mb-4">
                    <button id="export-excel-btn" class="py-2 px-4 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition"><i class="fas fa-file-excel mr-2"></i>Exportar a Excel</button>
                    <button id="export-csv-btn" class="py-2 px-4 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition"><i class="fas fa-file-csv mr-2"></i>Exportar a CSV (para Google Sheets)</button>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">No Vendidos</h3>
                <div id="not-sold-list" class="space-y-4 mb-6"></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Vendidos</h3>
                <div id="sold-list" class="space-y-4"></div>
            </div>
        </section>
        <!-- Sección para Re-mostrar/Gestionar QR desde Historial (CON TÍTULO EXPLICITO) -->
        <section id="re-qr-section" class="hidden">
            <button class="back-to-history text-indigo-600 mb-4 font-semibold"><i class="fas fa-arrow-left mr-2"></i> Volver al historial</button>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Detalle y Gestión de QR</h2>
            <div id="re-qr-display" class="mt-6 bg-white p-6 rounded-xl shadow-lg text-center">
                <!-- El QR, la foto y las opciones se renderizarán aquí -->
            </div>
        </section>
        <!-- Sección de Métricas -->
        <section id="metrics-section" class="hidden">
            <button class="back-to-menu text-indigo-600 mb-4 font-semibold"><i class="fas fa-arrow-left mr-2"></i> Volver al menú</button>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Métricas de Stock</h2>
                <canvas id="stock-chart" width="400" height="200"></canvas>
                <div id="calendar-metrics" class="mt-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Almanaque de Actividades</h3>
                    <div class="grid grid-cols-7 gap-2 text-center">
                        <div class="font-bold">Dom</div>
                        <div class="font-bold">Lun</div>
                        <div class="font-bold">Mar</div>
                        <div class="font-bold">Mié</div>
                        <div class="font-bold">Jue</div>
                        <div class="font-bold">Vie</div>
                        <div class="font-bold">Sáb</div>
                    </div>
                    <div id="calendar-days" class="grid grid-cols-7 gap-2 mt-2 text-center"></div>
                </div>
            </div>
        </section>
        <!-- Notificaciones -->
        <div id="app-message" class="fixed bottom-4 right-4 z-50"></div>
    </div>
    <!-- Modal de Análisis de Estrategia -->
    <div id="strategy-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6">
            <h3 id="modal-title" class="text-2xl font-bold text-indigo-600 mb-4"></h3>
            <div id="modal-content" class="space-y-3 text-gray-700 text-left"></div>
            <button id="close-modal-btn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition">Cerrar</button>
        </div>
    </div>
   
    <!-- Modal de Venta Manual (REINTEGRADO) -->
    <div id="manual-sale-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 relative">
            <button id="close-manual-sale-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h3 class="text-2xl font-bold text-red-600 mb-4">Venta Manual de Prenda</h3>
            <p class="text-gray-700 mb-4">Selecciona el motivo del problema de escaneo:</p>
            <form id="manual-sale-form" class="space-y-3">
                <div class="space-y-2">
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-red-50 cursor-pointer transition">
                        <input type="radio" name="scan-reason" value="Cámara rota" class="form-radio text-red-600 h-5 w-5">
                        <span class="ml-3 text-gray-700 font-medium">Cámara rota</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-red-50 cursor-pointer transition">
                        <input type="radio" name="scan-reason" value="QR dañado" class="form-radio text-red-600 h-5 w-5">
                        <span class="ml-3 text-gray-700 font-medium">QR dañado</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-red-50 cursor-pointer transition">
                        <input type="radio" name="scan-reason" value="Falta de tiempo" class="form-radio text-red-600 h-5 w-5">
                        <span class="ml-3 text-gray-700 font-medium">Falta de tiempo</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-red-50 cursor-pointer transition">
                        <input type="radio" name="scan-reason" value="Problemas de red" class="form-radio text-red-600 h-5 w-5">
                        <span class="ml-3 text-gray-700 font-medium">Problemas de red</span>
                    </label>
                    <label id="otro-radio-label" class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-red-50 cursor-pointer transition">
                        <input type="radio" name="scan-reason" value="Otro" class="form-radio text-red-600 h-5 w-5">
                        <span class="ml-3 text-gray-700 font-medium">Otro (aclarar el motivo)</span>
                    </label>
                </div>
                <div id="reason-other-container" class="hidden mt-3 pt-2 border-t border-gray-200">
                    <input type="text" id="reason-other-input" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500" placeholder="Escribe el motivo aquí">
                </div>
               
                <button type="submit" class="w-full mt-4 bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                    Confirmar Venta
                </button>
            </form>
        </div>
    </div>
    <!-- Modal de Instalación PWA (NUEVO) -->
    <div id="install-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 relative">
            <button id="close-install-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h3 class="text-2xl font-bold text-blue-600 mb-4 text-center">Instalar Aplicación</h3>
            <div class="space-y-4 text-gray-700">
                <p>¡Lleva el **Gestor de QR** a tu pantalla de inicio para un acceso rápido y sin interrupciones! Funciona como una aplicación nativa.</p>
               
                <h4 class="font-semibold text-gray-800 flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i> Beneficios:</h4>
                <ul class="list-disc list-inside ml-4 text-sm space-y-1">
                    <li>Acceso directo sin navegador.</li>
                    <li>Funcionamiento sin conexión.</li>
                    <li>Experiencia de pantalla completa.</li>
                </ul>
                <p class="text-sm text-center pt-2 border-t border-gray-100">Presiona el botón de abajo para instalarla en tu dispositivo.</p>
            </div>
            <button id="install-btn-in-modal" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition flex items-center justify-center">
                <i class="fas fa-download mr-2"></i> Agregar a Pantalla Principal
            </button>
            <p id="install-tip" class="mt-4 text-xs text-center text-gray-500 hidden">
                <i class="fas fa-info-circle mr-1"></i> Si el botón no funciona, usa el menú del navegador ("Agregar a pantalla de inicio").
            </p>
        </div>
    </div>
    <script>
        // --- CONSTANTE DE CONTRASEÑA ACTUALIZADA ---
        const DELETE_PASSWORD = "1440"; // Contraseña actualizada de 505 a 1440
        // --- VARIABLES GLOBALES ---
        let prendas = [];
        let html5QrCode;
        let deferredPrompt;
        let editingId = null;
        let customTipoCount = 0;
        let isPushEnabled = false;
        let currentPhotoBase64 = null;
        let isAudioPlaying = false; // Estado para el botón TTS
        let selectedManualSaleId = null; // ID de la prenda para venta manual
        // --- REFERENCIAS AL MODAL DE ESTRATEGIA ---
        const strategyModal = document.getElementById('strategy-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal-btn');
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', () => {
                if (strategyModal) strategyModal.classList.add('hidden');
            });
        }
        // --- REFERENCIAS AL MODAL DE VENTA MANUAL ---
        const manualSaleModal = document.getElementById('manual-sale-modal');
        const closeManualSaleModalBtn = document.getElementById('close-manual-sale-modal');
        const manualSaleForm = document.getElementById('manual-sale-form');
        const reasonOtherContainer = document.getElementById('reason-other-container');
        const reasonOtherInput = document.getElementById('reason-other-input');
        // --- REFERENCIAS AL MODAL DE INSTALACIÓN PWA (NUEVO) ---
        const installModal = document.getElementById('install-modal');
        const installModalBtn = document.getElementById('install-app-modal-btn');
        const closeInstallModalBtn = document.getElementById('close-install-modal-btn');
        const installBtnInModal = document.getElementById('install-btn-in-modal');
        const installTip = document.getElementById('install-tip');
        // --- FUNCIONES DE MODAL ---
        function showModal(title, content) {
            if (modalTitle) modalTitle.textContent = title;
            if (modalContent) modalContent.innerHTML = content;
            if (strategyModal) strategyModal.classList.remove('hidden');
        }
        
        // --- FUNCIONES DE MODAL DE INSTALACIÓN PWA (NUEVO) ---
        function showInstallModal() {
            if (installModal) installModal.classList.remove('hidden');
            // Muestra el tip si no hay deferredPrompt, indicando que debe usar el menú del navegador
            if (!deferredPrompt && installTip) installTip.classList.remove('hidden');
            else if (installTip) installTip.classList.add('hidden');
        }
        function hideInstallModal() {
            if (installModal) installModal.classList.add('hidden');
        }
        // Add listeners for the new buttons
        if (installModalBtn) {
            installModalBtn.addEventListener('click', showInstallModal);
        }
        if (closeInstallModalBtn) {
            closeInstallModalBtn.addEventListener('click', hideInstallModal);
        }
        // --- FUNCIONES DE VENTA MANUAL (REINTEGRADAS) ---
        function showManualSaleModal(prendaId) {
            selectedManualSaleId = prendaId;
            manualSaleModal.classList.remove('hidden');
            manualSaleForm.reset();
            reasonOtherContainer.classList.add('hidden');
            reasonOtherInput.value = '';
        }
        function hideManualSaleModal() {
            manualSaleModal.classList.add('hidden');
            selectedManualSaleId = null;
        }
        function processManualSale(reason) {
            if (!selectedManualSaleId) {
                showAppMessage("Error: No se ha seleccionado una prenda para la venta manual.", 'error');
                return;
            }
            const prenda = prendas.find(p => p.id === selectedManualSaleId);
            if (!prenda) {
                showAppMessage("Error: Prenda no encontrada en el historial.", 'error');
                return;
            }
            // Marcar como vendido y guardar el motivo
            prenda.ultimo_escaneo = new Date().toISOString();
            prenda.manual_sale_reason = reason;
            // Calcular días transcurridos hasta la venta
            const diasTranscurridos = Math.floor((new Date(prenda.ultimo_escaneo) - new Date(prenda.fecha_creacion)) / (1000 * 60 * 60 * 24));
            prenda.dias_transcurridos = diasTranscurridos;
            prenda.vendido = true; // Nuevo campo para sincronización
            savePrendasToStorage();
            setupHistoryDisplay(); // Refrescar el historial
            hideManualSaleModal();
            showAppMessage(`Venta manual de la prenda ${selectedManualSaleId.substring(0, 8)}... registrada por: ${reason}.`, 'success');
        }
        // Listener para cerrar el modal de venta manual
        if (closeManualSaleModalBtn) {
            closeManualSaleModalBtn.addEventListener('click', hideManualSaleModal);
        }
        // Listener para mostrar/ocultar campo "Otro"
        if (manualSaleForm) {
            manualSaleForm.addEventListener('change', (e) => {
                const selectedRadio = manualSaleForm.querySelector('input[name="scan-reason"]:checked');
                if (selectedRadio && selectedRadio.value === 'Otro') {
                    reasonOtherContainer.classList.remove('hidden');
                } else {
                    reasonOtherContainer.classList.add('hidden');
                }
            });
           
            // Listener para procesar la venta manual
            manualSaleForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const selectedRadio = manualSaleForm.querySelector('input[name="scan-reason"]:checked');
                let reason = '';
                if (!selectedRadio) {
                    showAppMessage('Por favor, selecciona un motivo.', 'error');
                    return;
                }
                if (selectedRadio.value === 'Otro') {
                    reason = reasonOtherInput.value.trim();
                    if (reason === '') {
                        showAppMessage('Por favor, aclara el motivo en el campo de texto.', 'error');
                        return;
                    }
                } else {
                    reason = selectedRadio.value;
                }
               
                processManualSale(reason);
            });
        }
       
        // --- FUNCIÓN UTILITARIA PARA CONVERTIR ARCHIVO A BASE64 ---
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
       
        // --- MANEJO DE IMAGENES (REFACTORIZADO) ---
        function setupImageHandlers(isEdit = false) {
            const prefix = isEdit ? 'edit-' : '';
           
            // Referencias a los nuevos inputs y botones
            const cameraInput = document.getElementById(`${prefix}camera-photo-input`);
            const importInput = document.getElementById(`${prefix}import-photo-input`);
            const cameraBtn = document.getElementById(`${prefix}open-camera-btn`);
            const importBtn = document.getElementById(`${prefix}import-file-btn`);
           
            // Referencias a la previsualización y eliminación
            const photoPreview = document.getElementById(`${prefix}photo-preview`);
            const photoPreviewContainer = document.getElementById(`${prefix}photo-preview-container`);
            const removePhotoBtn = document.getElementById(`${prefix}remove-photo-btn`);
            // Validación de existencia de elementos (esencial para que los listeners no fallen)
            if (!cameraInput || !importInput || !removePhotoBtn || !cameraBtn || !importBtn) return;
            // 1. Lógica para manejar el cambio de archivo (desde cualquiera de los dos inputs)
            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Limpiar el otro input para evitar confusión de estado
                    const otherInput = e.target === cameraInput ? importInput : cameraInput;
                    otherInput.value = '';
                   
                    try {
                        currentPhotoBase64 = await fileToBase64(file);
                        if (photoPreview) photoPreview.src = currentPhotoBase64;
                        if (photoPreviewContainer) photoPreviewContainer.classList.remove('hidden');
                        showAppMessage("Imagen cargada con éxito.", 'success');
                    } catch (error) {
                        console.error("Error al convertir a Base64:", error);
                        showAppMessage("Error al cargar la imagen.", 'error');
                        currentPhotoBase64 = null;
                        if (photoPreviewContainer) photoPreviewContainer.classList.add('hidden');
                    }
                }
            };
           
            // 2. Adjuntar listeners de click a los botones
            cameraBtn.onclick = () => cameraInput.click();
            importBtn.onclick = () => importInput.click();
            // 3. Adjuntar listeners de cambio de archivo a los inputs
            cameraInput.onchange = handleFileChange;
            importInput.onchange = handleFileChange;
            // 4. Lógica del botón de eliminar
            removePhotoBtn.onclick = () => {
                currentPhotoBase64 = null;
                cameraInput.value = '';
                importInput.value = '';
                if (photoPreview) photoPreview.src = '';
                if (photoPreviewContainer) photoPreviewContainer.classList.add('hidden');
            };
        }
        // --- INICIALIZACIÓN ---
        function initializeApp() {
            loadPrendasFromStorage();
            setupHistoryDisplay();
            setupPwaInstall();
            requestNotificationPermission();
            setupImageHandlers(false); // Configurar para Generación
            setupImageHandlers(true); // Configurar para Edición
            showAppMessage("Aplicación lista (datos locales).", 'success');
            console.log("App inicializada con localStorage.");
        }
        // --- PWA INSTALACIÓN ---
        function setupPwaInstall() {
            if (!installModalBtn || !installBtnInModal) return; // Ensure elements exist
            // 1. Mostrar el botón de la app si el navegador lo permite
            // Lo mostramos por defecto, en el beforeinstallprompt se configura la acción
            installModalBtn.classList.remove('hidden');
           
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                console.log("Evento beforeinstallprompt disparado. PWA disponible para instalación.");
            });
            // 2. Manejar la instalación desde el botón DENTRO del modal
            installBtnInModal.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`Resultado de instalación: ${outcome}`);
                    deferredPrompt = null;
                    // Esconder el modal y el botón del modal después de un intento
                    hideInstallModal();
                    installModalBtn.classList.add('hidden');
                } else {
                    // Si el botón está visible pero el prompt no está capturado (caso raro o después de rechazo)
                    showAppMessage("Instalación fallida. Utiliza el menú del navegador.", 'error');
                }
            });
            // 3. Manejar la instalación ya completada (esconder el botón)
            window.addEventListener('appinstalled', () => {
                showAppMessage("¡Aplicación instalada con éxito! Reanudando en la versión instalada.", 'success');
                console.log("App instalada como PWA. Ocultando botón.");
                installModalBtn.classList.add('hidden');
                deferredPrompt = null;
            });
            // 4. Si la app ya está instalada o se ejecuta como PWA, ocultar el botón
            if (window.matchMedia('(display-mode: standalone)').matches ||
                navigator.standalone === true) {
                installModalBtn.classList.add('hidden');
                console.log("La aplicación ya se está ejecutando en modo PWA. Botón de instalación oculto.");
            }
        }
        // --- SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => {
                        console.log("Service Worker registrado:", reg);
                        initializePush(reg);
                    })
                    .catch(err => console.error("Error al registrar Service Worker:", err));
            });
        }
        // --- LOCALSTORAGE FUNCTIONS ---
        function loadPrendasFromStorage() {
            try {
                const stored = localStorage.getItem('qrPrendas');
                if (stored) {
                    prendas = JSON.parse(stored);
                    console.log(`Cargadas ${prendas.length} prendas desde localStorage.`);
                } else {
                    prendas = [];
                }
            } catch (error) {
                console.error("Error cargando localStorage:", error);
                showAppMessage("Error al cargar datos locales. Usando memoria temporal.", 'error');
                prendas = [];
            }
        }
        function savePrendasToStorage() {
            try {
                localStorage.setItem('qrPrendas', JSON.stringify(prendas));
                console.log(`Guardadas ${prendas.length} prendas en localStorage.`);
                syncToSharedStorage(); // Nueva función para sincronizar con la segunda app
            } catch (error) {
                console.error("Error guardando localStorage:", error);
                showAppMessage("Error al guardar datos. Se perderán al cerrar el navegador.", 'error');
            }
        }
        // Nueva función para sincronizar con el catálogo de la segunda app
        function syncToSharedStorage() {
            const sharedProducts = prendas.map(p => ({
                id: p.id,
                image: p.fotoBase64 || 'https://placehold.co/300x250?text=Producto',
                name: p.tipos_de_ropa.join(' / ') + ' - Talle ' + p.talle,
                cashPrice: p.precioEfectivo,
                listPrice: p.precioLista,
                description: p.descripcion || 'Sin descripción',
                ultimo_escaneo: p.ultimo_escaneo, // Para filtrar no vendidos
                vendido: p.vendido || false
            }));
            localStorage.setItem('sharedProducts', JSON.stringify(sharedProducts));
            console.log('Sincronizado con sharedProducts para el catálogo.');
        }
        // --- MANEJO DEL DOM Y NAVEGACIÓN ---
        const mainMenu = document.getElementById('main-menu');
        const generationSection = document.getElementById('generation-section');
        const editSection = document.getElementById('edit-section');
        const scannerSection = document.getElementById('scanner-section');
        const historySection = document.getElementById('history-section');
        const metricsSection = document.getElementById('metrics-section');
        const reQrSection = document.getElementById('re-qr-section');
        const qrForm = document.getElementById('qr-form');
        const editForm = document.getElementById('edit-form');
        const qrDisplay = document.getElementById('qr-display');
        const reQrDisplay = document.getElementById('re-qr-display');
        const scanResult = document.getElementById('scan-result');
        const notSoldList = document.getElementById('not-sold-list');
        const soldList = document.getElementById('sold-list');
        const stockCount = document.getElementById('stock-count');
        const soldSum = document.getElementById('sold-sum');
        const speculationSum = document.getElementById('speculation-sum');
        const searchBar = document.getElementById('search-bar');
        const generateDescBtn = document.getElementById('generate-desc-btn');
        const analyzeStockRiskBtn = document.getElementById('analyze-stock-risk-btn');
        const geminiOutputSection = document.getElementById('gemini-output-section');
        const geminiOutputTitle = document.getElementById('gemini-output-title');
        const geminiOutput = document.getElementById('gemini-output');
        const copyDescBtn = document.getElementById('copy-desc-btn');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const tipoRopaContainer = document.getElementById('tipo-ropa-container');
        const editTipoRopaContainer = document.getElementById('edit-tipo-ropa-container');
        const sections = [generationSection, editSection, scannerSection, historySection, metricsSection, reQrSection];
        function showView(viewId) {
            mainMenu.classList.add('hidden');
            sections.forEach(section => section.classList.add('hidden'));
            stopScanner();
            if (geminiOutputSection) geminiOutputSection.classList.add('hidden');
            if (strategyModal) strategyModal.classList.add('hidden');
            if (manualSaleModal) manualSaleModal.classList.add('hidden'); // Ocultar el modal de venta manual
            if (installModal) installModal.classList.add('hidden'); // Ocultar el modal de instalación
            if (viewId === 'main') {
                mainMenu.classList.remove('hidden');
            } else {
                const targetSection = document.getElementById(viewId);
                if (targetSection) targetSection.classList.remove('hidden');
            }
        }
        document.getElementById('show-generation-btn').addEventListener('click', () => {
            if (qrForm) qrForm.reset();
            if (qrDisplay) {
                qrDisplay.innerHTML = '';
                qrDisplay.classList.add('hidden');
            }
           
            // Resetear la foto y el preview al cambiar a la sección de generación (UPDATED)
            currentPhotoBase64 = null;
            const cameraInput = document.getElementById('camera-photo-input');
            const importInput = document.getElementById('import-photo-input');
            const photoPreviewContainer = document.getElementById('photo-preview-container');
            if (cameraInput) cameraInput.value = '';
            if (importInput) importInput.value = '';
            if (photoPreviewContainer) photoPreviewContainer.classList.add('hidden');
            if (geminiOutputSection) geminiOutputSection.classList.add('hidden');
            resetCustomTipos();
            showView('generation-section');
        });
        document.getElementById('show-scanner-btn').addEventListener('click', () => {
            if (scanResult) scanResult.innerHTML = '';
            showView('scanner-section');
            startScanner();
        });
        document.getElementById('show-history-btn').addEventListener('click', () => {
            setupHistoryDisplay();
            showView('history-section');
        });
        document.getElementById('show-metrics-btn').addEventListener('click', () => {
            setupMetricsChart();
            setupCalendarMetrics();
            showView('metrics-section');
        });
        document.querySelectorAll('.back-to-menu').forEach(btn => {
            btn.addEventListener('click', () => showView('main'));
        });
        document.querySelectorAll('.back-to-history').forEach(btn => {
            btn.addEventListener('click', () => {
                showView('history-section');
                resetEditCustomTipos();
            });
        });
       
        // --- LÓGICA DE ANÁLISIS ---
        async function analyzeTrend(prendaId) {
            const prenda = prendas.find(p => p.id === prendaId);
            if (!prenda) {
                showAppMessage("Prenda no encontrada para análisis de tendencia.", 'error');
                return;
            }
            showAppMessage("Buscando tendencias globales para el artículo...", 'info');
            showModal("Análisis de Tendencia de Mercado", `<p class="text-center"><i class="fas fa-spinner fa-spin mr-2"></i> Buscando en tiempo real...</p>`);
            const itemType = prenda.tipos_de_ropa.join(', ');
            const queries = [`Tendencia de moda actual en Argentina para ${itemType}. ¿Es popular?`, `fashion trends Argentina ${itemType}`];
           
            const systemPrompt = `Eres un experto en tendencias de moda y retail de Buenos Aires, Argentina. Tu tarea es analizar los datos de búsqueda recientes para determinar si el tipo de artículo es tendencia actual. Responde con un análisis conciso y claro (2-3 frases), indicando si el artículo es: 'Tendencia Alta', 'Tendencia Media' o 'Tendencia Baja', y justifica brevemente tu conclusión basada en la información de búsqueda. La respuesta debe ser solo el análisis en español.`;
            try {
                const apiKey = ""; // Canvas provides this
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
               
                const payload = {
                    contents: [{ parts: [{ text: queries[0] }] }],
                    tools: [{ "google_search": { queries: queries } }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
               
                if (!response.ok) {
                    throw new Error(`Error en la API de Gemini: ${response.status} - ${response.statusText}`);
                }
               
                const result = await response.json();
                const candidate = result.candidates?.[0];
                const generatedText = candidate?.content?.parts?.[0]?.text || "No se pudo generar el análisis de tendencia.";
                let sourcesHtml = '';
                const groundingMetadata = candidate?.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    const sources = groundingMetadata.groundingAttributions
                        .map(attr => `<a href="${attr.web?.uri}" target="_blank" class="text-xs text-indigo-500 hover:underline">${attr.web?.title || 'Fuente sin título'}</a>`)
                        .join('<br>');
                    sourcesHtml = `<div class="mt-4 pt-3 border-t border-gray-100 text-left"><h5 class="text-sm font-semibold text-gray-600 mb-1">Fuentes:</h5>${sources}</div>`;
                }
                const htmlContent = `
                    <p class="font-bold">Análisis para Tipo de Prenda: ${itemType}</p>
                    <p>${generatedText}</p>
                    ${sourcesHtml}
                `;
               
                showModal("Análisis de Tendencia de Mercado", htmlContent);
                showAppMessage("Análisis de tendencia generado.", 'success');
            } catch (error) {
                console.error("Error al llamar a Gemini API para análisis de tendencia:", error);
                showModal("Error de Análisis de Tendencia", `<p>No se pudo completar el análisis de IA. Por favor, revise su conexión o reintente.</p><p class="text-sm text-red-500">${error.message}</p>`);
            }
        }
        async function analyzeStrategy(prendaId) {
            const prenda = prendas.find(p => p.id === prendaId);
            if (!prenda) {
                showAppMessage("Prenda no encontrada para análisis.", 'error');
                return;
            }
            const díasSinEscanear = Math.floor((new Date() - new Date(prenda.fecha_creacion)) / (1000 * 60 * 60 * 24));
           
            showAppMessage("Analizando estrategia con IA...", 'info');
            showModal("Análisis de Estrategia de Stock", `<p class="text-center"><i class="fas fa-spinner fa-spin mr-2"></i> Generando recomendación...</p>`);
            const prompt = `
                Actúa como un analista de inventario y estratega de precios para una pequeña boutique de moda en Argentina.
                Analiza los siguientes datos de un artículo y proporciona una recomendación clara y accionable.
                El análisis debe constar de dos secciones, tituladas "### Análisis de Situación" y "### Recomendación de Estrategia", cada una con un párrafo corto y conciso.
                Utiliza el idioma español de Argentina.
                Datos del Artículo:
                - Estado: En Stock (No Vendido)
                - Precio Efectivo: $${prenda.precioEfectivo} ARS
                - Precio de Lista: $${prenda.precioLista} ARS
                - Talle: ${prenda.talle}
                - Tipo: ${prenda.tipos_de_ropa.join(', ')}
                - Descripción: ${prenda.descripcion || 'Sin descripción detallada'}
                - Días en Stock (Sin Escanear/Vender): ${díasSinEscanear} días.
            `;
            try {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                };
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`Error en la API de Gemini: ${response.status} - ${response.statusText}`);
                }
                const result = await response.json();
                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar el análisis. Intente de nuevo.";
               
                // Convertir Markdown a HTML básico para el modal
                const htmlContent = generatedText.split('\n').map(line => {
                    if (line.startsWith('### ')) return `<h4 class="font-semibold text-gray-900 mt-4">${line.substring(4)}</h4>`;
                    if (line.trim() === '') return '';
                    return `<p>${line}</p>`;
                }).join('');
               
                showModal("Análisis de Estrategia de Stock para " + (prenda.tipos_de_ropa.join(' / ') || 'Prenda'), htmlContent);
                showAppMessage("Estrategia generada.", 'success');
            } catch (error) {
                console.error("Error al llamar a Gemini API para análisis:", error);
                showModal("Error de Análisis", `<p>No se pudo completar el análisis de IA. Por favor, revise su conexión o reintente.</p><p class="text-sm text-red-500">${error.message}</p>`);
            }
        }
       
        // --- LÓGICA DE GENERACIÓN DE DESCRIPCIÓN INTELIGENTE (EXISTENTE) ---
        if (generateDescBtn) {
            generateDescBtn.addEventListener('click', async () => {
                const precioEfectivo = document.getElementById('precio-efectivo')?.value;
                const precioLista = document.getElementById('precio-lista')?.value;
                const talle = document.getElementById('talle')?.value;
                const descripcion = document.getElementById('descripcion')?.value;
                const tiposDeRopa = Array.from(document.querySelectorAll('input[name="tipo_ropa"]:checked')).map(cb => cb.value || cb.nextElementSibling?.value || '');
                if (!precioEfectivo || !precioLista || !talle || tiposDeRopa.length === 0) {
                    showAppMessage("Completa Precio Efectivo, Precio de Lista, Talle y Tipo de Ropa para generar la descripción.", 'error');
                    return;
                }
                generateDescBtn.disabled = true;
                generateDescBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Generando...`;
                const prompt = `
                    Actúa como un experto en marketing de moda para redes sociales en Argentina.
                    Crea una descripción atractiva y corta (2-3 frases) para una prenda de ropa y una idea creativa para una publicación en Instagram (sin hashtags).
                    La respuesta debe estar en español de Argentina y usar formato Markdown con los títulos "### Descripción del Producto" y "### Idea para Red Social".
                    Detalles de la prenda:
                    - Tipo: ${tiposDeRopa.join(', ')}
                    - Talle: ${talle}
                    - Precio Efectivo: $${precioEfectivo} ARS
                    - Precio de Lista: $${precioLista} ARS
                    - Descripción: ${descripcion || 'Ninguna'}
                `;
                try {
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                    };
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error(`Error en la API de Gemini: ${response.status} - ${response.statusText}`);
                    }
                    const result = await response.json();
                    const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (generatedText) {
                        if (geminiOutputTitle) geminiOutputTitle.textContent = "Sugerencia de la IA";
                        geminiOutput.value = generatedText;
                        geminiOutputSection.classList.remove('hidden');
                        showAppMessage("Descripción generada con éxito.", 'success');
                    } else {
                        throw new Error("La respuesta de la API estaba vacía.");
                    }
                } catch (error) {
                    console.error("Error al llamar a Gemini API:", error);
                    showAppMessage(`Error al generar descripción: ${error.message}`, 'error');
                } finally {
                    generateDescBtn.disabled = false;
                    generateDescBtn.innerHTML = `Generar Descripción Inteligente`;
                }
            });
        }
       
        // --- LÓGICA: ANÁLISIS DE RIESGO DE STOCK (GEMINI API) ---
        if (analyzeStockRiskBtn) {
            analyzeStockRiskBtn.addEventListener('click', async () => {
                const talle = document.getElementById('talle')?.value;
                const tiposDeRopa = Array.from(document.querySelectorAll('input[name="tipo_ropa"]:checked')).map(cb => cb.value || cb.nextElementSibling?.value || '');
                if (!talle || tiposDeRopa.length === 0) {
                    showAppMessage("Completa Talle y Tipo de Ropa para analizar el riesgo.", 'error');
                    return;
                }
                analyzeStockRiskBtn.disabled = true;
                analyzeStockRiskBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Analizando...`;
               
                // 1. Calculate Local Statistics
                let totalOfSameType = 0;
                let soldOfSameType = 0;
               
                // Find items that share at least one primary type AND the same size
                const targetTypes = tiposDeRopa.map(t => t.toLowerCase().trim());
                const targetTalle = talle.toLowerCase().trim();
                prendas.forEach(p => {
                    const pTalle = (p.talle || '').toLowerCase().trim();
                    const pTypes = (p.tipos_de_ropa || []).map(t => t.toLowerCase().trim());
                   
                    // Check if item matches size AND any of the selected types
                    const typeMatch = pTypes.some(pType => targetTypes.includes(pType));
                   
                    if (typeMatch && pTalle === targetTalle) {
                        totalOfSameType++;
                        if (p.ultimo_escaneo) {
                            soldOfSameType++;
                        }
                    }
                });
                const inStockOfSameType = totalOfSameType - soldOfSameType;
               
                const localStats = `
                    Estadísticas locales para artículos de tipo "${tiposDeRopa.join(' / ')}" en talle "${talle}":
                    - Total de unidades registradas (vendidas + en stock): ${totalOfSameType}
                    - Unidades vendidas (escaneadas): ${soldOfSameType}
                    - Unidades actualmente en stock (no vendidas): ${inStockOfSameType}
                `;
               
                const prompt = `
                    Actúa como un analista de riesgo de inventario experto en moda.
                    Basado en la siguiente información, genera un análisis de riesgo de stock para este tipo de artículo.
                    El resumen debe ser de 2 a 3 frases y debe concluir con una calificación de riesgo: "Riesgo BAJO", "Riesgo MEDIO" o "Riesgo ALTO".
                    Justifica tu calificación de riesgo basándote en la proporción de stock vs. vendido. Si el total es 0, indica que no hay datos para analizar.
                   
                    ${localStats}
                `;
                try {
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                    };
                   
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                   
                    if (!response.ok) {
                        throw new Error(`Error en la API de Gemini: ${response.status} - ${response.statusText}`);
                    }
                   
                    const result = await response.json();
                    const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar el análisis de riesgo. Intente de nuevo.";
                   
                    // Display result
                    if (geminiOutputTitle) geminiOutputTitle.textContent = "Resumen de Riesgo de Stock (IA)";
                    geminiOutput.value = generatedText;
                    geminiOutputSection.classList.remove('hidden');
                    showAppMessage("Análisis de riesgo generado.", 'success');
                } catch (error) {
                    console.error("Error al llamar a Gemini API para análisis de riesgo:", error);
                    if (geminiOutputTitle) geminiOutputTitle.textContent = "Resumen de Riesgo de Stock (IA)";
                    geminiOutput.value = `Error: ${error.message}. No se pudo contactar a la IA.`;
                    geminiOutputSection.classList.remove('hidden');
                    showAppMessage(`Error al generar análisis de riesgo: ${error.message}`, 'error');
                } finally {
                    analyzeStockRiskBtn.disabled = false;
                    analyzeStockRiskBtn.innerHTML = `Analizar Riesgo de Stock`;
                }
            });
        }
       
        if (copyDescBtn) {
            copyDescBtn.addEventListener('click', () => {
                geminiOutput.select();
                document.execCommand('copy');
                showAppMessage("Texto copiado al portapapeles.", 'success');
            });
        }
       
        // --- TTS UTILITIES ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; // Int16Array
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcm16.length * bytesPerSample;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);
            /* RIFF identifier */
            view.setUint32(0, 0x52494646, false); // 'RIFF'
            /* file length */
            view.setUint32(4, 36 + dataSize, true);
            /* RIFF type */
            view.setUint32(8, 0x57415645, false); // 'WAVE'
            /* format chunk identifier */
            view.setUint32(12, 0x666d7420, false); // 'fmt '
            /* format chunk length */
            view.setUint32(16, 16, true);
            /* sample format (raw) */
            view.setUint16(20, 1, true); // PCM = 1
            /* channel count */
            view.setUint16(22, numChannels, true);
            /* sample rate */
            view.setUint32(24, sampleRate, true);
            /* byte rate (sample rate * block align) */
            view.setUint32(28, byteRate, true);
            /* block align (channel count * bytes per sample) */
            view.setUint16(32, blockAlign, true);
            /* bits per sample */
            view.setUint16(34, 16, true); // 16 bits = 2 bytes
            /* data chunk identifier */
            view.setUint32(36, 0x64617461, false); // 'data'
            /* data chunk length */
            view.setUint32(40, dataSize, true);
            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }
            return new Blob([view], { type: 'audio/wav' });
        }
       
        async function textToSpeech(prendaId) {
            if (isAudioPlaying) {
                showAppMessage("Ya se está generando audio. Por favor, espere.", 'info');
                return;
            }
            const prenda = prendas.find(p => p.id === prendaId);
            const ttsButton = document.getElementById(`tts-btn-${prendaId}`);
            if (!prenda || !ttsButton) return;
            // 1. Preparar el texto
            const textToSay = `Atención. Prenda registrada: ${prenda.tipos_de_ropa.join(', ')}. Talle: ${prenda.talle}. Precio en efectivo: ${prenda.precioEfectivo} pesos argentinos. Precio de lista: ${prenda.precioLista} pesos. Descripción adicional: ${prenda.descripcion || 'No se proporcionó descripción'}.`;
            isAudioPlaying = true;
            ttsButton.disabled = true;
            ttsButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Generando Audio...`;
            showAppMessage("Generando audio de los detalles...", 'info');
           
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
           
            const payload = {
                contents: [{ parts: [{ text: textToSay }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" } // Voz Kore para tono firme
                        }
                    },
                },
            };
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`Error en la API de TTS: ${response.status} - ${response.statusText}`);
                }
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;
                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                   
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                   
                    const audio = new Audio(audioUrl);
                    audio.play();
                    audio.onended = () => {
                        isAudioPlaying = false;
                        ttsButton.disabled = false;
                        ttsButton.innerHTML = `<i class="fas fa-volume-up mr-2"></i> Escuchar Detalles`;
                        URL.revokeObjectURL(audioUrl);
                        showAppMessage("Reproducción finalizada.", 'success');
                    };
                    showAppMessage("Reproduciendo detalles...", 'success');
                } else {
                    throw new Error("Respuesta de audio no válida o formato incorrecto.");
                }
            } catch (error) {
                console.error("Error al generar TTS:", error);
                showAppMessage(`Error de audio: ${error.message}`, 'error');
                isAudioPlaying = false;
                ttsButton.disabled = false;
                ttsButton.innerHTML = `<i class="fas fa-volume-up mr-2"></i> Error de Audio`;
            }
        }
        // --- FIN TTS UTILITIES ---
        // --- LÓGICA DE GENERACIÓN DE QR (ACTUALIZADA PARA INCLUIR IMAGEN Y BOTÓN TTS) ---
        if (qrForm) {
            qrForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(qrForm);
                const tiposDeRopa = Array.from(document.querySelectorAll('input[name="tipo_ropa"]:checked')).map(cb => cb.value || cb.nextElementSibling?.value || '');
                if (tiposDeRopa.length === 0) {
                    showAppMessage("Debes seleccionar al menos un tipo de ropa.", "error");
                    return;
                }
                const prendaId = crypto.randomUUID();
                const prendaData = {
                    id: prendaId,
                    precioEfectivo: formData.get('precioEfectivo'),
                    precioLista: formData.get('precioLista'),
                    talle: formData.get('talle'),
                    tipos_de_ropa: tiposDeRopa,
                    vendedora: formData.get('vendedora') || '',
                    descripcion: formData.get('descripcion') || '',
                    fecha_creacion: new Date().toISOString(),
                    ultimo_escaneo: null,
                    dias_transcurridos: 0,
                    fotoBase64: currentPhotoBase64,
                    manual_sale_reason: null, // Inicializa la razón de venta manual
                    vendido: false // Nuevo campo para sincronización
                };
                try {
                    console.log("[Registro] Guardando prenda con ID:", prendaId);
                    prendas.push(prendaData);
                    savePrendasToStorage();
                    console.log("[Registro] Prenda guardada en localStorage.");
                    showAppMessage("Prenda guardada localmente con éxito.", 'success');
                    generateQrCode(prendaId, qrDisplay); // Usamos qrDisplay para la sección de Generación
                    sendPushNotification("Nueva prenda registrada", `Se ha generado un QR con ID: ${prendaId}`);
                    qrForm.reset();
                    resetCustomTipos();
                   
                    // Limpiar estado de foto después de guardar
                    currentPhotoBase64 = null;
                    const cameraInput = document.getElementById('camera-photo-input');
                    const importInput = document.getElementById('import-photo-input');
                    const photoPreviewContainer = document.getElementById('photo-preview-container');
                    if (cameraInput) cameraInput.value = '';
                    if (importInput) importInput.value = '';
                    if (photoPreviewContainer) photoPreviewContainer.classList.add('hidden');
                    if (geminiOutputSection) geminiOutputSection.classList.add('hidden');
                } catch (error) {
                    console.error("[Registro] Error al guardar        } catch (error) {
            console.error("[Registro] Error al guardar el registro:", error);
            
            // Mostrar mensaje de error al usuario
            mostrarMensaje(
                `Error al guardar el registro: ${error.message || error}`, 
                "error"
            );

            // Reactivar el botón de guardar
            const saveBtn = document.getElementById('save-registry-btn');
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Guardar Registro';
            }

            // Si hubo error con la foto, mantenerla visible para reintentar
            if (currentPhotoBase64) {
                const preview = document.getElementById('photo-preview');
                const img = document.getElementById('preview-img');
                if (preview && img) {
                    preview.classList.remove('hidden');
                    img.src = currentPhotoBase64;
                }
            }
        } finally {
            // Ocultar spinner de carga siempre
            const spinner = document.getElementById('loading-spinner');
            if (spinner) spinner.classList.add('hidden');
        }
    });

    // ═══════════════════════════════════════════════════════════
    // 13. FUNCIONES AUXILIARES
    // ═══════════════════════════════════════════════════════════

    function mostrarMensaje(mensaje, tipo = "success") {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const toastIcon = document.getElementById('toast-icon');

        if (!toast || !toastMessage || !toastIcon) return;

        // Limpiar clases anteriores
        toast.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500');
        
        // Configurar según tipo
        switch (tipo) {
            case "success":
                toast.classList.add('bg-green-500');
                toastIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
                break;
            case "error":
                toast.classList.add('bg-red-500');
                toastIcon.innerHTML = '<i class="fas fa-times-circle"></i>';
                break;
            case "warning":
                toast.classList.add('bg-yellow-500');
                toastIcon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                break;
        }

        toastMessage.textContent = mensaje;
        toast.classList.remove('hidden');
        
        // Auto-ocultar después de 5 segundos
        setTimeout(() => {
            toast.classList.add('hidden');
        }, 5000);
    }

    // Cerrar toast manualmente
    const closeToast = document.getElementById('close-toast');
    if (closeToast) {
        closeToast.addEventListener('click', () => {
            document.getElementById('toast').classList.add('hidden');
        });
    }

    // Limpiar formulario completo
    function limpiarFormulario() {
        document.getElementById('registry-form').reset();
        
        // Limpiar selects personalizados
        document.querySelectorAll('.select-selected').forEach(el => {
            el.textContent = el.dataset.placeholder || "Seleccionar...";
        });

        // Limpiar foto
        currentPhotoBase64 = null;
        const preview = document.getElementById('photo-preview-container');
        if (preview) preview.classList.add('hidden');

        // Ocultar secciones de resultado
        if (geminiOutputSection) geminiOutputSection.classList.add('hidden');
        if (photoPreviewContainer) photoPreviewContainer.classList.add('hidden');
    }

    // Botón limpiar formulario
    const clearBtn = document.getElementById('clear-form-btn');
    if (clearBtn) {
        clearBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm("¿Estás seguro de que quieres limpiar todo el formulario?")) {
                limpiarFormulario();
                mostrarMensaje("Formulario limpiado correctamente", "success");
            }
        });
    }

    // ═══════════════════════════════════════════════════════════
    // 14. INICIALIZACIÓN FINAL
    // ═══════════════════════════════════════════════════════════

    // Mostrar fecha y hora actual
    actualizarFechaHora();

    // Actualizar cada minuto
    setInterval(actualizarFechaHora, 60000);

    // Cargar datos iniciales
    cargarDatosIniciales();

    console.log("%c[Registro] Script cargado completamente ✓", "color: #10b981; font-weight: bold;");
});
