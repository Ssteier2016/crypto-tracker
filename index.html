<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de QR para Indumentaria</title>
    <meta name="theme-color" content="#4f46e5">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icono.png">
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- 1. FIREBASE LIBRARIES (NECESARIAS PARA FIRESTORE) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div id="app-container" class="max-w-2xl mx-auto p-4 md:p-6">
        <header class="text-center mb-8 flex items-center justify-center">
            <!-- LOGO: Added logo.png next to the title -->
            <img src="logo.png" alt="Logo de la aplicación" class="w-8 h-8 mr-3 rounded-md" 
                onerror="this.onerror=null; this.src='https://placehold.co/32x32/4f46e5/ffffff?text=G&font=sans'">
            <h1 class="text-4xl font-bold text-indigo-600 mr-2">Gestor de QR</h1>
            <!-- VERSION: Updated to v.3.1 (Full Firestore Integration) -->
            <span class="text-xs font-normal text-gray-600">v.3.1 (Firebase Firestore)</span>
        </header>
        <!-- Menú Principal -->
        <main id="main-menu" class="space-y-4">
            <!-- NUEVO BOTÓN DE INSTALACIÓN PWA -->
            <button id="install-app-modal-btn" class="w-full bg-blue-500 text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:bg-blue-600 transition duration-300 flex items-center justify-center text-lg hidden">
                <i class="fas fa-mobile-alt mr-3"></i> Descargar Aplicación
            </button>
            <button id="show-generation-btn" class="w-full bg-indigo-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition duration-300 flex items-center justify-center text-lg">
                <i class="fas fa-plus-circle mr-3"></i> Generar QR
            </button>
            <button id="show-scanner-btn" class="w-full bg-purple-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:bg-purple-700 transition duration-300 flex items-center justify-center text-lg">
                <i class="fas fa-qrcode mr-3"></i> Escanear QR
            </button>
            <button id="show-history-btn" class="w-full bg-gray-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:bg-gray-800 transition duration-300 flex items-center justify-center text-lg">
                <i class="fas fa-history mr-3"></i> Historial de QR
            </button>
            <button id="show-metrics-btn" class="w-full bg-teal-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:bg-teal-700 transition duration-300 flex items-center justify-center text-lg">
                <i class="fas fa-chart-line mr-3"></i> Métricas
            </button>
        </main>
        <!-- Sección de Generación -->
        <section id="generation-section" class="hidden">
            <button class="back-to-menu text-indigo-600 mb-4 font-semibold"><i class="fas fa-arrow-left mr-2"></i> Volver al menú</button>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Registrar Prenda</h2>
                <form id="qr-form" class="space-y-4">
                    <!-- CAMPO DE FOTO/CÁMARA/IMPORTAR (MODIFICADO) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Foto de la Prenda (Opcional)</label>
                        <div class="flex space-x-3">
                            <!-- Input para la CÁMARA (Fuerza la apertura de la cámara si es compatible) -->
                            <input type="file" id="camera-photo-input" name="cameraPhoto" accept="image/*" capture="environment" class="hidden">
                            <button type="button" id="open-camera-btn" class="flex-1 bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-600 transition flex items-center justify-center text-sm">
                                <i class="fas fa-camera mr-2"></i> Usar Cámara
                            </button>

                            <!-- Input para IMPORTAR ARCHIVO (Abre el selector de archivos) -->
                            <input type="file" id="import-photo-input" name="importPhoto" accept="image/*" class="hidden">
                            <button type="button" id="import-file-btn" class="flex-1 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 transition flex items-center justify-center text-sm">
                                <i class="fas fa-file-upload mr-2"></i> Importar Foto
                            </button>
                        </div>
                        <div id="photo-preview-container" class="mt-4 hidden">
                            <p class="text-xs text-gray-500 mb-1">Previsualización:</p>
                            <img id="photo-preview" src="" alt="Previsualización de la foto" class="max-w-full h-32 object-contain rounded-lg border border-gray-300 w-full">
                            <button type="button" id="remove-photo-btn" class="mt-2 text-red-500 hover:text-red-700 text-sm font-semibold"><i class="fas fa-trash-alt mr-1"></i> Quitar Foto</button>
                        </div>
                    </div>
                    <!-- FIN CAMPO FOTO (MODIFICADO) -->
                    <div>
                        <label for="precio-efectivo" class="block text-sm font-medium text-gray-700">Precio Efectivo (ARS) *</label>
                        <input type="number" id="precio-efectivo" name="precioEfectivo" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="precio-lista" class="block text-sm font-medium text-gray-700">Precio de Lista (ARS) *</label>
                        <input type="number" id="precio-lista" name="precioLista" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="talle" class="block text-sm font-medium text-gray-700">Talle *</label>
                        <input type="text" id="talle" name="talle" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tipo de Ropa *</label>
                        <div id="tipo-ropa-container" class="mt-2 space-y-2">
                            <div class="flex items-center">
                                <input id="tipo_importada" name="tipo_ropa" type="checkbox" value="Importada" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="tipo_importada" class="ml-3 block text-sm text-gray-900">Importada</label>
                            </div>
                            <div class="flex items-center">
                                <input id="tipo_nacional" name="tipo_ropa" type="checkbox" value="Nacional" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="tipo_nacional" class="ml-3 block text-sm text-gray-900">Nacional</label>
                            </div>
                            <div class="flex items-center">
                                <input id="tipo_nuevo" name="tipo_ropa" type="checkbox" value="Nuevo" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="tipo_nuevo" class="ml-3 block text-sm text-gray-900">Nuevo</label>
                            </div>
                        </div>
                        <button type="button" id="add-custom-tipo" class="mt-2 bg-blue-500 text-white font-semibold py-1 px-2 rounded-lg shadow-md hover:bg-blue-600 transition"><i class="fas fa-plus mr-1"></i> Añadir tipo personalizado</button>
                    </div>
                    <div>
                        <label for="vendedora" class="block text-sm font-medium text-gray-700">Vendedora (Opcional)</label>
                        <input type="text" id="vendedora" name="vendedora" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripción (Opcional)</label>
                        <textarea id="descripcion" name="descripcion" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                    <div class="pt-2 border-t border-gray-200 space-y-3">
                        <button type="button" id="generate-desc-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-purple-700 transition duration-300 flex items-center justify-center">
                            ✨ Generar Descripción Inteligente
                        </button>
                        <!-- BOTÓN PARA ANÁLISIS DE RIESGO DE STOCK -->
                        <button type="button" id="analyze-stock-risk-btn" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-orange-600 transition duration-300 flex items-center justify-center">
                            ✨ Analizar Riesgo de Stock
                        </button>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Generar QR y Guardar</button>
                </form>
            </div>
            <div id="gemini-output-section" class="hidden mt-6 bg-purple-50 p-6 rounded-xl shadow-inner">
                <h3 class="text-xl font-bold text-purple-800 mb-3" id="gemini-output-title">Sugerencia de la IA</h3>
                <textarea id="gemini-output" readonly class="w-full h-40 p-2 border border-purple-200 rounded-md bg-white resize-none"></textarea>
                <button id="copy-desc-btn" class="mt-2 py-2 px-4 bg-purple-500 text-white font-semibold rounded-lg shadow-md hover:bg-purple-600 transition"><i class="fas fa-copy mr-2"></i>Copiar Texto</button>
            </div>
            <div id="qr-display" class="hidden mt-6 bg-white p-6 rounded-xl shadow-lg text-center"></div>
        </section>
        <!-- Sección de Edición -->
        <section id="edit-section" class="hidden">
            <button class="back-to-history text-indigo-600 mb-4 font-semibold"><i class="fas fa-arrow-left mr-2"></i> Volver al historial</button>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Editar Prenda</h2>
                <form id="edit-form" class="space-y-4">
                    <input type="hidden" id="edit-id" name="id">
                    <!-- CAMPO DE FOTO/CÁMARA/IMPORTAR EDICIÓN (MODIFICADO) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Foto de la Prenda (Opcional)</label>
                        <div class="flex space-x-3">
                            <!-- Input para la CÁMARA (Fuerza la apertura de la cámara si es compatible) -->
                            <input type="file" id="edit-camera-photo-input" name="editCameraPhoto" accept="image/*" capture="environment" class="hidden">
                            <button type="button" id="edit-open-camera-btn" class="flex-1 bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-600 transition flex items-center justify-center text-sm">
                                <i class="fas fa-camera mr-2"></i> Usar Cámara
                            </button>

                            <!-- Input para IMPORTAR ARCHIVO (Abre el selector de archivos) -->
                            <input type="file" id="edit-import-photo-input" name="editImportPhoto" accept="image/*" class="hidden">
                            <button type="button" id="edit-import-file-btn" class="flex-1 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 transition flex items-center justify-center text-sm">
                                <i class="fas fa-file-upload mr-2"></i> Importar Foto
                            </button>
                        </div>
                        <div id="edit-photo-preview-container" class="mt-4 hidden">
                            <p class="text-xs text-gray-500 mb-1">Previsualización Actual:</p>
                            <img id="edit-photo-preview" src="" alt="Previsualización de la foto" class="max-w-full h-32 object-contain rounded-lg border border-gray-300 w-full">
                            <button type="button" id="edit-remove-photo-btn" class="mt-2 text-red-500 hover:text-red-700 text-sm font-semibold"><i class="fas fa-trash-alt mr-1"></i> Quitar Foto</button>
                        </div>
                    </div>
                    <!-- FIN CAMPO FOTO EDICIÓN (MODIFICADO) -->
                    <div>
                        <label for="edit-precio-efectivo" class="block text-sm font-medium text-gray-700">Precio Efectivo (ARS) *</label>
                        <input type="number" id="edit-precio-efectivo" name="precioEfectivo" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="edit-precio-lista" class="block text-sm font-medium text-gray-700">Precio de Lista (ARS) *</label>
                        <input type="number" id="edit-precio-lista" name="precioLista" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="edit-talle" class="block text-sm font-medium text-gray-700">Talle *</label>
                        <input type="text" id="edit-talle" name="talle" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tipo de Ropa *</label>
                        <div id="edit-tipo-ropa-container" class="mt-2 space-y-2">
                            <div class="flex items-center">
                                <input id="edit-tipo_importada" name="tipo_ropa" type="checkbox" value="Importada" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="edit-tipo_importada" class="ml-3 block text-sm text-gray-900">Importada</label>
                            </div>
                            <div class="flex items-center">
                                <input id="edit-tipo_nacional" name="tipo_ropa" type="checkbox" value="Nacional" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="edit-tipo_nacional" class="ml-3 block text-sm text-gray-900">Nacional</label>
                            </div>
                            <div class="flex items-center">
                                <input id="edit-tipo_nuevo" name="tipo_ropa" type="checkbox" value="Nuevo" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="edit-tipo_nuevo" class="ml-3 block text-sm text-gray-900">Nuevo</label>
                            </div>
                        </div>
                        <button type="button" id="add-edit-custom-tipo" class="mt-2 bg-blue-500 text-white font-semibold py-1 px-2 rounded-lg shadow-md hover:bg-blue-600 transition"><i class="fas fa-plus mr-1"></i> Añadir tipo personalizado</button>
                    </div>
                    <div>
                        <label for="edit-vendedora" class="block text-sm font-medium text-gray-700">Vendedora (Opcional)</label>
                        <input type="text" id="edit-vendedora" name="vendedora" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="edit-descripcion" class="block text-sm font-medium text-gray-700">Descripción (Opcional)</label>
                        <textarea id="edit-descripcion" name="descripcion" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Guardar Cambios</button>
                </form>
            </div>
        </section>
        <!-- Sección de Escaneo -->
        <section id="scanner-section" class="hidden">
            <button class="back-to-menu text-indigo-600 mb-4 font-semibold"><i class="fas fa-arrow-left mr-2"></i> Volver al menú</button>
            <div class="bg-white p-4 rounded-xl shadow-lg">
                <div id="reader" class="w-full rounded-lg overflow-hidden"></div>
            </div>
            <div id="scan-result" class="mt-6"></div>
        </section>
        <!-- Sección de Historial -->
        <section id="history-section" class="hidden">
            <button class="back-to-menu text-indigo-600 mb-4 font-semibold"><i class="fas fa-arrow-left mr-2"></i> Volver al menú</button>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Historial de QR</h2>
                <div class="mb-4">
                    <input type="text" id="search-bar" placeholder="Buscar por ID, Talle, Tipo, Cliente o Vendedora..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex justify-between mb-4">
                    <p id="stock-count" class="text-lg font-semibold text-gray-800">Stock actual: 0</p>
                    <p id="sold-sum" class="text-lg font-semibold text-red-700">Vendidos: $0</p>
                    <p id="speculation-sum" class="text-lg font-semibold text-green-700">Especulación: $0</p>
                </div>
                <div class="flex justify-between mb-4">
                    <button id="export-excel-btn" class="py-2 px-4 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition"><i class="fas fa-file-excel mr-2"></i>Exportar a Excel</button>
                    <button id="export-csv-btn" class="py-2 px-4 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition"><i class="fas fa-file-csv mr-2"></i>Exportar a CSV (para Google Sheets)</button>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">No Vendidos</h3>
                <div id="not-sold-list" class="space-y-4 mb-6"></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Vendidos</h3>
                <div id="sold-list" class="space-y-4"></div>
            </div>
        </section>
        <!-- Sección para Re-mostrar/Gestionar QR desde Historial (CON TÍTULO EXPLICITO) -->
        <section id="re-qr-section" class="hidden">
            <button class="back-to-history text-indigo-600 mb-4 font-semibold"><i class="fas fa-arrow-left mr-2"></i> Volver al historial</button>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Detalle y Gestión de QR</h2>
            <div id="re-qr-display" class="mt-6 bg-white p-6 rounded-xl shadow-lg text-center">
                <!-- El QR, la foto y las opciones se renderizarán aquí -->
            </div>
        </section>
        <!-- Sección de Métricas -->
        <section id="metrics-section" class="hidden">
            <button class="back-to-menu text-indigo-600 mb-4 font-semibold"><i class="fas fa-arrow-left mr-2"></i> Volver al menú</button>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Métricas de Stock</h2>
                <canvas id="stock-chart" width="400" height="200"></canvas>
                <div id="calendar-metrics" class="mt-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Almanaque de Actividades</h3>
                    <div class="grid grid-cols-7 gap-2 text-center">
                        <div class="font-bold">Dom</div>
                        <div class="font-bold">Lun</div>
                        <div class="font-bold">Mar</div>
                        <div class="font-bold">Mié</div>
                        <div class="font-bold">Jue</div>
                        <div class="font-bold">Vie</div>
                        <div class="font-bold">Sáb</div>
                    </div>
                    <div id="calendar-days" class="grid grid-cols-7 gap-2 mt-2 text-center"></div>
                </div>
            </div>
        </section>
        <!-- Notificaciones -->
        <div id="app-message" class="fixed bottom-4 right-4 z-50"></div>
    </div>

    <!-- Modal de Análisis de Estrategia -->
    <div id="strategy-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6">
            <h3 id="modal-title" class="text-2xl font-bold text-indigo-600 mb-4"></h3>
            <div id="modal-content" class="space-y-3 text-gray-700 text-left"></div>
            <button id="close-modal-btn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition">Cerrar</button>
        </div>
    </div>
    
    <!-- Modal de Venta Manual (REINTEGRADO) -->
    <div id="manual-sale-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 relative">
            <button id="close-manual-sale-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h3 class="text-2xl font-bold text-red-600 mb-4">Venta Manual de Prenda</h3>
            <p class="text-gray-700 mb-4">Selecciona el motivo del problema de escaneo:</p>

            <form id="manual-sale-form" class="space-y-3">
                <div class="space-y-2">
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-red-50 cursor-pointer transition">
                        <input type="radio" name="scan-reason" value="Cámara rota" class="form-radio text-red-600 h-5 w-5">
                        <span class="ml-3 text-gray-700 font-medium">Cámara rota</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-red-50 cursor-pointer transition">
                        <input type="radio" name="scan-reason" value="QR dañado" class="form-radio text-red-600 h-5 w-5">
                        <span class="ml-3 text-gray-700 font-medium">QR dañado</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-red-50 cursor-pointer transition">
                        <input type="radio" name="scan-reason" value="Falta de tiempo" class="form-radio text-red-600 h-5 w-5">
                        <span class="ml-3 text-gray-700 font-medium">Falta de tiempo</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-red-50 cursor-pointer transition">
                        <input type="radio" name="scan-reason" value="Problemas de red" class="form-radio text-red-600 h-5 w-5">
                        <span class="ml-3 text-gray-700 font-medium">Problemas de red</span>
                    </label>
                    <label id="otro-radio-label" class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-red-50 cursor-pointer transition">
                        <input type="radio" name="scan-reason" value="Otro" class="form-radio text-red-600 h-5 w-5">
                        <span class="ml-3 text-gray-700 font-medium">Otro (aclarar el motivo)</span>
                    </label>
                </div>

                <div id="reason-other-container" class="hidden mt-3 pt-2 border-t border-gray-200">
                    <input type="text" id="reason-other-input" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500" placeholder="Escribe el motivo aquí">
                </div>
                
                <button type="submit" class="w-full mt-4 bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                    Confirmar Venta
                </button>
            </form>
        </div>
    </div>

    <!-- Modal de Instalación PWA (NUEVO) -->
    <div id="install-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 relative">
            <button id="close-install-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h3 class="text-2xl font-bold text-blue-600 mb-4 text-center">Instalar Aplicación</h3>
            <div class="space-y-4 text-gray-700">
                <p>¡Lleva el **Gestor de QR** a tu pantalla de inicio para un acceso rápido y sin interrupciones! Funciona como una aplicación nativa.</p>
                
                <h4 class="font-semibold text-gray-800 flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i> Beneficios:</h4>
                <ul class="list-disc list-inside ml-4 text-sm space-y-1">
                    <li>Acceso directo sin navegador.</li>
                    <li>Funcionamiento sin conexión.</li>
                    <li>Experiencia de pantalla completa.</li>
                </ul>

                <p class="text-sm text-center pt-2 border-t border-gray-100">Presiona el botón de abajo para instalarla en tu dispositivo.</p>
            </div>
            <button id="install-btn-in-modal" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition flex items-center justify-center">
                <i class="fas fa-download mr-2"></i> Agregar a Pantalla Principal
            </button>
            <p id="install-tip" class="mt-4 text-xs text-center text-gray-500 hidden">
                <i class="fas fa-info-circle mr-1"></i> Si el botón no funciona, usa el menú del navegador ("Agregar a pantalla de inicio").
            </p>
        </div>
    </div>
    <script>
        // --- CONSTANTE DE CONTRASEÑA ACTUALIZADA ---
        const DELETE_PASSWORD = "1440"; 

        // ----------------------------------------------------
        // --- FIREBASE CONFIGURATION (INTEGRATED) ---
        // Tus credenciales de Firebase han sido insertadas aquí para la sincronización en la nube.
        const firebaseConfig = {
            apiKey: "AIzaSyBIGUo2-YFCHKF6Nc8I-lB_NmGZiQ5pHJI",
            authDomain: "cryptotracker-8a6fd.firebaseapp.com",
            projectId: "cryptotracker-8a6fd",
            storageBucket: "cryptotracker-8a6fd.firebasestorage.app",
            messagingSenderId: "720112375781",
            appId: "1:720112375781:web:671a4ee88c6f5830ea810c",
            measurementId: "G-ESKLZRK9P0"
        };
        // ----------------------------------------------------
        
        // 2. INITIALIZE FIREBASE AND FIRESTORE
        let db;
        try {
            // Inicializa Firebase con la configuración proporcionada por el usuario
            const app = firebase.initializeApp(firebaseConfig);
            // Obtiene la instancia de Firestore
            db = firebase.firestore();
            // Habilita la persistencia offline (crucial para apps móviles y PWA)
            db.enablePersistence().catch((err) => {
                if (err.code === 'failed-precondition') {
                    console.log("Persistence failed: multiple tabs open or persistence already enabled.");
                } else if (err.code === 'unimplemented') {
                    console.log("Persistence not available on this browser.");
                }
            });
            console.log("Firebase y Firestore inicializados.");
        } catch (error) {
            console.error("Error al inicializar Firebase. Se usará localStorage:", error);
            // db permanecerá undefined si la inicialización falla, lo que activa el fallback.
            showAppMessage("Error al conectar con la base de datos de la nube. Usando datos locales.", 'error');
        }
        
        const PRENDAS_COLLECTION = 'prendas'; // Nombre de tu colección en Firestore

        // --- VARIABLES GLOBALES ---
        let prendas = [];
        let html5QrCode;
        let deferredPrompt;
        let editingId = null;
        let customTipoCount = 0;
        let isPushEnabled = false;
        let currentPhotoBase64 = null;
        let isAudioPlaying = false; 
        let selectedManualSaleId = null; 
        let stockChartInstance = null; // Para guardar la instancia de Chart.js

        // --- REFERENCIAS AL DOM (Asegúrate de que todas existan) ---
        const mainMenu = document.getElementById('main-menu');
        const generationSection = document.getElementById('generation-section');
        const editSection = document.getElementById('edit-section');
        const scannerSection = document.getElementById('scanner-section');
        const historySection = document.getElementById('history-section');
        const metricsSection = document.getElementById('metrics-section');
        const reQrSection = document.getElementById('re-qr-section');
        const strategyModal = document.getElementById('strategy-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const manualSaleModal = document.getElementById('manual-sale-modal');
        const closeManualSaleModalBtn = document.getElementById('close-manual-sale-modal');
        const manualSaleForm = document.getElementById('manual-sale-form');
        const reasonOtherContainer = document.getElementById('reason-other-container');
        const reasonOtherInput = document.getElementById('reason-other-input');
        const installModal = document.getElementById('install-modal');
        const installModalBtn = document.getElementById('install-app-modal-btn');
        const closeInstallModalBtn = document.getElementById('close-install-modal-btn');
        const installBtnInModal = document.getElementById('install-btn-in-modal');
        const installTip = document.getElementById('install-tip');
        const qrForm = document.getElementById('qr-form');
        const editForm = document.getElementById('edit-form');
        const qrDisplay = document.getElementById('qr-display');
        const reQrDisplay = document.getElementById('re-qr-display');
        const scanResult = document.getElementById('scan-result');
        const notSoldList = document.getElementById('not-sold-list');
        const soldList = document.getElementById('sold-list');
        const stockCount = document.getElementById('stock-count');
        const soldSum = document.getElementById('sold-sum');
        const speculationSum = document.getElementById('speculation-sum');
        const searchBar = document.getElementById('search-bar');
        const generateDescBtn = document.getElementById('generate-desc-btn');
        const analyzeStockRiskBtn = document.getElementById('analyze-stock-risk-btn');
        const geminiOutputSection = document.getElementById('gemini-output-section');
        const geminiOutputTitle = document.getElementById('gemini-output-title');
        const geminiOutput = document.getElementById('gemini-output');
        const copyDescBtn = document.getElementById('copy-desc-btn');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const tipoRopaContainer = document.getElementById('tipo-ropa-container');
        const editTipoRopaContainer = document.getElementById('edit-tipo-ropa-container');
        const sections = [generationSection, editSection, scannerSection, historySection, metricsSection, reQrSection];
        
        // --- FUNCIONES DE MODAL ---
        function showModal(title, content) {
            if (modalTitle) modalTitle.textContent = title;
            if (modalContent) modalContent.innerHTML = content;
            if (strategyModal) strategyModal.classList.remove('hidden');
        }
          
        function showInstallModal() {
            if (installModal) installModal.classList.remove('hidden');
            if (!deferredPrompt && installTip) installTip.classList.remove('hidden');
            else if (installTip) installTip.classList.add('hidden');
        }

        function hideInstallModal() {
            if (installModal) installModal.classList.add('hidden');
        }

        // Add listeners for the new buttons
        if (installModalBtn) {
            installModalBtn.addEventListener('click', showInstallModal);
        }
        if (closeInstallModalBtn) {
            closeInstallModalBtn.addEventListener('click', hideInstallModal);
        }

        // --- FUNCIONES DE VENTA MANUAL ---
        function showManualSaleModal(prendaId) {
            selectedManualSaleId = prendaId;
            manualSaleModal.classList.remove('hidden');
            manualSaleForm.reset();
            reasonOtherContainer.classList.add('hidden');
            reasonOtherInput.value = '';
        }

        function hideManualSaleModal() {
            manualSaleModal.classList.add('hidden');
            selectedManualSaleId = null;
        }

        async function processManualSale(reason) { 
            if (!selectedManualSaleId) {
                showAppMessage("Error: No se ha seleccionado una prenda para la venta manual.", 'error');
                return;
            }

            const prenda = prendas.find(p => p.id === selectedManualSaleId);
            if (!prenda) {
                showAppMessage("Error: Prenda no encontrada en el historial.", 'error');
                return;
            }

            // Marcar como vendido y guardar el motivo
            prenda.ultimo_escaneo = new Date().toISOString();
            prenda.manual_sale_reason = reason;

            // Calcular días transcurridos hasta la venta
            const diasTranscurridos = Math.floor((new Date(prenda.ultimo_escaneo) - new Date(prenda.fecha_creacion)) / (1000 * 60 * 60 * 24));
            prenda.dias_transcurridos = diasTranscurridos;
            prenda.vendido = true; 

            await savePrendaToFirestore(prenda); // AWAIT: Guarda la prenda modificada en Firestore
            // onSnapshot se encargará de refrescar la UI
            hideManualSaleModal();
            showAppMessage(`Venta manual de la prenda ${selectedManualSaleId.substring(0, 8)}... registrada por: ${reason}.`, 'success');
        }

        // Listener para cerrar el modal de venta manual
        if (closeManualSaleModalBtn) {
            closeManualSaleModalBtn.addEventListener('click', hideManualSaleModal);
        }

        // Listener para mostrar/ocultar campo "Otro"
        if (manualSaleForm) {
            manualSaleForm.addEventListener('change', (e) => {
                const selectedRadio = manualSaleForm.querySelector('input[name="scan-reason"]:checked');
                if (selectedRadio && selectedRadio.value === 'Otro') {
                    reasonOtherContainer.classList.remove('hidden');
                } else {
                    reasonOtherContainer.classList.add('hidden');
                }
            });
            
            // Listener para procesar la venta manual
            manualSaleForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const selectedRadio = manualSaleForm.querySelector('input[name="scan-reason"]:checked');
                let reason = '';

                if (!selectedRadio) {
                    showAppMessage('Por favor, selecciona un motivo.', 'error');
                    return;
                }

                if (selectedRadio.value === 'Otro') {
                    reason = reasonOtherInput.value.trim();
                    if (reason === '') {
                        showAppMessage('Por favor, aclara el motivo en el campo de texto.', 'error');
                        return;
                    }
                } else {
                    reason = selectedRadio.value;
                }
                
                processManualSale(reason);
            });
        }
        
        // --- FUNCIÓN UTILITARIA PARA CONVERTIR ARCHIVO A BASE64 ---
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        // --- MANEJO DE IMAGENES ---
        function setupImageHandlers(isEdit = false) {
            const prefix = isEdit ? 'edit-' : '';
            const cameraInput = document.getElementById(`${prefix}camera-photo-input`);
            const importInput = document.getElementById(`${prefix}import-photo-input`);
            const cameraBtn = document.getElementById(`${prefix}open-camera-btn`);
            const importBtn = document.getElementById(`${prefix}import-file-btn`);
            const photoPreview = document.getElementById(`${prefix}photo-preview`);
            const photoPreviewContainer = document.getElementById(`${prefix}photo-preview-container`);
            const removePhotoBtn = document.getElementById(`${prefix}remove-photo-btn`);

            if (!cameraInput || !importInput || !removePhotoBtn || !cameraBtn || !importBtn) return;

            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const otherInput = e.target === cameraInput ? importInput : cameraInput;
                    otherInput.value = '';
                    
                    try {
                        currentPhotoBase64 = await fileToBase64(file);
                        if (photoPreview) photoPreview.src = currentPhotoBase64;
                        if (photoPreviewContainer) photoPreviewContainer.classList.remove('hidden');
                        showAppMessage("Imagen cargada con éxito.", 'success');
                    } catch (error) {
                        console.error("Error al convertir a Base64:", error);
                        showAppMessage("Error al cargar la imagen.", 'error');
                        currentPhotoBase64 = null;
                        if (photoPreviewContainer) photoPreviewContainer.classList.add('hidden');
                    }
                }
            };
            
            cameraBtn.onclick = () => cameraInput.click();
            importBtn.onclick = () => importInput.click();
            cameraInput.onchange = handleFileChange;
            importInput.onchange = handleFileChange;

            removePhotoBtn.onclick = () => {
                currentPhotoBase64 = null;
                cameraInput.value = '';
                importInput.value = '';
                if (photoPreview) photoPreview.src = '';
                if (photoPreviewContainer) photoPreviewContainer.classList.add('hidden');
            };
        }


        // --- INICIALIZACIÓN ---
        async function initializeApp() { 
            loadPrendas(); 
            setupPwaInstall();
            requestNotificationPermission();
            setupImageHandlers(false); // Configurar para Generación
            setupImageHandlers(true); // Configurar para Edición
            console.log("App inicializada. Fuente de datos: " + (db ? "Firestore (Real-time)" : "localStorage (Fallback)"));
        }

        // --- PWA INSTALACIÓN ---
        function setupPwaInstall() {
            if (!installModalBtn || !installBtnInModal) return; 

            installModalBtn.classList.remove('hidden');
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                console.log("Evento beforeinstallprompt disparado. PWA disponible para instalación.");
            });

            installBtnInModal.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`Resultado de instalación: ${outcome}`);
                    deferredPrompt = null;
                    hideInstallModal();
                    installModalBtn.classList.add('hidden'); 
                } else {
                    showAppMessage("Instalación fallida. Utiliza el menú del navegador.", 'error');
                }
            });

            window.addEventListener('appinstalled', () => {
                showAppMessage("¡Aplicación instalada con éxito! Reanudando en la versión instalada.", 'success');
                installModalBtn.classList.add('hidden');
                deferredPrompt = null;
            });

            if (window.matchMedia('(display-mode: standalone)').matches || 
                navigator.standalone === true) {
                installModalBtn.classList.add('hidden');
            }
        }

        // --- FIREBASE / LOCALSTORAGE FUNCTIONS ---

        function loadPrendas() {
            if (db) {
                // Usa Firestore en tiempo real con onSnapshot
                try {
                    // Ordenamos por fecha de creación para consistencia
                    db.collection(PRENDAS_COLLECTION).onSnapshot(snapshot => {
                        prendas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log(`[Firestore] Recibidas ${prendas.length} prendas. (Actualización en tiempo real)`);
                        setupHistoryDisplay(); // Actualiza la UI
                        setupMetrics(); // Actualiza métricas
                        syncToLocalStorageFallback(); // Mantiene el localStorage actualizado como copia de seguridad
                    }, error => {
                        console.error("Error al escuchar Firestore. Cayendo a localStorage:", error);
                        loadFromLocalStorageFallback();
                    });
                    showAppMessage("Sincronización en tiempo real con Firebase iniciada.", 'success');
                } catch (error) {
                    console.error("Error iniciando onSnapshot:", error);
                    loadFromLocalStorageFallback();
                }
            } else {
                // Usa LocalStorage como fallback
                loadFromLocalStorageFallback();
                setupMetrics();
            }
        }
        
        // Carga desde localStorage si Firebase no está disponible
        function loadFromLocalStorageFallback() {
            try {
                const stored = localStorage.getItem('qrPrendas');
                if (stored) {
                    prendas = JSON.parse(stored);
                    console.log(`[LocalStorage] Cargadas ${prendas.length} prendas.`);
                } else {
                    prendas = [];
                }
                showAppMessage("Cargados datos desde memoria local (sin sincronización en la nube).", 'info');
                setupHistoryDisplay();
            } catch (error) {
                console.error("Error cargando localStorage:", error);
                prendas = [];
            }
        }

        // Mantiene el localStorage actualizado (copia de seguridad/cache)
        function syncToLocalStorageFallback() {
             try {
                localStorage.setItem('qrPrendas', JSON.stringify(prendas));
                localStorage.setItem('sharedProducts', JSON.stringify(prendas.filter(p => !p.vendido).map(p => ({
                    id: p.id,
                    image: p.fotoBase64 || 'https://placehold.co/300x250?text=Producto',
                    name: (p.tipos_de_ropa || []).join(' / ') + ' - Talle ' + p.talle,
                    cashPrice: p.precioEfectivo,
                    listPrice: p.precioLista,
                    description: p.descripcion || 'Sin descripción',
                }))));
            } catch (error) {
                console.error("Error sincronizando a localStorage:", error);
            }
        }

        // Guarda o actualiza una prenda en Firestore o localStorage
        async function savePrendaToFirestore(prenda) {
            if (db) {
                try {
                    if (prenda.id && prendas.some(p => p.id === prenda.id)) {
                        // Actualizar existente
                        const docRef = db.collection(PRENDAS_COLLECTION).doc(prenda.id);
                        await docRef.set(prenda, { merge: true }); 
                        console.log(`[Firestore] Prenda ${prenda.id} actualizada.`);
                    } else {
                        // Agregar nueva
                        const { id, ...data } = prenda; // Excluir el ID temporal si existe
                        const docRef = await db.collection(PRENDAS_COLLECTION).add(data);
                        prenda.id = docRef.id;
                        console.log(`[Firestore] Nueva prenda agregada con ID: ${prenda.id}`);
                    }
                    // onSnapshot actualizará el array local 'prendas' y la UI.
                    showAppMessage("Datos sincronizados con la nube.", 'success');
                } catch (error) {
                    console.error("Error guardando en Firestore. Revertiendo a localStorage:", error);
                    // Si falla Firestore, guardamos localmente (aunque la sincronización fallará)
                    saveToLocalStorageFallback(prenda); 
                }
            } else {
                // Fallback para guardar/actualizar en localStorage directamente
                saveToLocalStorageFallback(prenda);
            }
        }
        
        // Lógica de guardado en LocalStorage (usada en el fallback)
        function saveToLocalStorageFallback(prenda) {
            const index = prendas.findIndex(p => p.id === prenda.id);
            if (index > -1) {
                prendas[index] = prenda; // Actualiza
            } else {
                if (!prenda.id) prenda.id = generateID(); // Asegura un ID si es nuevo
                prendas.push(prenda); // Agrega
            }
            syncToLocalStorageFallback();
            setupHistoryDisplay(); // Refresca inmediatamente
            setupMetrics();
            showAppMessage("Guardados datos en memoria local (no sincronizado en la nube).", 'info');
        }

        async function deletePrendaFromFirestore(id) {
            if (db) {
                try {
                    await db.collection(PRENDAS_COLLECTION).doc(id).delete();
                    showAppMessage("Prenda eliminada de la nube.", 'success');
                } catch (error) {
                    console.error("Error eliminando de Firestore:", error);
                    showAppMessage("Error al eliminar la prenda de la nube.", 'error');
                }
            } else {
                // LocalStorage Fallback
                prendas = prendas.filter(p => p.id !== id);
                syncToLocalStorageFallback();
                setupHistoryDisplay();
                showAppMessage("Prenda eliminada localmente.", 'success');
            }
        }


        // --- UTILITIES ---

        function showAppMessage(message, type = 'info', duration = 3000) {
            const container = document.getElementById('app-message');
            const color = type === 'success' ? 'bg-green-500' : 
                          type === 'error' ? 'bg-red-500' : 
                          'bg-indigo-500';
            const html = `
                <div class="${color} text-white px-4 py-3 rounded-lg shadow-xl mb-2 transition-all duration-300" role="alert">
                    <p class="font-bold">${type === 'success' ? 'Éxito' : type === 'error' ? 'Error' : 'Info'}</p>
                    <p class="text-sm">${message}</p>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            const alert = container.lastElementChild;
            setTimeout(() => {
                alert.classList.add('opacity-0', 'translate-x-full');
                alert.addEventListener('transitionend', () => alert.remove());
            }, duration);
        }

        function generateID() {
            return 'P-' + Math.random().toString(36).substring(2, 9).toUpperCase();
        }

        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            try {
                const date = new Date(isoString);
                return date.toLocaleDateString('es-AR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return isoString; // Fallback
            }
        }
        
        function getTipoRopa(form) {
            const checkboxes = form.querySelectorAll('input[name="tipo_ropa"]:checked');
            // Mapea y filtra para obtener los valores correctos (maneja custom inputs)
            return Array.from(checkboxes).map(cb => {
                // Si el checkbox tiene un valor, úsalo (predefinidos)
                if (cb.value && cb.value !== 'on') return cb.value;
                // Si el checkbox es custom, busca el input de texto adyacente
                const parentDiv = cb.closest('.flex.items-center');
                const textInput = parentDiv ? parentDiv.querySelector('input[type="text"]') : null;
                return textInput ? textInput.value.trim() : '';
            }).filter(val => val); // Filtra los valores vacíos
        }


        // --- HISTORY DISPLAY ---

        function getFinancialSummary(data) {
            // El campo 'vendido' debe ser la fuente de verdad (true/false)
            let stock = data.filter(p => p.vendido !== true);
            let sold = data.filter(p => p.vendido === true);

            const totalStockValue = stock.reduce((sum, p) => sum + (parseFloat(p.precioEfectivo) || 0), 0);
            const totalSoldValue = sold.reduce((sum, p) => sum + (parseFloat(p.precioEfectivo) || 0), 0);
            const totalSpeculationValue = stock.reduce((sum, p) => sum + (parseFloat(p.precioLista) || 0), 0);

            return {
                stockCount: stock.length,
                totalStockValue: totalStockValue,
                totalSoldValue: totalSoldValue,
                totalSpeculationValue: totalSpeculationValue
            };
        }

        function setupHistoryDisplay() {
            if (searchBar) {
                searchBar.oninput = (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    renderHistoryList(searchTerm);
                };
            }
            renderHistoryList('');
        }
        
        function renderHistoryList(searchTerm) {
            if (!notSoldList || !soldList || !stockCount || !soldSum || !speculationSum) return;

            // 1. Filtrar los datos
            const filteredPrendas = prendas.filter(prenda => {
                const searchString = `${prenda.id} ${prenda.talle} ${prenda.tipos_de_ropa ? prenda.tipos_de_ropa.join(' ') : ''} ${prenda.vendedora || ''} ${prenda.manual_sale_reason || ''} ${prenda.descripcion || ''}`.toLowerCase();
                return searchString.includes(searchTerm);
            });

            // 2. Separar por estado
            const notSold = filteredPrendas.filter(p => p.vendido !== true).sort((a, b) => new Date(a.fecha_creacion) - new Date(b.fecha_creacion));
            const sold = filteredPrendas.filter(p => p.vendido === true).sort((a, b) => new Date(b.ultimo_escaneo) - new Date(a.ultimo_escaneo));

            // 3. Renderizar listas
            notSoldList.innerHTML = notSold.map(prenda => createPrendaCard(prenda, false)).join('');
            soldList.innerHTML = sold.map(prenda => createPrendaCard(prenda, true)).join('');

            // 4. Actualizar resumen financiero (usando el array completo si no hay búsqueda activa)
            const summaryData = getFinancialSummary(searchTerm ? filteredPrendas : prendas);
            stockCount.textContent = `Stock actual: ${summaryData.stockCount}`;
            soldSum.textContent = `Vendidos (Efectivo): $${summaryData.totalSoldValue.toLocaleString('es-AR')}`;
            speculationSum.textContent = `Lista (Stock): $${summaryData.totalSpeculationValue.toLocaleString('es-AR')}`;
            
            // 5. Re-attach listeners for dynamically created cards
            attachHistoryListeners(notSold);
            attachHistoryListeners(sold);
        }

        function createPrendaCard(prenda, isSold) {
            const types = prenda.tipos_de_ropa ? prenda.tipos_de_ropa.join(', ') : 'N/A';
            const daysInStock = isSold 
                ? prenda.dias_transcurridos || Math.floor((new Date(prenda.ultimo_escaneo) - new Date(prenda.fecha_creacion)) / (1000 * 60 * 60 * 24))
                : Math.floor((new Date() - new Date(prenda.fecha_creacion)) / (1000 * 60 * 60 * 24));
            
            const daysText = isSold 
                ? `<span class="text-sm font-semibold text-gray-600">Vendida en ${daysInStock} día${daysInStock !== 1 ? 's' : ''}.</span>`
                : `<span class="text-sm font-semibold ${daysInStock > 30 ? 'text-red-500' : 'text-gray-600'}">En stock hace ${daysInStock} día${daysInStock !== 1 ? 's' : ''}.</span>`;

            const photoHtml = prenda.fotoBase64 
                ? `<img src="${prenda.fotoBase64}" alt="Foto de la prenda ${prenda.id}" class="w-16 h-16 object-cover rounded-md mr-4 border border-gray-200">`
                : `<div class="w-16 h-16 bg-gray-200 rounded-md mr-4 flex items-center justify-center text-gray-500 text-xs"><i class="fas fa-camera text-xl"></i></div>`;

            const saleReasonHtml = isSold && prenda.manual_sale_reason 
                ? `<p class="text-xs text-red-500 mt-1"><i class="fas fa-exclamation-triangle mr-1"></i> Venta manual por: ${prenda.manual_sale_reason}</p>`
                : '';

            const buttonsHtml = isSold ? 
                `<button data-id="${prenda.id}" class="view-qr-btn text-xs text-indigo-600 hover:text-indigo-800 font-semibold"><i class="fas fa-eye mr-1"></i> Ver Detalle</button>` :
                `<button data-id="${prenda.id}" class="view-qr-btn text-xs text-indigo-600 hover:text-indigo-800 font-semibold mr-3"><i class="fas fa-qrcode mr-1"></i> Ver QR</button>
                 <button data-id="${prenda.id}" class="edit-btn text-xs text-teal-600 hover:text-teal-800 font-semibold mr-3"><i class="fas fa-edit mr-1"></i> Editar</button>
                 <button data-id="${prenda.id}" class="manual-sale-btn text-xs text-red-600 hover:text-red-800 font-semibold"><i class="fas fa-tag mr-1"></i> Venta Manual</button>`;
            // Nota: Se usa Venta Manual en lugar de Mark As Sold para consistencia con el modal.

            return `
                <div class="bg-gray-50 p-4 rounded-lg shadow-md flex items-center justify-between border-l-4 ${isSold ? 'border-red-500' : 'border-indigo-500'}">
                    <div class="flex items-start w-full">
                        ${photoHtml}
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-bold text-gray-800 truncate">ID: ${prenda.id.substring(0, 8)}...</p>
                            <p class="text-lg font-extrabold text-gray-900 leading-none">$${parseFloat(prenda.precioEfectivo).toLocaleString('es-AR')}</p>
                            <p class="text-sm text-gray-700 mt-1">Talle: <span class="font-bold">${prenda.talle}</span> | Tipo: ${types}</p>
                            ${daysText}
                            ${saleReasonHtml}
                            <p class="text-xs text-gray-500 mt-1">Reg: ${formatDate(prenda.fecha_creacion)}</p>
                        </div>
                    </div>
                    <div class="flex flex-col items-end space-y-2" data-prenda-id="${prenda.id}">
                        ${buttonsHtml}
                    </div>
                </div>
            `;
        }
        
        function attachHistoryListeners(list) {
            list.forEach(prenda => {
                const container = document.querySelector(`[data-prenda-id="${prenda.id}"]`);
                if (container) {
                    container.querySelector('.view-qr-btn')?.addEventListener('click', () => showReQRSection(prenda.id));
                    
                    // Solo adjuntar si existe el botón (No vendidos)
                    container.querySelector('.edit-btn')?.addEventListener('click', () => showEditSection(prenda.id));
                    container.querySelector('.manual-sale-btn')?.addEventListener('click', () => showManualSaleModal(prenda.id));
                }
            });
        }


        // --- MARK AS SOLD AND DELETE ---

        async function markAsSold(id) {
            const prenda = prendas.find(p => p.id === id);
            if (!prenda) {
                showAppMessage("Error: Prenda no encontrada.", 'error');
                return;
            }

            // Marcar como vendido y actualizar el estado
            prenda.vendido = true;
            prenda.ultimo_escaneo = new Date().toISOString();

            // Calcular días transcurridos hasta la venta
            const diasTranscurridos = Math.floor((new Date(prenda.ultimo_escaneo) - new Date(prenda.fecha_creacion)) / (1000 * 60 * 60 * 24));
            prenda.dias_transcurridos = diasTranscurridos;
            
            // Guardar cambios en Firestore/Local
            await savePrendaToFirestore(prenda);
            showAppMessage(`Prenda ID ${id.substring(0, 8)}... marcada como VENDIDA.`, 'success');
        }

        async function deletePrenda(id) {
            const password = prompt("Introduce la contraseña para ELIMINAR PERMANENTEMENTE esta prenda:");
            if (password === DELETE_PASSWORD) {
                await deletePrendaFromFirestore(id);
                document.getElementById('re-qr-section').classList.add('hidden');
                document.getElementById('history-section').classList.remove('hidden');
                showAppMessage("Prenda eliminada correctamente.", 'success');
            } else if (password !== null) {
                showAppMessage("Contraseña incorrecta. No se eliminó la prenda.", 'error');
            }
        }
        
        // --- SECTIONS VISIBILITY ---

        function showSection(sectionId) {
            document.querySelectorAll('section, main').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            // Detener el escáner si no estamos en la sección de escaneo
            if (sectionId !== 'scanner-section' && html5QrCode) {
                stopScanner();
            }
            // Ocultar modales
            if (strategyModal) strategyModal.classList.add('hidden');
            if (manualSaleModal) manualSaleModal.classList.add('hidden');
            if (installModal) installModal.classList.add('hidden');
        }

        // --- EDIT SECTION ---

        function showEditSection(id) {
            showSection('edit-section');
            editingId = id;
            const prenda = prendas.find(p => p.id === id);
            if (!prenda) return showAppMessage("Error al cargar prenda para edición.", 'error');

            document.getElementById('edit-id').value = prenda.id;
            document.getElementById('edit-precio-efectivo').value = prenda.precioEfectivo || '';
            document.getElementById('edit-precio-lista').value = prenda.precioLista || '';
            document.getElementById('edit-talle').value = prenda.talle || '';
            document.getElementById('edit-vendedora').value = prenda.vendedora || '';
            document.getElementById('edit-descripcion').value = prenda.descripcion || '';

            // Limpiar y re-generar checkboxes de tipo
            const container = document.getElementById('edit-tipo-ropa-container');
            container.innerHTML = ''; // Limpia el contenedor, luego re-agrega los predefinidos
            ['Importada', 'Nacional', 'Nuevo'].forEach(tipo => {
                appendTipoCheckbox(container, tipo, false, 'edit', false);
            });


            const existingTipos = ['Importada', 'Nacional', 'Nuevo'];
            const allTipos = Array.from(new Set([...existingTipos, ...(prenda.tipos_de_ropa || [])]));
            
            allTipos.forEach(tipo => {
                const isChecked = (prenda.tipos_de_ropa || []).includes(tipo);
                const isCustom = !existingTipos.includes(tipo);

                // Si es un tipo predefinido, simplemente lo marcamos
                if (!isCustom && isChecked) {
                    const checkbox = document.querySelector(`#edit-tipo-ropa-container input[type="checkbox"][value="${tipo}"]`);
                    if(checkbox) checkbox.checked = true;
                }
                // Si es un tipo custom, lo creamos y lo marcamos
                else if(isCustom) {
                    appendTipoCheckbox(container, tipo, isChecked, 'edit', true);
                }
            });
            
            // Reestablecer la foto
            currentPhotoBase64 = prenda.fotoBase64 || null;
            const previewImg = document.getElementById('edit-photo-preview');
            const previewContainer = document.getElementById('edit-photo-preview-container');
            
            if (currentPhotoBase64) {
                previewImg.src = currentPhotoBase64;
                previewContainer.classList.remove('hidden');
            } else {
                previewImg.src = '';
                previewContainer.classList.add('hidden');
            }
        }
        
        async function handleEditFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const id = document.getElementById('edit-id').value;
            let prenda = prendas.find(p => p.id === id);
            
            if (!prenda) return showAppMessage("Error interno: ID de prenda no encontrado.", 'error');

            const tiposDeRopa = getTipoRopa(form);
            
            prenda = {
                ...prenda, // Mantener campos existentes (fecha_creacion, vendido, etc.)
                precioEfectivo: form['edit-precio-efectivo'].value,
                precioLista: form['edit-precio-lista'].value,
                talle: form['edit-talle'].value,
                tipos_de_ropa: tiposDeRopa, // Usar el campo correcto (tipos_de_ropa)
                vendedora: form['edit-vendedora'].value,
                descripcion: form['edit-descripcion'].value,
                fotoBase64: currentPhotoBase64 // Usar la imagen global
            };

            await savePrendaToFirestore(prenda);
            showAppMessage("Prenda actualizada y sincronizada.", 'success');
            showSection('history-section');
            editingId = null;
        }

        // --- RE-QR SECTION ---

        function showReQRSection(id) {
            showSection('re-qr-section');
            const prenda = prendas.find(p => p.id === id);
            if (!prenda) return showAppMessage("Error al cargar detalle de prenda.", 'error');

            const reQrDisplay = document.getElementById('re-qr-display');
            if (!reQrDisplay) return;

            // 1. Generar la URL con el ID
            const qrData = prenda.id; // Almacenamos solo el ID
            
            // Usamos generateQrCode para renderizar los detalles
            generateQrCode(prenda.id, reQrDisplay); 
            
            // Adicional: Renderizar botones específicos de la sección de detalle
            const detailButtonsHtml = `
                <div class="flex flex-col space-y-3 mt-6 border-t pt-4">
                    <button onclick="window.print()" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-600 transition"><i class="fas fa-print mr-2"></i> Imprimir Etiqueta</button>
                    <button onclick="showEditSection('${prenda.id}')" class="w-full bg-teal-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-teal-600 transition"><i class="fas fa-edit mr-2"></i> Editar Prenda</button>
                    <button onclick="deletePrenda('${prenda.id}')" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-red-700 transition"><i class="fas fa-trash-alt mr-2"></i> Eliminar Prenda</button>
                </div>
            `;
            // Asegúrate de que el contenedor de QR/Info ya tiene la estructura base antes de insertar esto
            if(reQrDisplay.querySelector('.qr-action-btns')) {
                 reQrDisplay.querySelector('.qr-action-btns').insertAdjacentHTML('afterend', detailButtonsHtml);
            } else {
                 reQrDisplay.insertAdjacentHTML('beforeend', detailButtonsHtml);
            }
        }
        
        // --- SCANNER LOGIC ---

        function startScanner() {
            const qrboxFunction = (viewfinderWidth, viewfinderHeight) => {
                let minEdgePercentage = 0.7; // 70% del tamaño menor
                let minEdgeSize = Math.min(viewfinderWidth, viewfinderHeight);
                let qrboxSize = Math.floor(minEdgeSize * minEdgePercentage);
                return {
                    width: qrboxSize,
                    height: qrboxSize
                };
            };

            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: qrboxFunction
                },
                onScanSuccess,
                (errorMessage) => {
                    // console.log("QR Scan Error: " + errorMessage); // Silencioso
                }
            ).catch((err) => {
                showAppMessage("Error al iniciar la cámara. Puede que no esté disponible o que no se hayan dado permisos.", 'error');
                // Lógica de Venta Manual al fallar la cámara (REINTEGRADA)
                document.getElementById('scan-result').innerHTML = `
                    <div class="bg-red-100 p-4 rounded-lg text-center text-red-800 shadow-inner">
                        <p class="font-bold mb-2">Error de Cámara</p>
                        <p>No se pudo acceder a la cámara o no hay una disponible.</p>
                        <button id="manual-sale-btn" class="mt-4 bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">
                            <i class="fas fa-tag mr-2"></i> Registrar Venta Manual (por ID)
                        </button>
                    </div>
                `;
                document.getElementById('manual-sale-btn').onclick = () => {
                    // Mostrar modal para buscar ID
                    showModal("Venta Manual (Búsqueda de ID)", `
                        <p>Debido al fallo de escaneo, introduce el ID de la prenda manualmente para registrar la venta.</p>
                        <input type="text" id="manual-id-input" placeholder="ID de la prenda (ej: P-a1b2c3d)" class="mt-3 w-full px-3 py-2 border border-gray-300 rounded-md">
                        <button id="search-prenda-manual" class="mt-3 w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Buscar Prenda</button>
                        <div id="manual-search-result" class="mt-4 border-t pt-3"></div>
                    `);

                    document.getElementById('search-prenda-manual').onclick = () => {
                        const id = document.getElementById('manual-id-input').value.trim();
                        const prenda = prendas.find(p => p.id === id);
                        const resultDiv = document.getElementById('manual-search-result');

                        if (prenda) {
                            if (prenda.vendido) {
                                resultDiv.innerHTML = `<p class="text-red-500 font-semibold">Error: Esta prenda (ID: ${id}) ya fue vendida.</p>`;
                            } else {
                                resultDiv.innerHTML = `
                                    <div class="p-3 bg-green-50 rounded-lg border border-green-200">
                                        <p class="font-bold text-green-800">Prenda Encontrada:</p>
                                        <p>ID: ${prenda.id}</p>
                                        <p>Precio: $${parseFloat(prenda.precioEfectivo).toLocaleString('es-AR')}</p>
                                        <p>Talle: ${prenda.talle}</p>
                                        <p>Tipo: ${(prenda.tipos_de_ropa || []).join(', ')}</p>
                                        <button onclick="showManualSaleModal('${prenda.id}'); if(strategyModal) strategyModal.classList.add('hidden');" class="mt-3 bg-red-600 text-white font-bold py-2 px-4 rounded-lg">
                                            Confirmar Venta Manual
                                        </button>
                                    </div>
                                `;
                            }
                        } else {
                            resultDiv.innerHTML = `<p class="text-red-500 font-semibold">Prenda con ID "${id}" no encontrada en el inventario.</p>`;
                        }
                    };
                };
            });
        }

        function stopScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    console.log("QR Code scanning stopped.");
                }).catch((err) => {
                    console.error("Error al detener el escáner:", err);
                });
            }
        }

        async function onScanSuccess(decodedText, decodedResult) {
            stopScanner();
            document.getElementById('scan-result').innerHTML = ''; // Limpiar resultados anteriores
            
            let id = decodedText;
            try {
                // Intentar parsear el JSON si fue generado por la app
                const data = JSON.parse(decodedText);
                if (data.id) {
                    id = data.id;
                }
            } catch (e) {
                // Si no es JSON, asumir que es el ID puro
                id = decodedText;
            }

            const prenda = prendas.find(p => p.id === id);

            if (prenda) {
                if (prenda.vendido) {
                    document.getElementById('scan-result').innerHTML = `
                        <div class="bg-yellow-100 p-4 rounded-lg text-center text-yellow-800 shadow-inner">
                            <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                            <p class="text-xl font-bold">¡ADVERTENCIA! Prenda Ya Vendida</p>
                            <p class="mt-2 text-lg">ID: <span class="font-mono">${prenda.id}</span></p>
                            <p class="text-lg">Talle: ${prenda.talle}</p>
                            <p class="text-sm mt-3">Registrada como vendida el ${formatDate(prenda.ultimo_escaneo)}.</p>
                            <button onclick="startScanner()" class="mt-4 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition">Escanear Otro</button>
                        </div>
                    `;
                } else {
                    // Prenda en stock: confirmar venta
                    const confirmationHTML = `
                        <div class="bg-indigo-100 p-6 rounded-lg text-center text-indigo-800 shadow-2xl border-4 border-indigo-500">
                            <i class="fas fa-tag text-5xl text-indigo-600 mb-4"></i>
                            <p class="text-2xl font-extrabold mb-1">Prenda Encontrada en Stock</p>
                            <p class="text-4xl font-black text-green-700 my-3">$${parseFloat(prenda.precioEfectivo).toLocaleString('es-AR')}</p>
                            <p class="text-lg">Talle: <span class="font-bold">${prenda.talle}</span> | Tipo: ${(prenda.tipos_de_ropa || []).join(', ')}</p>
                            <p class="text-sm mt-2">ID: <span class="font-mono">${prenda.id}</span></p>

                            <button id="confirm-sale-btn" class="mt-6 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-green-700 transition">CONFIRMAR VENTA</button>
                            <button onclick="startScanner()" class="mt-3 w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition">Cancelar / Escanear Otro</button>
                        </div>
                    `;
                    document.getElementById('scan-result').innerHTML = confirmationHTML;
                    
                    document.getElementById('confirm-sale-btn').onclick = async () => {
                        await markAsSold(prenda.id);
                        document.getElementById('scan-result').innerHTML = `
                            <div class="bg-green-100 p-6 rounded-lg text-center text-green-800 shadow-2xl border-4 border-green-500">
                                <i class="fas fa-check-circle text-5xl text-green-600 mb-4"></i>
                                <p class="text-2xl font-extrabold mb-1">¡Venta Registrada con Éxito!</p>
                                <p class="text-4xl font-black text-green-700 my-3">$${parseFloat(prenda.precioEfectivo).toLocaleString('es-AR')}</p>
                                <button onclick="startScanner()" class="mt-6 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition">Escanear Siguiente</button>
                            </div>
                        `;
                    };
                }

            } else {
                document.getElementById('scan-result').innerHTML = `
                    <div class="bg-red-100 p-4 rounded-lg text-center text-red-800 shadow-inner">
                        <i class="fas fa-times-circle text-3xl mb-3"></i>
                        <p class="text-xl font-bold">¡ERROR! Prenda No Encontrada</p>
                        <p class="mt-2 text-lg">QR Escaneado: <span class="font-mono">${id}</span></p>
                        <p class="text-sm mt-3">Este ID no coincide con ninguna prenda registrada.</p>
                        <div class="flex flex-col space-y-3 mt-4">
                            <button onclick="startScanner()" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Intentar de Nuevo</button>
                            <button id="manual-sale-btn-fail" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">
                                <i class="fas fa-tag mr-2"></i> Registrar Venta Manual (por ID)
                            </button>
                        </div>
                    </div>
                `;
                 document.getElementById('manual-sale-btn-fail').onclick = () => {
                     // Llama a la lógica de venta manual con el modal de búsqueda de ID
                     // Usamos la lógica integrada en startScanner() para el fallback.
                     const manualSaleBtn = document.getElementById('manual-sale-btn');
                     if(manualSaleBtn) manualSaleBtn.click();
                     else showModal("Venta Manual (Búsqueda de ID)", `<p>Por favor, usa el menú principal para iniciar el escáner y ver la opción de venta manual por ID.</p>`);
                 };
            }
        }


        // --- GENERATION LOGIC ---

        function appendTipoCheckbox(container, value, isChecked = false, prefix = '', isCustom = false) {
            // Genera un ID válido basado en el valor
            const safeValue = value.toLowerCase().replace(/[^a-z0-9]/g, '');
            const id = `${prefix}tipo_${safeValue}`;
            
            // Si es un tipo custom (con input de texto y botón de eliminar)
            if (isCustom) {
                 const tipoDiv = document.createElement('div');
                 tipoDiv.className = 'flex items-center';
                 tipoDiv.innerHTML = `
                     <input type="checkbox" name="tipo_ropa" ${isChecked ? 'checked' : ''} value="${value}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                     <input type="text" placeholder="Tipo personalizado" value="${value}" class="ml-3 flex-grow px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                     <button type="button" class="remove-tipo-btn ml-2 text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                 `;
                 container.appendChild(tipoDiv);
                 
                 const checkbox = tipoDiv.querySelector('input[type="checkbox"]');
                 const input = tipoDiv.querySelector('input[type="text"]');
                 
                 // Sincroniza el valor del input con el valor del checkbox
                 input.addEventListener('input', () => { checkbox.value = input.value.trim(); });
                 
                 // Eliminar
                 tipoDiv.querySelector('.remove-tipo-btn').addEventListener('click', () => {
                     tipoDiv.remove();
                 });
            } else {
                // Si es un tipo predefinido (solo checkbox y label)
                const existing = document.getElementById(id);
                if (existing) return; // Evita duplicados de predefinidos

                const newDiv = document.createElement('div');
                newDiv.className = 'flex items-center';
                newDiv.innerHTML = `
                    <input id="${id}" name="tipo_ropa" type="checkbox" value="${value}" ${isChecked ? 'checked' : ''} class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label for="${id}" class="ml-3 block text-sm text-gray-900">${value}</label>
                `;
                container.appendChild(newDiv);
            }
        }

        async function handleQRFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            
            const selectedTipos = getTipoRopa(form);
            if (selectedTipos.length === 0) {
                showAppMessage("Por favor, selecciona al menos un 'Tipo de Ropa'.", 'error');
                return;
            }

            const newPrenda = {
                id: generateID(),
                fecha_creacion: new Date().toISOString(),
                precioEfectivo: form['precio-efectivo'].value,
                precioLista: form['precio-lista'].value,
                talle: form['talle'].value,
                tipos_de_ropa: selectedTipos, // Usar el campo correcto: tipos_de_ropa
                vendedora: form['vendedora'].value,
                descripcion: form['descripcion'].value,
                vendido: false,
                ultimo_escaneo: null,
                fotoBase64: currentPhotoBase64 // Guarda la foto en base64
            };

            await savePrendaToFirestore(newPrenda); // Guarda en Firestore o local

            // 1. Generar QR
            generateQrCode(newPrenda.id, qrDisplay);
            
            // 2. Limpiar UI
            form.reset();
            currentPhotoBase64 = null;
            document.getElementById('photo-preview-container').classList.add('hidden');
            document.getElementById('photo-preview').src = '';
            document.getElementById('gemini-output-section').classList.add('hidden');
            
            showAppMessage("Prenda registrada y QR generado. Sincronizando en la nube...", 'success');
        }

        function generateQrCode(prendaId, containerElement) {
            if (!containerElement) return;

            containerElement.innerHTML = '';
            containerElement.classList.remove('hidden');

            const prenda = prendas.find(p => p.id === prendaId);
            if (!prenda) return;

            const imageHtml = prenda.fotoBase64 ? 
                `<div class="mb-4 flex justify-center">
                    <img src="${prenda.fotoBase64}" alt="Foto de la Prenda" class="w-full max-h-48 object-contain rounded-lg shadow-md border border-gray-300">
                </div>` : 
                '';

            containerElement.innerHTML = `
                ${imageHtml}
                <h3 class="font-bold text-lg mb-4">Código QR Generado para ID: ${prendaId.substring(0, 8)}...</h3>
                <div class="flex justify-center items-center gap-6 flex-wrap">
                    <div id="qrcode-canvas-${prendaId}" class="flex-shrink-0"></div>
                    <div class="mt-4 text-gray-700 text-left mx-auto max-w-sm flex-grow">
                        <p><strong>Precio Efectivo:</strong> $${prenda.precioEfectivo}</p>
                        <p><strong>Precio de Lista:</strong> $${prenda.precioLista}</p>
                        <p><strong>Talle:</strong> ${prenda.talle}</p>
                        <p><strong>Tipo de Ropa:</strong> ${(prenda.tipos_de_ropa || []).join(', ')}</p>
                        <p><strong>Descripción:</strong> ${prenda.descripcion || 'Sin descripción'}</p>
                    </div>
                </div>
                
                <!-- BOTÓN TTS -->
                <div class="mt-6 flex justify-center qr-action-btns">
                    <button id="tts-btn-${prendaId}" data-id="${prendaId}" class="py-2 px-4 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition" ${isAudioPlaying ? 'disabled' : ''}>
                        <i class="fas fa-volume-up mr-2"></i> Escuchar Detalles
                    </button>
                </div>

                <p class="text-sm text-gray-500 mt-4 mb-2 font-semibold">Opciones de acción:</p>
                <div class="flex flex-col md:flex-row justify-center gap-3 mt-2">
                    <button id="download-btn-${prendaId}" data-id="${prendaId}" class="py-2 px-4 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition"><i class="fas fa-download mr-2"></i>Descargar</button>
                    <button id="print-btn-${prendaId}" data-id="${prendaId}" class="py-2 px-4 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition"><i class="fas fa-print mr-2"></i>Imprimir</button>
                    <button id="share-btn-${prendaId}" data-id="${prendaId}" class="py-2 px-4 bg-teal-500 text-white font-semibold rounded-lg shadow-md hover:bg-teal-600 transition"><i class="fas fa-share-alt mr-2"></i>Compartir</button>
                </div>
            `;

            // 2. Generar el QR CODE
            const qrCanvasContainer = document.getElementById(`qrcode-canvas-${prendaId}`);
            if (qrCanvasContainer) {
                try {
                    new QRCode(qrCanvasContainer, {
                        text: prendaId,
                        width: 180,
                        height: 180
                    });
                } catch (error) {
                    qrCanvasContainer.innerHTML = '<p class="text-red-500">Error al generar QR</p>';
                }
            }
            
            // 3. Adjuntar los listeners DE FORMA ASÍNCRONA
            setTimeout(() => {
                const ttsBtn = document.getElementById(`tts-btn-${prendaId}`);
                const downloadBtn = document.getElementById(`download-btn-${prendaId}`);
                const printBtn = document.getElementById(`print-btn-${prendaId}`);
                const shareBtn = document.getElementById(`share-btn-${prendaId}`);

                if (ttsBtn) ttsBtn.addEventListener('click', () => textToSpeech(prendaId));
                // Lógicas de descarga, impresión y compartir (no son parte de la sincronización pero son esenciales)
                if (downloadBtn) downloadBtn.addEventListener('click', () => downloadCode(prendaId));
                if (printBtn) printBtn.addEventListener('click', () => printCode(prendaId));
                if (shareBtn) shareBtn.addEventListener('click', () => shareQrImage(prendaId));

            }, 0); 
        }

        // --- GEMINI AI INTEGRATION (Mismas funciones que antes, adaptadas al flujo de datos) ---

        async function generateGeminiContent(prompt, titleId, outputId, copyBtnId, buttonReference) {
            const outputElement = document.getElementById(outputId);
            const titleElement = document.getElementById(titleId);
            const button = document.getElementById(buttonReference);
            const initialButtonText = button.innerHTML;
            
            if (!outputElement || !button) return;

            outputElement.value = "Generando contenido, espera un momento...";
            document.getElementById('gemini-output-section').classList.remove('hidden');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Generando...';
            
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const systemPrompt = "Eres un asistente de marketing y gestión de inventario para una tienda de indumentaria. Proporciona análisis concisos, atractivos y accionables. Usa lenguaje profesional y directo.";
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: [{ "google_search": {} }],
            };

            const maxRetries = 3;
            let currentRetry = 0;

            const makeApiCall = async () => {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${response.status} - ${errorData.error.message}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar una respuesta.";
                    
                    outputElement.value = text.trim();
                    button.disabled = false;
                    button.innerHTML = initialButtonText;

                    if (copyBtnId) {
                        document.getElementById(copyBtnId).onclick = () => {
                            outputElement.select();
                            document.execCommand('copy');
                            showAppMessage("Texto copiado al portapapeles.", 'info');
                        };
                    }

                } catch (error) {
                    console.error("Error en la llamada a la API:", error);
                    currentRetry++;
                    if (currentRetry < maxRetries) {
                        const delay = Math.pow(2, currentRetry) * 1000; // 2s, 4s, 8s
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return makeApiCall(); // Reintentar
                    } else {
                        outputElement.value = "Error al generar el contenido de la IA. Inténtalo más tarde.";
                        button.disabled = false;
                        button.innerHTML = initialButtonText;
                    }
                }
            };

            await makeApiCall();
        }

        async function handleGenerateDesc() {
            const precioEfectivo = document.getElementById('precio-efectivo').value;
            const precioLista = document.getElementById('precio-lista').value;
            const talle = document.getElementById('talle').value;
            const tipoRopa = getTipoRopa(document.getElementById('qr-form')).join(', ');
            
            if (!precioEfectivo || !precioLista || !talle || !tipoRopa) {
                showAppMessage("Completa Precio Efectivo, Precio de Lista, Talle y Tipo de Ropa primero.", 'error');
                return;
            }

            const prompt = `Genera una descripción corta (máximo 3 frases) y persuasiva para un producto de indumentaria con las siguientes características:\nPrecio de Lista: ARS ${precioLista}\nPrecio en Efectivo: ARS ${precioEfectivo}\nTalle: ${talle}\nTipo de Ropa: ${tipoRopa}\n\nEnfócate en destacar la oferta y la calidad.`;
            
            await generateGeminiContent(prompt, 'gemini-output-title', 'gemini-output', 'copy-desc-btn', 'generate-desc-btn');
            document.getElementById('gemini-output-title').textContent = 'Sugerencia de Descripción';
        }

        async function handleAnalyzeStockRisk() {
            if (prendas.length === 0) {
                 showModal("Análisis de Riesgo de Stock", "<p>No hay datos de prendas en el inventario para realizar un análisis.</p>");
                 return;
            }
            
            const stockData = prendas
                .filter(p => p.vendido !== true)
                .map(p => ({
                    id: p.id,
                    talle: p.talle,
                    tipoRopa: (p.tipos_de_ropa || []).join(', '),
                    precio: parseFloat(p.precioEfectivo),
                    dias_en_stock: Math.floor((new Date() - new Date(p.fecha_creacion)) / (1000 * 60 * 60 * 24))
                }));
                
            const prompt = `Analiza los siguientes datos de stock de indumentaria. Identifica 3 prendas de ALTO RIESGO de obsolescencia (las más antiguas, caras o talles impopulares) y sugiere una acción de marketing específica para cada una (ej: descuento 15%, 2x1, publicación destacada).\n\nDatos de Stock:\n${JSON.stringify(stockData, null, 2)}`;
            
            showModal("Análisis de Riesgo de Stock", `<div class='text-center'><i class='fas fa-spinner fa-spin text-4xl text-orange-500'></i><p class='mt-3'>Consultando estrategia de mercado...</p></div>`);

            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const systemPrompt = "Eres un analista de inventario minorista. Proporciona un análisis en formato HTML con títulos <h3> y listas <ul>. Usa negritas para destacar las prendas y las acciones. No uses Markdown, solo HTML. No incluyas el JSON de entrada en la respuesta. El objetivo es identificar riesgo y sugerir acciones de promoción.";
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: [{ "google_search": {} }],
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const result = await response.json();
                const htmlText = result.candidates?.[0]?.content?.parts?.[0]?.text || "<p>No se pudo generar el análisis. Verifica el estado del servicio.</p>";
                
                modalTitle.textContent = "Resultado del Análisis de Riesgo";
                modalContent.innerHTML = htmlText.trim();

            } catch (error) {
                console.error("Error en la llamada a la API de Análisis:", error);
                modalTitle.textContent = "Error de Análisis";
                modalContent.innerHTML = `<p class="text-red-600">Ocurrió un error al contactar con la IA para el análisis. Inténtalo más tarde.</p>`;
            }
        }


        // --- METRICS (CHART.JS) ---

        function setupMetrics() {
            const soldData = prendas.filter(p => p.vendido === true && p.ultimo_escaneo);
            
            // 1. Chart: Ventas por mes
            const salesByMonth = soldData.reduce((acc, p) => {
                const date = new Date(p.ultimo_escaneo);
                const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                acc[yearMonth] = (acc[yearMonth] || 0) + 1;
                return acc;
            }, {});

            const sortedMonths = Object.keys(salesByMonth).sort();
            const salesCount = sortedMonths.map(month => salesByMonth[month]);
            const labels = sortedMonths.map(month => new Date(month).toLocaleDateString('es-AR', { month: 'short', year: '2-digit' }));

            const ctx = document.getElementById('stock-chart');
            if (!ctx) return;

            if (stockChartInstance) {
                stockChartInstance.destroy();
            }

            stockChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ventas Registradas',
                        data: salesCount,
                        backgroundColor: 'rgba(79, 70, 229, 0.6)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cantidad de Ventas'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Ventas Mensuales (Unidades)'
                        }
                    }
                }
            });
            
            // 2. Calendar Metrics
            renderCalendar(soldData);
        }

        function renderCalendar(soldData) {
            const calendarDaysContainer = document.getElementById('calendar-days');
            if (!calendarDaysContainer) return;

            calendarDaysContainer.innerHTML = '';
            
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);

            const offset = firstDayOfMonth.getDay(); 

            const salesByDate = soldData.reduce((acc, p) => {
                const date = new Date(p.ultimo_escaneo);
                const dateKey = date.toLocaleDateString('es-AR', { day: 'numeric', month: 'numeric', year: 'numeric' });
                acc[dateKey] = (acc[dateKey] || 0) + 1;
                return acc;
            }, {});

            // Rellenar espacios vacíos al inicio
            for (let i = 0; i < offset; i++) {
                calendarDaysContainer.insertAdjacentHTML('beforeend', '<div></div>');
            }

            // Rellenar días del mes
            for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateKey = date.toLocaleDateString('es-AR', { day: 'numeric', month: 'numeric', year: 'numeric' });
                const sales = salesByDate[dateKey] || 0;
                
                let bgColor = 'bg-white';
                let textColor = 'text-gray-800';
                let tooltip = `Ventas: ${sales}`;

                if (sales > 0) {
                    bgColor = sales > 3 ? 'bg-red-400' : sales > 1 ? 'bg-orange-300' : 'bg-yellow-200';
                    textColor = sales > 0 ? 'text-gray-800 font-bold' : 'text-gray-800';
                    tooltip = `Ventas: ${sales}`;
                } 
                
                // Si es el día de hoy y no tiene ventas, se destaca
                if (date.toDateString() === today.toDateString()) {
                    bgColor = sales > 0 ? 'bg-indigo-700' : 'bg-indigo-600';
                    textColor = 'text-white font-bold';
                    tooltip = "Hoy";
                }

                calendarDaysContainer.insertAdjacentHTML('beforeend', `
                    <div class="p-1 rounded-md text-sm ${bgColor} ${textColor} shadow-sm cursor-help transition transform hover:scale-105" title="${tooltip}">
                        ${day}
                    </div>
                `);
            }
        }

        // --- EXPORT FUNCTIONS ---
        function getQrCanvas(prendaId) {
            const canvas = document.querySelector(`#qrcode-canvas-${prendaId} canvas`);
            return canvas;
        }

        // Simplemente descarga la imagen QR combinada con el texto
        function downloadCode(prendaId) {
            const prenda = prendas.find(p => p.id === prendaId);
            const canvas = getQrCanvas(prendaId);
            if (!canvas || !prenda) {
                 showAppMessage("Error: No se encontró el QR para descargar. Asegúrate de que el QR esté visible.", 'error');
                 return;
            }
            // Lógica para crear un canvas combinado (QR + texto)
            const combinedCanvas = document.createElement('canvas');
            const ctx = combinedCanvas.getContext('2d');
            combinedCanvas.width = canvas.width + 50; 
            combinedCanvas.height = canvas.height + 140; 
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, combinedCanvas.width, combinedCanvas.height);
            
            const qrX = (combinedCanvas.width - canvas.width) / 2;
            let currentY = 10;
            ctx.drawImage(canvas, qrX, currentY);
            currentY += canvas.height + 30;

            ctx.fillStyle = '#000000';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            const infoText = `ID: ${prendaId.substring(0, 8)}...\nPrecio Efectivo: $${prenda.precioEfectivo}\nPrecio de Lista: $${prenda.precioLista}\nTalle: ${prenda.talle}\nTipo: ${(prenda.tipos_de_ropa || []).join(', ')}`;
            const lines = infoText.split('\n');
            lines.forEach((line, index) => {
                ctx.fillText(line, combinedCanvas.width / 2, currentY + index * 20);
            });
            
            const link = document.createElement('a');
            link.href = combinedCanvas.toDataURL('image/png');
            link.download = `qr-prenda-${prendaId}.png`;
            link.click();
            showAppMessage("QR descargado (sin foto).", 'success');
        }

        function printCode(prendaId) {
            const prenda = prendas.find(p => p.id === prendaId);
            const qrCanvas = getQrCanvas(prendaId);
            if (!qrCanvas || !prenda) {
                 showAppMessage("Error: No se encontró el QR para imprimir. Asegúrate de que el QR esté visible.", 'error');
                 return;
            }
            const infoText = `Precio Efectivo: $${prenda.precioEfectivo}\nPrecio de Lista: $${prenda.precioLista}\nTalle: ${prenda.talle}\nTipo: ${(prenda.tipos_de_ropa || []).join(', ')}\nDescripción: ${prenda.descripcion || 'Sin descripción'}`;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html><head><title>Imprimir QR</title></head>
                <body style="text-align:center; margin-top: 50px;">
                    <img src="${qrCanvas.toDataURL()}" style="max-width: 100%; width: 180px;">
                    <p style="font-size: 14px; margin-top: 20px; white-space: pre-line;">${infoText}</p>
                </body></html>`);
            printWindow.document.close();
            printWindow.onload = () => printWindow.print();
        }

        async function shareQrImage(prendaId) {
            const prenda = prendas.find(p => p.id === prendaId);
            const canvas = getQrCanvas(prendaId);
            if (!canvas || !prenda) {
                 showAppMessage("Error: No se encontró el QR para compartir.", 'error');
                 return;
            }
            try {
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                const infoText = `Detalles de la Prenda:\nPrecio Efectivo: $${prenda.precioEfectivo}\nPrecio de Lista: $${prenda.precioLista}\nTalle: ${prenda.talle}\nTipo: ${(prenda.tipos_de_ropa || []).join(', ')}\nDescripción: ${prenda.descripcion || 'Sin descripción'}`;
                const file = new File([blob], `qr-prenda-${prendaId}.png`, { type: 'image/png' });
                const shareData = {
                    files: [file],
                    title: 'QR de Prenda',
                    text: infoText,
                };
                if (navigator.canShare && navigator.canShare(shareData)) {
                    await navigator.share(shareData);
                    showAppMessage('¡Compartido con éxito!', 'success');
                } else {
                    showAppMessage('No se puede compartir la imagen en este navegador. Intenta descargar y compartir manualmente.', 'info');
                }
            } catch (err) {
                console.error("Error al compartir imagen:", err);
                showAppMessage('Error al compartir la imagen.', 'error');
            }
        }
        
        function convertToExportableData(data) {
             return data.map(p => ({
                ID: p.id,
                'Precio Efectivo': parseFloat(p.precioEfectivo) || 0,
                'Precio Lista': parseFloat(p.precioLista) || 0,
                Talle: p.talle,
                'Tipo de Ropa': (p.tipos_de_ropa || []).join(', '),
                Vendedora: p.vendedora || '',
                Descripción: p.descripcion || '',
                Estado: p.vendido ? 'VENDIDO' : 'EN STOCK',
                'Fecha de Registro': formatDate(p.fecha_creacion),
                'Fecha de Venta': p.vendido ? formatDate(p.ultimo_escaneo) : '',
                'Días en Stock (al momento de la venta o hasta hoy)': p.dias_transcurridos || (p.vendido ? Math.floor((new Date(p.ultimo_escaneo) - new Date(p.fecha_creacion)) / (1000 * 60 * 60 * 24)) : Math.floor((new Date() - new Date(p.fecha_creacion)) / (1000 * 60 * 60 * 24))),
                'Motivo Venta Manual': p.manual_sale_reason || ''
            }));
        }

        function exportToExcel() {
            const data = convertToExportableData(prendas);
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventario QR");
            XLSX.writeFile(wb, "Inventario_QR_Indumentaria.xlsx");
            showAppMessage("Exportado a Excel con éxito.", 'success');
        }

        function exportToCSV() {
            const data = convertToExportableData(prendas);
            let csv = XLSX.utils.json_to_csv(data);
            
            // Reemplazar "," por ";" y evitar problemas con formato Latinoamericano
            csv = csv.replace(/(\"[^"]*\"|[^,"]+),/g, (match, p1) => {
                if (p1.startsWith('"')) return match; 
                return p1 + ';'; 
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Inventario_QR_Indumentaria.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showAppMessage("Exportado a CSV (separado por ;).", 'success');
        }

        // --- TTS UTILITIES ---
        // (Funciones de soporte para TTS, necesarias para el botón de 'Escuchar Detalles')
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; 
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcm16.length * bytesPerSample;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            // RIFF chunk
            view.setUint32(0, 0x52494646, false); // 'RIFF'
            view.setUint32(4, 36 + dataSize, true);
            view.setUint32(8, 0x57415645, false); // 'WAVE'

            // 'fmt ' chunk
            view.setUint32(12, 0x666d7420, false); // 'fmt '
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16, true); // 16 bits per sample

            // 'data' chunk
            view.setUint32(36, 0x64617461, false); // 'data'
            view.setUint32(40, dataSize, true);

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }
        
        async function textToSpeech(prendaId) {
            if (isAudioPlaying) {
                showAppMessage("Ya se está generando audio. Por favor, espere.", 'info');
                return;
            }

            const prenda = prendas.find(p => p.id === prendaId);
            const ttsButton = document.getElementById(`tts-btn-${prendaId}`);
            if (!prenda || !ttsButton) return;

            const textToSay = `Atención. Prenda registrada: ${(prenda.tipos_de_ropa || []).join(', ')}. Talle: ${prenda.talle}. Precio en efectivo: ${prenda.precioEfectivo} pesos argentinos. Precio de lista: ${prenda.precioLista} pesos. Descripción adicional: ${prenda.descripcion || 'No se proporcionó descripción'}.`;

            isAudioPlaying = true;
            ttsButton.disabled = true;
            ttsButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Generando Audio...`;
            showAppMessage("Generando audio de los detalles...", 'info');
            
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: textToSay }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" } 
                        }
                    },
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Error en la API de TTS: ${response.status}`);

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();

                    audio.onended = () => {
                        isAudioPlaying = false;
                        ttsButton.disabled = false;
                        ttsButton.innerHTML = `<i class="fas fa-volume-up mr-2"></i> Escuchar Detalles`;
                        URL.revokeObjectURL(audioUrl);
                        showAppMessage("Reproducción finalizada.", 'success');
                    };
                    showAppMessage("Reproduciendo detalles...", 'success');
                } else {
                    throw new Error("Respuesta de audio no válida o formato incorrecto.");
                }

            } catch (error) {
                console.error("Error al generar TTS:", error);
                showAppMessage(`Error de audio: ${error.message}`, 'error');
                isAudioPlaying = false;
                ttsButton.disabled = false;
                ttsButton.innerHTML = `<i class="fas fa-volume-up mr-2"></i> Error de Audio`;
            }
        }
        
        // --- PUSH NOTIFICATIONS ---

        function requestNotificationPermission() {
             if (!('Notification' in window)) return;
             if (Notification.permission === "granted") {
                 isPushEnabled = true;
                 return;
             }
             if (Notification.permission !== "denied") {
                 Notification.requestPermission().then(permission => {
                     if (permission === "granted") {
                         isPushEnabled = true;
                         showAppMessage("Notificaciones habilitadas.", 'info');
                     }
                 });
             }
        }
        
        // --- EVENT LISTENERS (Mapeo a showSection y llamadas a Firebase) ---

        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();

            // Navigación
            document.getElementById('show-generation-btn').onclick = () => showSection('generation-section');
            document.getElementById('show-scanner-btn').onclick = () => {
                showSection('scanner-section');
                startScanner();
            };
            document.getElementById('show-history-btn').onclick = () => showSection('history-section');
            document.getElementById('show-metrics-btn').onclick = () => {
                showSection('metrics-section');
                setupMetrics();
            };
            document.querySelectorAll('.back-to-menu').forEach(btn => {
                btn.onclick = () => showSection('main-menu');
            });
            document.querySelectorAll('.back-to-history').forEach(btn => {
                btn.onclick = () => showSection('history-section');
            });

            // Formularios y Acciones
            if (qrForm) qrForm.onsubmit = handleQRFormSubmit;
            if (editForm) editForm.onsubmit = handleEditFormSubmit;

            if (generateDescBtn) generateDescBtn.onclick = handleGenerateDesc;
            if (analyzeStockRiskBtn) analyzeStockRiskBtn.onclick = handleAnalyzeStockRisk;
            
            // Exportar
            if (exportExcelBtn) exportExcelBtn.onclick = exportToExcel;
            if (exportCsvBtn) exportCsvBtn.onclick = exportToCSV;
            if (copyDescBtn) copyDescBtn.onclick = () => {
                if (geminiOutput) {
                    geminiOutput.select();
                    document.execCommand('copy');
                    showAppMessage("Texto copiado al portapapeles.", 'success');
                }
            };

            // Tipos de Ropa
            const addCustomTipoBtn = document.getElementById('add-custom-tipo');
            if (addCustomTipoBtn) {
                addCustomTipoBtn.onclick = () => {
                    appendTipoCheckbox(document.getElementById('tipo-ropa-container'), '', false, '', true);
                };
            }
            
            const addEditCustomTipoBtn = document.getElementById('add-edit-custom-tipo');
            if (addEditCustomTipoBtn) {
                addEditCustomTipoBtn.onclick = () => {
                    appendTipoCheckbox(document.getElementById('edit-tipo-ropa-container'), '', false, 'edit', true);
                };
            }
        });
        
        // --- UTILITY FUNCTIONS FOR CUSTOM TIPOS ---
        function resetCustomTipos() {
            if (tipoRopaContainer) {
                const customTipos = tipoRopaContainer.querySelectorAll('.remove-tipo-btn');
                customTipos.forEach(btn => btn.parentElement.remove());
            }
        }
        function resetEditCustomTipos() {
            if (editTipoRopaContainer) {
                const customTipos = editTipoRopaContainer.querySelectorAll('.remove-tipo-btn');
                customTipos.forEach(btn => btn.parentElement.remove());
            }
        }
        
    </script>
</body>
</html>
