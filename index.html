<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de QR para Indumentaria</title>
    <meta name="theme-color" content="#4f46e5">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icono.png">
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Dependencias externas: Tailwind CSS, QR Scanner, QR Generator, Excel/Chart libs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<!-- Se a√±ade 'dark' al body si est√° en modo noche, y transici√≥n para el cambio de color -->
<body class="bg-gray-100 dark:bg-gray-900 font-sans transition-colors duration-300">
    
    <!-- PANTALLA DE INICIO DE SESI√ìN (SIMULADA) -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4 bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
        <div class="w-full max-w-sm p-8 bg-white dark:bg-gray-800 rounded-xl shadow-2xl text-center">
            <img src="logo.png" alt="Logo de la aplicaci√≥n" class="w-16 h-16 mx-auto mb-4 rounded-xl" 
                onerror="this.onerror=null; this.src='https://placehold.co/64x64/4f46e5/ffffff?text=G&font=sans'">
            <h2 class="text-3xl font-bold text-indigo-600 mb-2 dark:text-indigo-400">Bienvenido</h2>
            <p class="text-gray-600 mb-8 dark:text-gray-400">Inicia sesi√≥n para acceder a tu historial local de QRs.</p>

            <button id="google-login-btn" class="w-full flex items-center justify-center px-4 py-3 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 font-semibold rounded-lg shadow-md hover:bg-gray-50 dark:hover:bg-gray-600 transition duration-300 border border-gray-300 dark:border-gray-600">
                <img class="w-5 h-5 mr-3" src="https://img.icons8.com/color/48/000000/google-logo.png" alt="Google logo"/>
                Continuar con Google
            </button>
            <p class="mt-4 text-xs text-gray-500 dark:text-gray-500">
                *Tus datos de QR se guardan en tu dispositivo (Local Storage).
            </p>
        </div>
    </div>
    <!-- FIN PANTALLA DE INICIO DE SESI√ìN -->

    <!-- CONTENEDOR PRINCIPAL DE LA APLICACI√ìN -->
    <div id="app-container" class="max-w-2xl mx-auto p-4 md:p-6 hidden"> 
        <header class="mb-8 flex items-center justify-between relative">
            <!-- Logo y T√≠tulo (LOGO AGRANDADO) -->
            <div class="flex items-center">
                <img src="logo.png" alt="Logo de la aplicaci√≥n" class="w-12 h-12 mr-3 rounded-md" 
                    onerror="this.onerror=null; this.src='https://placehold.co/48x48/4f46e5/ffffff?text=G&font=sans'">
                <div>
                    <h1 class="text-4xl font-bold text-indigo-600 dark:text-indigo-400">Gestor de QR</h1>
                    <span class="text-xs font-normal text-gray-600 dark:text-gray-400">v.3.0 (Sync Multi-Dispositivo)</span>
                </div>
            </div>
            
            <!-- Bot√≥n de Modo D√≠a/Noche (NUEVO) -->
            <div class="flex items-center space-x-2">
                <label for="theme-toggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="theme-toggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 dark:peer-focus:ring-indigo-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-indigo-600"></div>
                </label>
                <i id="theme-icon" class="fas fa-sun text-xl text-gray-600 dark:text-gray-400"></i>
            </div>
        </header>
        
        <!-- Men√∫ Principal -->
        <main id="main-menu" class="space-y-4">
            <!-- Los botones mantienen su color fijo para funcionar bien en ambos modos -->
            <button id="install-app-modal-btn" class="w-full bg-blue-500 text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:bg-blue-600 transition duration-300 flex items-center justify-center text-lg hidden">
                <i class="fas fa-mobile-alt mr-3"></i> Descargar Aplicaci√≥n
            </button>
            <button id="show-generation-btn" class="w-full bg-indigo-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition duration-300 flex items-center justify-center text-lg">
                <i class="fas fa-plus-circle mr-3"></i> Generar QR
            </button>
            <button id="show-scanner-btn" class="w-full bg-purple-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:bg-purple-700 transition duration-300 flex items-center justify-center text-lg">
                <i class="fas fa-qrcode mr-3"></i> Escanear QR
            </button>
            <button id="show-history-btn" class="w-full bg-gray-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:bg-gray-800 transition duration-300 flex items-center justify-center text-lg">
                <i class="fas fa-history mr-3"></i> Historial y Sync
            </button>
            <button id="show-metrics-btn" class="w-full bg-teal-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:bg-teal-700 transition duration-300 flex items-center justify-center text-lg">
                <i class="fas fa-chart-line mr-3"></i> M√©tricas
            </button>
        </main>

        <!-- Secci√≥n de Generaci√≥n -->
        <section id="generation-section" class="hidden">
            <button class="back-to-menu text-indigo-600 dark:text-indigo-400 mb-4 font-semibold"><i class="fas fa-arrow-left mr-2"></i> Volver al men√∫</button>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4">Registrar Prenda</h2>
                <form id="qr-form" class="space-y-4">
                    <!-- CAMPO DE FOTO/C√ÅMARA/IMPORTAR (MODIFICADO) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Foto de la Prenda (Opcional)</label>
                        <div class="flex space-x-3">
                            <!-- Input para la C√ÅMARA (Fuerza la apertura de la c√°mara si es compatible) -->
                            <input type="file" id="camera-photo-input" name="cameraPhoto" accept="image/*" capture="environment" class="hidden">
                            <button type="button" id="open-camera-btn" class="flex-1 bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-600 transition flex items-center justify-center text-sm">
                                <i class="fas fa-camera mr-2"></i> Usar C√°mara
                            </button>

                            <!-- Input para IMPORTAR ARCHIVO (Abre el selector de archivos) -->
                            <input type="file" id="import-photo-input" name="importPhoto" accept="image/*" class="hidden">
                            <button type="button" id="import-file-btn" class="flex-1 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 transition flex items-center justify-center text-sm">
                                <i class="fas fa-file-upload mr-2"></i> Importar Foto
                            </button>
                        </div>
                        <div id="photo-preview-container" class="mt-4 hidden">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Previsualizaci√≥n:</p>
                            <img id="photo-preview" src="" alt="Previsualizaci√≥n de la foto" class="max-w-full h-32 object-contain rounded-lg border border-gray-300 dark:border-gray-600 w-full">
                            <button type="button" id="remove-photo-btn" class="mt-2 text-red-500 hover:text-red-700 text-sm font-semibold"><i class="fas fa-trash-alt mr-1"></i> Quitar Foto</button>
                        </div>
                    </div>
                    <!-- FIN CAMPO FOTO (MODIFICADO) -->
                    <div>
                        <label for="precio-efectivo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Precio Efectivo (ARS) *</label>
                        <input type="number" id="precio-efectivo" name="precioEfectivo" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 dark:text-gray-100">
                    </div>
                    <div>
                        <label for="precio-lista" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Precio de Lista (ARS) *</label>
                        <input type="number" id="precio-lista" name="precioLista" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 dark:text-gray-100">
                    </div>
                    <div>
                        <label for="talle" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Talle *</label>
                        <input type="text" id="talle" name="talle" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 dark:text-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tipo de Ropa *</label>
                        <div id="tipo-ropa-container" class="mt-2 space-y-2">
                            <div class="flex items-center">
                                <input id="tipo_importada" name="tipo_ropa" type="checkbox" value="Importada" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="tipo_importada" class="ml-3 block text-sm text-gray-900 dark:text-gray-100">Importada</label>
                            </div>
                            <div class="flex items-center">
                                <input id="tipo_nacional" name="tipo_ropa" type="checkbox" value="Nacional" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="tipo_nacional" class="ml-3 block text-sm text-gray-900 dark:text-gray-100">Nacional</label>
                            </div>
                            <div class="flex items-center">
                                <input id="tipo_nuevo" name="tipo_ropa" type="checkbox" value="Nuevo" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="tipo_nuevo" class="ml-3 block text-sm text-gray-900 dark:text-gray-100">Nuevo</label>
                            </div>
                        </div>
                        <button type="button" id="add-custom-tipo" class="mt-2 bg-blue-500 text-white font-semibold py-1 px-2 rounded-lg shadow-md hover:bg-blue-600 transition"><i class="fas fa-plus mr-1"></i> A√±adir tipo personalizado</button>
                    </div>
                    <div>
                        <label for="vendedora" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Vendedora (Opcional)</label>
                        <input type="text" id="vendedora" name="vendedora" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 dark:text-gray-100">
                    </div>
                    <div>
                        <label for="descripcion" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Descripci√≥n (Opcional)</label>
                        <textarea id="descripcion" name="descripcion" rows="3" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 dark:text-gray-100"></textarea>
                    </div>
                    <div class="pt-2 border-t border-gray-200 dark:border-gray-700 space-y-3">
                        <button type="button" id="generate-desc-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-purple-700 transition duration-300 flex items-center justify-center">
                            ‚ú® Generar Descripci√≥n Inteligente
                        </button>
                        <!-- BOT√ìN PARA AN√ÅLISIS DE RIESGO DE STOCK -->
                        <button type="button" id="analyze-stock-risk-btn" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-orange-600 transition duration-300 flex items-center justify-center">
                            ‚ú® Analizar Riesgo de Stock
                        </button>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Generar QR y Guardar</button>
                </form>
            </div>
            <div id="gemini-output-section" class="hidden mt-6 bg-purple-50 dark:bg-gray-700 p-6 rounded-xl shadow-inner">
                <h3 class="text-xl font-bold text-purple-800 dark:text-purple-400 mb-3" id="gemini-output-title">Sugerencia de la IA</h3>
                <textarea id="gemini-output" readonly class="w-full h-40 p-2 border border-purple-200 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 resize-none dark:text-gray-100"></textarea>
                <button id="copy-desc-btn" class="mt-2 py-2 px-4 bg-purple-500 text-white font-semibold rounded-lg shadow-md hover:bg-purple-600 transition"><i class="fas fa-copy mr-2"></i>Copiar Texto</button>
            </div>
            <div id="qr-display" class="hidden mt-6 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg text-center"></div>
        </section>

        <!-- Secci√≥n de Edici√≥n -->
        <section id="edit-section" class="hidden">
            <button class="back-to-history text-indigo-600 dark:text-indigo-400 mb-4 font-semibold"><i class="fas fa-arrow-left mr-2"></i> Volver al historial</button>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4">Editar Prenda</h2>
                <form id="edit-form" class="space-y-4">
                    <input type="hidden" id="edit-id" name="id">
                    <!-- CAMPO DE FOTO/C√ÅMARA/IMPORTAR EDICI√ìN (MODIFICADO) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Foto de la Prenda (Opcional)</label>
                        <div class="flex space-x-3">
                            <!-- Input para la C√ÅMARA (Fuerza la apertura de la c√°mara si es compatible) -->
                            <input type="file" id="edit-camera-photo-input" name="editCameraPhoto" accept="image/*" capture="environment" class="hidden">
                            <button type="button" id="edit-open-camera-btn" class="flex-1 bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-600 transition flex items-center justify-center text-sm">
                                <i class="fas fa-camera mr-2"></i> Usar C√°mara
                            </button>

                            <!-- Input para IMPORTAR ARCHIVO (Abre el selector de archivos) -->
                            <input type="file" id="edit-import-photo-input" name="editImportPhoto" accept="image/*" class="hidden">
                            <button type="button" id="edit-import-file-btn" class="flex-1 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 transition flex items-center justify-center text-sm">
                                <i class="fas fa-file-upload mr-2"></i> Importar Foto
                            </button>
                        </div>
                        <div id="edit-photo-preview-container" class="mt-4 hidden">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Previsualizaci√≥n Actual:</p>
                            <img id="edit-photo-preview" src="" alt="Previsualizaci√≥n de la foto" class="max-w-full h-32 object-contain rounded-lg border border-gray-300 dark:border-gray-600 w-full">
                            <button type="button" id="edit-remove-photo-btn" class="mt-2 text-red-500 hover:text-red-700 text-sm font-semibold"><i class="fas fa-trash-alt mr-1"></i> Quitar Foto</button>
                        </div>
                    </div>
                    <!-- FIN CAMPO FOTO EDICI√ìN (MODIFICADO) -->
                    <div>
                        <label for="edit-precio-efectivo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Precio Efectivo (ARS) *</label>
                        <input type="number" id="edit-precio-efectivo" name="precioEfectivo" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 dark:text-gray-100">
                    </div>
                    <div>
                        <label for="edit-precio-lista" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Precio de Lista (ARS) *</label>
                        <input type="number" id="edit-precio-lista" name="precioLista" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 dark:text-gray-100">
                    </div>
                    <div>
                        <label for="edit-talle" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Talle *</label>
                        <input type="text" id="edit-talle" name="talle" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 dark:text-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tipo de Ropa *</label>
                        <div id="edit-tipo-ropa-container" class="mt-2 space-y-2">
                            <div class="flex items-center">
                                <input id="edit-tipo_importada" name="tipo_ropa" type="checkbox" value="Importada" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="edit-tipo_importada" class="ml-3 block text-sm text-gray-900 dark:text-gray-100">Importada</label>
                            </div>
                            <div class="flex items-center">
                                <input id="edit-tipo_nacional" name="tipo_ropa" type="checkbox" value="Nacional" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="edit-tipo_nacional" class="ml-3 block text-sm text-gray-900 dark:text-gray-100">Nacional</label>
                            </div>
                            <div class="flex items-center">
                                <input id="edit-tipo_nuevo" name="tipo_ropa" type="checkbox" value="Nuevo" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="edit-tipo_nuevo" class="ml-3 block text-sm text-gray-900 dark:text-gray-100">Nuevo</label>
                            </div>
                        </div>
                        <button type="button" id="add-edit-custom-tipo" class="mt-2 bg-blue-500 text-white font-semibold py-1 px-2 rounded-lg shadow-md hover:bg-blue-600 transition"><i class="fas fa-plus mr-1"></i> A√±adir tipo personalizado</button>
                    </div>
                    <div>
                        <label for="edit-vendedora" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Vendedora (Opcional)</label>
                        <input type="text" id="edit-vendedora" name="vendedora" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 dark:text-gray-100">
                    </div>
                    <div>
                        <label for="edit-descripcion" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Descripci√≥n (Opcional)</label>
                        <textarea id="edit-descripcion" name="descripcion" rows="3" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 dark:text-gray-100"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">Guardar Cambios</button>
                </form>
            </div>
        </section>

        <!-- Secci√≥n de Escaneo -->
        <section id="scanner-section" class="hidden">
            <button class="back-to-menu text-indigo-600 dark:text-indigo-400 mb-4 font-semibold"><i class="fas fa-arrow-left mr-2"></i> Volver al men√∫</button>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg">
                <div id="reader" class="w-full rounded-lg overflow-hidden"></div>
            </div>
            <div id="scan-result" class="mt-6"></div>
        </section>

        <!-- Secci√≥n de Historial (AHORA CON SYNCHRONIZATION) -->
        <section id="history-section" class="hidden">
            <button class="back-to-menu text-indigo-600 dark:text-indigo-400 mb-4 font-semibold"><i class="fas fa-arrow-left mr-2"></i> Volver al men√∫</button>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4">Historial y Sincronizaci√≥n</h2>

                <!-- BLOQUE DE SINCRONIZACI√ìN POR ARCHIVO JSON -->
                <div class="mb-6 p-4 bg-indigo-50 dark:bg-gray-700 rounded-xl border border-indigo-200 dark:border-indigo-700">
                    <h3 class="font-bold text-indigo-800 dark:text-indigo-400 mb-2"><i class="fas fa-sync-alt mr-2"></i>Sincronizaci√≥n con Archivo (Backup)</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">Descarga el Backup para transferir tus QRs a otro celular, o c√°rgalo para recibir datos.</p>
                    <div class="flex flex-col md:flex-row gap-3">
                        <button id="backup-download-btn" class="flex-1 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition text-sm">
                            <i class="fas fa-save mr-2"></i> üíæ Descargar Backup (JSON)
                        </button>
                        
                        <input type="file" id="backup-upload-input" accept=".json" class="hidden">
                        <button id="backup-upload-btn" class="flex-1 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition text-sm">
                            <i class="fas fa-file-upload mr-2"></i> üìÇ Cargar Backup de otro Celular
                        </button>
                    </div>
                </div>
                <!-- FIN BLOQUE DE SINCRONIZACI√ìN POR ARCHIVO JSON -->

                <!-- NUEVO BLOQUE DE TRANSFERENCIA POR QR -->
                <div class="mb-6 p-4 bg-purple-50 dark:bg-gray-700 rounded-xl border border-purple-200 dark:border-purple-700">
                    <h3 class="font-bold text-purple-800 dark:text-purple-400 mb-2"><i class="fas fa-arrows-alt-h mr-2"></i>Transferencia R√°pida por QR</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">Transfiere tu historial al instante a otro celular sin usar archivos. Ideal para peque√±os historiales.</p>
                    <div class="flex flex-col md:flex-row gap-3">
                        <button id="show-qr-transfer-btn" class="flex-1 bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition text-sm">
                            <i class="fas fa-share-alt mr-2"></i> üì§ Generar QR de Transferencia
                        </button>
                        <button id="show-qr-receive-btn" class="flex-1 bg-orange-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-700 transition text-sm">
                            <i class="fas fa-qrcode mr-2"></i> üì• Recibir Datos por QR
                        </button>
                    </div>
                </div>
                <!-- FIN NUEVO BLOQUE DE TRANSFERENCIA POR QR -->

                <div class="mb-4">
                    <input type="text" id="search-bar" placeholder="Buscar por ID, Talle, Tipo, Cliente o Vendedora..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-gray-700 dark:text-gray-100">
                </div>
                <div class="flex justify-between mb-4 text-gray-800 dark:text-gray-100">
                    <p id="stock-count" class="text-lg font-semibold">Stock actual: 0</p>
                    <p id="sold-sum" class="text-lg font-semibold text-red-700 dark:text-red-400">Vendidos: $0</p>
                    <p id="speculation-sum" class="text-lg font-semibold text-green-700 dark:text-green-400">Especulaci√≥n: $0</p>
                </div>
                <div class="flex justify-between mb-4">
                    <button id="export-excel-btn" class="py-2 px-4 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition"><i class="fas fa-file-excel mr-2"></i>Exportar a Excel</button>
                    <button id="export-csv-btn" class="py-2 px-4 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition"><i class="fas fa-file-csv mr-2"></i>Exportar a CSV</button>
                </div>
                <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-2">No Vendidos</h3>
                <div id="not-sold-list" class="space-y-4 mb-6"></div>
                <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-2">Vendidos</h3>
                <div id="sold-list" class="space-y-4"></div>
            </div>
        </section>

        <!-- Secci√≥n para Re-mostrar/Gestionar QR desde Historial (CON T√çTULO EXPLICITO) -->
        <section id="re-qr-section" class="hidden">
            <button class="back-to-history text-indigo-600 dark:text-indigo-400 mb-4 font-semibold"><i class="fas fa-arrow-left mr-2"></i> Volver al historial</button>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4">Detalle y Gesti√≥n de QR</h2>
            <div id="re-qr-display" class="mt-6 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg text-center">
                <!-- El QR, la foto y las opciones se renderizar√°n aqu√≠ -->
            </div>
        </section>

        <!-- Secci√≥n de Transferencia por QR (Send/Receive) (NUEVO) -->
        <section id="transfer-section" class="hidden">
            <button class="back-to-history text-indigo-600 dark:text-indigo-400 mb-4 font-semibold"><i class="fas fa-arrow-left mr-2"></i> Volver al historial</button>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 id="transfer-title" class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4"></h2>
                <p id="transfer-instructions" class="text-gray-600 dark:text-gray-300 mb-4"></p>
                
                <!-- Contenedor para el QR Generado (SEND) -->
                <div id="qr-transfer-display" class="hidden my-6 p-4 border border-gray-300 dark:border-gray-600 rounded-lg text-center">
                    <div id="large-qr-canvas" class="flex justify-center my-4"></div>
                    <p class="text-xs text-red-500 font-semibold">¬°Advertencia! Este QR contiene TODOS tus datos. Mantenlo en privado y escanea r√°pido.</p>
                </div>
                
                <!-- Contenedor para el Esc√°ner (RECEIVE) -->
                <div id="qr-receive-scanner-container" class="hidden">
                    <div id="receiver-reader" class="w-full rounded-lg overflow-hidden my-4"></div>
                    <div id="receive-status" class="mt-4 p-3 text-center bg-gray-100 dark:bg-gray-700 rounded-lg dark:text-gray-100">Esperando escaneo...</div>
                    <button id="stop-receive-scan-btn" class="w-full mt-4 bg-red-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-red-600 transition duration-300"><i class="fas fa-stop-circle mr-2"></i> Detener Esc√°ner</button>
                </div>
            </div>
        </section>
        <!-- FIN Secci√≥n de Transferencia por QR (Send/Receive) -->

        <!-- Secci√≥n de M√©tricas -->
        <section id="metrics-section" class="hidden">
            <button class="back-to-menu text-indigo-600 dark:text-indigo-400 mb-4 font-semibold"><i class="fas fa-arrow-left mr-2"></i> Volver al men√∫</button>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4">M√©tricas de Stock</h2>
                <canvas id="stock-chart" width="400" height="200"></canvas>
                <div id="calendar-metrics" class="mt-6">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-2">Almanaque de Actividades</h3>
                    <div class="grid grid-cols-7 gap-2 text-center text-gray-800 dark:text-gray-100">
                        <div class="font-bold">Dom</div>
                        <div class="font-bold">Lun</div>
                        <div class="font-bold">Mar</div>
                        <div class="font-bold">Mi√©</div>
                        <div class="font-bold">Jue</div>
                        <div class="font-bold">Vie</div>
                        <div class="font-bold">S√°b</div>
                    </div>
                    <div id="calendar-days" class="grid grid-cols-7 gap-2 mt-2 text-center"></div>
                </div>
            </div>
        </section>

        <!-- Notificaciones -->
        <div id="app-message" class="fixed bottom-4 right-4 z-50"></div>
    </div>

    <!-- Modal de An√°lisis de Estrategia -->
    <div id="strategy-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-lg w-full p-6">
            <h3 id="modal-title" class="text-2xl font-bold text-indigo-600 dark:text-indigo-400 mb-4"></h3>
            <div id="modal-content" class="space-y-3 text-gray-700 dark:text-gray-300 text-left"></div>
            <!-- **NOTA: ELIMINADO EL BOT√ìN DUPLICADO AQU√ç** -->
            <button id="close-modal-btn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition">Cerrar</button>
        </div>
    </div>
    
    <!-- Modal de Venta Manual -->
    <div id="manual-sale-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full p-6 relative">
            <button id="close-manual-sale-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h3 class="text-2xl font-bold text-red-600 dark:text-red-400 mb-4">Venta Manual de Prenda </h3>
            <p class="text-gray-700 dark:text-gray-300 mb-4">Selecciona el motivo del problema de escaneo:</p>

            <form id="manual-sale-form" class="space-y-3">
                <div class="space-y-2">
                    <label class="flex items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/50 cursor-pointer transition">
                        <input type="radio" name="scan-reason" value="C√°mara rota" class="form-radio text-red-600 h-5 w-5">
                        <span class="ml-3 text-gray-700 dark:text-gray-300 font-medium">C√°mara rota</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/50 cursor-pointer transition">
                        <input type="radio" name="scan-reason" value="QR da√±ado" class="form-radio text-red-600 h-5 w-5">
                        <span class="ml-3 text-gray-700 dark:text-gray-300 font-medium">QR da√±ado</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/50 cursor-pointer transition">
                        <input type="radio" name="scan-reason" value="Falta de tiempo" class="form-radio text-red-600 h-5 w-5">
                        <span class="ml-3 text-gray-700 dark:text-gray-300 font-medium">Falta de tiempo</span>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/50 cursor-pointer transition">
                        <input type="radio" name="scan-reason" value="Problemas de red" class="form-radio text-red-600 h-5 w-5">
                        <span class="ml-3 text-gray-700 dark:text-gray-300 font-medium">Problemas de red</span>
                    </label>
                    <label id="otro-radio-label" class="flex items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/50 cursor-pointer transition">
                        <input type="radio" name="scan-reason" value="Otro" class="form-radio text-red-600 h-5 w-5">
                        <span class="ml-3 text-gray-700 dark:text-gray-300 font-medium">Otro (aclarar el motivo)</span>
                    </label>
                </div>

                <div id="reason-other-container" class="hidden mt-3 pt-2 border-t border-gray-200 dark:border-gray-700">
                    <input type="text" id="reason-other-input" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-red-500 focus:border-red-500 bg-white dark:bg-gray-700 dark:text-gray-100" placeholder="Escribe el motivo aqu√≠">
                </div>
                
                <button type="submit" class="w-full mt-4 bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                    Confirmar Venta
                </button>
            </form>
        </div>
    </div>

    <!-- Modal de Instalaci√≥n PWA (NUEVO) -->
    <div id="install-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-sm w-full p-6 relative">
            <button id="close-install-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h3 class="text-2xl font-bold text-blue-600 dark:text-blue-400 mb-4 text-center">Instalar Aplicaci√≥n</h3>
            <div class="space-y-4 text-gray-700 dark:text-gray-300">
                <p>¬°Lleva el **Gestor de QR** a tu pantalla de inicio para un acceso r√°pido y sin interrupciones! Funciona como una aplicaci√≥n nativa.</p>
                
                <h4 class="font-semibold text-gray-800 dark:text-gray-100 flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i> Beneficios:</h4>
                <ul class="list-disc list-inside ml-4 text-sm space-y-1">
                    <li>Acceso directo sin navegador.</li>
                    <li>Funcionamiento sin conexi√≥n.</li>
                    <li>Experiencia de pantalla completa.</li>
                </ul>

                <p class="text-sm text-center pt-2 border-t border-gray-100 dark:border-gray-700">Presiona el bot√≥n de abajo para instalarla en tu dispositivo.</p>
            </div>
            <button id="install-btn-in-modal" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition flex items-center justify-center">
                <i class="fas fa-download mr-2"></i> Agregar a Pantalla Principal
            </button>
            <p id="install-tip" class="mt-4 text-xs text-center text-gray-500 dark:text-gray-400 hidden">
                <i class="fas fa-info-circle mr-1"></i> Si el bot√≥n no funciona, usa el men√∫ del navegador ("Agregar a pantalla de inicio").
            </p>
        </div>
    </div>
    <script>
        // --- CONSTANTE DE CONTRASE√ëA ACTUALIZADA ---
        const DELETE_PASSWORD = "1440"; // Contrase√±a de seguridad para eliminar
        // Se ha aumentado este l√≠mite para permitir transferencias de historial m√°s grandes por QR. 
        // ¬°ADVERTENCIA! Un valor alto aqu√≠ hace que el QR sea muy denso y dif√≠cil de escanear por un celular.
        const QR_MAX_SIZE = 10000; // L√≠mite de caracteres AUMENTADO para m√°s memoria de transferencia.

        // --- VARIABLES GLOBALES ---
        let prendas = [];
        let html5QrCode;
        let html5QrCodeReceiver; // NUEVO: Instancia separada para el esc√°ner de recepci√≥n
        let deferredPrompt;
        let editingId = null;
        let customTipoCount = 0;
        let isPushEnabled = false;
        let currentPhotoBase64 = null;
        let isAudioPlaying = false; // Estado para el bot√≥n TTS
        let selectedManualSaleId = null; // ID de la prenda para venta manual

        // --- REFERENCIAS DE MODO D√çA/NOCHE Y LOGIN ---
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const body = document.body;
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const googleLoginBtn = document.getElementById('google-login-btn');


        // --- DARK MODE LOGIC (NEW) ---
        function loadTheme() {
            const isDark = localStorage.getItem('isDarkMode') === 'true';
            if (isDark) {
                body.classList.add('dark');
                if (themeToggle) themeToggle.checked = true;
                if (themeIcon) {
                    themeIcon.classList.remove('fa-sun');
                    themeIcon.classList.add('fa-moon');
                }
            } else {
                body.classList.remove('dark');
                if (themeToggle) themeToggle.checked = false;
                if (themeIcon) {
                    themeIcon.classList.remove('fa-moon');
                    themeIcon.classList.add('fa-sun');
                }
            }
        }
        
        function toggleTheme() {
            const isDark = body.classList.toggle('dark');
            localStorage.setItem('isDarkMode', isDark);
            if (themeIcon) {
                themeIcon.classList.remove(isDark ? 'fa-sun' : 'fa-moon');
                themeIcon.classList.add(isDark ? 'fa-moon' : 'fa-sun');
            }
            // Re-renderizar elementos din√°micos para que hereden el modo oscuro
            setupHistoryDisplay(); 
            setupMetricsChart(); 
        }

        if (themeToggle) {
            themeToggle.addEventListener('change', toggleTheme);
            loadTheme(); // Cargar tema al inicio del script
        }
        // --- END DARK MODE LOGIC ---

        // --- LOGIN LOGIC (NEW) ---
        function checkLoginStatus() {
            loadTheme(); // Asegurar que el tema est√© cargado antes de mostrar cualquier pantalla

            // 1. Verificar si ya se ha autenticado simuladamente
            const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
            
            if (isAuthenticated) {
                // Si ya est√° autenticado, ocultar login y mostrar app
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                initializeApp(); // Inicializar la app
            } else {
                // Mostrar pantalla de login
                loginScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        }

        function handleGoogleLogin() {
            // Este es un inicio de sesi√≥n simulado. Al hacer clic, se considera autenticado.
            localStorage.setItem('isAuthenticated', 'true');
            showAppMessage("Inicio de sesi√≥n simulado exitoso.", 'success');
            checkLoginStatus(); // Transiciona a la app principal
        }

        if (googleLoginBtn) {
            googleLoginBtn.addEventListener('click', handleGoogleLogin);
        }
        // --- END LOGIN LOGIC ---


        // --- REFERENCIAS AL MODAL DE ESTRATEGIA ---
        const strategyModal = document.getElementById('strategy-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal-btn');
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', () => {
                if (strategyModal) strategyModal.classList.add('hidden');
            });
        }

        // --- REFERENCIAS AL MODAL DE VENTA MANUAL ---
        const manualSaleModal = document.getElementById('manual-sale-modal');
        const closeManualSaleModalBtn = document.getElementById('close-manual-sale-modal');
        const manualSaleForm = document.getElementById('manual-sale-form');
        const reasonOtherContainer = document.getElementById('reason-other-container');
        const reasonOtherInput = document.getElementById('reason-other-input');

        // --- REFERENCIAS AL MODAL DE INSTALACI√ìN PWA (NUEVO) ---
        const installModal = document.getElementById('install-modal');
        const installModalBtn = document.getElementById('install-app-modal-btn');
        const closeInstallModalBtn = document.getElementById('close-install-modal-btn');
        const installBtnInModal = document.getElementById('install-btn-in-modal');
        const installTip = document.getElementById('install-tip');

        // --- FUNCIONES DE MODAL ---
        function showModal(title, content) {
            if (modalTitle) modalTitle.textContent = title;
            if (modalContent) modalContent.innerHTML = content;
            if (strategyModal) strategyModal.classList.remove('hidden');
        }
            
        // --- FUNCIONES DE MODAL DE INSTALACI√ìN PWA (NUEVO) ---
        function showInstallModal() {
            if (installModal) installModal.classList.remove('hidden');
            // Muestra el tip si no hay deferredPrompt, indicando que debe usar el men√∫ del navegador
            if (!deferredPrompt && installTip) installTip.classList.remove('hidden');
            else if (installTip) installTip.classList.add('hidden');
        }

        function hideInstallModal() {
            if (installModal) installModal.classList.add('hidden');
        }

        // Add listeners for the new buttons
        if (installModalBtn) {
            installModalBtn.addEventListener('click', showInstallModal);
        }
        if (closeInstallModalBtn) {
            closeInstallModalBtn.addEventListener('click', hideInstallModal);
        }


        // --- FUNCIONES DE VENTA MANUAL (REINTEGRADAS) ---
        function showManualSaleModal(prendaId) {
            selectedManualSaleId = prendaId;
            manualSaleModal.classList.remove('hidden');
            manualSaleForm.reset();
            reasonOtherContainer.classList.add('hidden');
            reasonOtherInput.value = '';
        }

        function hideManualSaleModal() {
            manualSaleModal.classList.add('hidden');
            selectedManualSaleId = null;
        }

        function processManualSale(reason) {
            if (!selectedManualSaleId) {
                showAppMessage("Error: No se ha seleccionado una prenda para la venta manual.", 'error');
                return;
            }

            const prenda = prendas.find(p => p.id === selectedManualSaleId);
            if (!prenda) {
                showAppMessage("Error: Prenda no encontrada en el historial.", 'error');
                return;
            }

            // Marcar como vendido y guardar el motivo
            prenda.ultimo_escaneo = new Date().toISOString();
            prenda.manual_sale_reason = reason;

            // Calcular d√≠as transcurridos hasta la venta
            const diasTranscurridos = Math.floor((new Date(prenda.ultimo_escaneo) - new Date(prenda.fecha_creacion)) / (1000 * 60 * 60 * 24));
            prenda.dias_transcurridos = diasTranscurridos;

            prenda.vendido = true; // Nuevo campo para sincronizaci√≥n

            savePrendasToStorage();
            setupHistoryDisplay(); // Refrescar el historial
            hideManualSaleModal();
            showAppMessage(`Venta manual de la prenda ${selectedManualSaleId.substring(0, 8)}... registrada por: ${reason}.`, 'success');
        }

        // Listener para cerrar el modal de venta manual
        if (closeManualSaleModalBtn) {
            closeManualSaleModalBtn.addEventListener('click', hideManualSaleModal);
        }

        // Listener para mostrar/ocultar campo "Otro"
        if (manualSaleForm) {
            manualSaleForm.addEventListener('change', (e) => {
                const selectedRadio = manualSaleForm.querySelector('input[name="scan-reason"]:checked');
                if (selectedRadio && selectedRadio.value === 'Otro') {
                    reasonOtherContainer.classList.remove('hidden');
                } else {
                    reasonOtherContainer.classList.add('hidden');
                }
            });
            
            // Listener para procesar la venta manual
            manualSaleForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const selectedRadio = manualSaleForm.querySelector('input[name="scan-reason"]:checked');
                let reason = '';

                if (!selectedRadio) {
                    showAppMessage('Por favor, selecciona un motivo.', 'error');
                    return;
                }

                if (selectedRadio.value === 'Otro') {
                    reason = reasonOtherInput.value.trim();
                    if (reason === '') {
                        showAppMessage('Por favor, aclara el motivo en el campo de texto.', 'error');
                        return;
                    }
                } else {
                    reason = selectedRadio.value;
                }
                
                processManualSale(reason);
            });
        }
        
        // --- FUNCI√ìN UTILITARIA PARA CONVERTIR ARCHIVO A BASE64 ---
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        // --- MANEJO DE IMAGENES (REFACTORIZADO) ---
        function setupImageHandlers(isEdit = false) {
            const prefix = isEdit ? 'edit-' : '';
            
            // Referencias a los nuevos inputs y botones
            const cameraInput = document.getElementById(`${prefix}camera-photo-input`);
            const importInput = document.getElementById(`${prefix}import-photo-input`);
            const cameraBtn = document.getElementById(`${prefix}open-camera-btn`);
            const importBtn = document.getElementById(`${prefix}import-file-btn`);
            
            // Referencias a la previsualizaci√≥n y eliminaci√≥n
            const photoPreview = document.getElementById(`${prefix}photo-preview`);
            const photoPreviewContainer = document.getElementById(`${prefix}photo-preview-container`);
            const removePhotoBtn = document.getElementById(`${prefix}remove-photo-btn`);

            // Validaci√≥n de existencia de elementos (esencial para que los listeners no fallen)
            if (!cameraInput || !importInput || !removePhotoBtn || !cameraBtn || !importBtn) return;

            // 1. L√≥gica para manejar el cambio de archivo (desde cualquiera de los dos inputs)
            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Limpiar el otro input para evitar confusi√≥n de estado
                    const otherInput = e.target === cameraInput ? importInput : cameraInput;
                    otherInput.value = '';
                    
                    try {
                        currentPhotoBase64 = await fileToBase64(file);
                        if (photoPreview) photoPreview.src = currentPhotoBase64;
                        if (photoPreviewContainer) photoPreviewContainer.classList.remove('hidden');
                        showAppMessage("Imagen cargada con √©xito.", 'success');
                    } catch (error) {
                        console.error("Error al convertir a Base64:", error);
                        showAppMessage("Error al cargar la imagen.", 'error');
                        currentPhotoBase64 = null;
                        if (photoPreviewContainer) photoPreviewContainer.classList.add('hidden');
                    }
                }
            };
            
            // 2. Adjuntar listeners de click a los botones
            cameraBtn.onclick = () => cameraInput.click();
            importBtn.onclick = () => importInput.click();

            // 3. Adjuntar listeners de cambio de archivo a los inputs
            cameraInput.onchange = handleFileChange;
            importInput.onchange = handleFileChange;

            // 4. L√≥gica del bot√≥n de eliminar
            removePhotoBtn.onclick = () => {
                currentPhotoBase64 = null;
                cameraInput.value = '';
                importInput.value = '';
                if (photoPreview) photoPreview.src = '';
                if (photoPreviewContainer) photoPreviewContainer.classList.add('hidden');
            };
        }


        // --- INICIALIZACI√ìN ---
        function initializeApp() {
            loadPrendasFromStorage();
            setupHistoryDisplay();
            setupPwaInstall();
            requestNotificationPermission();
            setupImageHandlers(false); // Configurar para Generaci√≥n
            setupImageHandlers(true); // Configurar para Edici√≥n
            setupCustomTipoListeners(tipoRopaContainer, 'add-custom-tipo');
            setupCustomTipoListeners(editTipoRopaContainer, 'add-edit-custom-tipo');

            // --- LISTENERS DE BUSQUEDA/EXPORTACI√ìN ---
            if (searchBar) searchBar.addEventListener('input', setupHistoryDisplay);
            if (exportExcelBtn) exportExcelBtn.addEventListener('click', exportToExcel);
            if (exportCsvBtn) exportCsvBtn.addEventListener('click', exportToCsv);


            // --- LISTENERS DE BACKUP/SYNC (NUEVOS) ---
            document.getElementById('backup-download-btn').addEventListener('click', downloadBackup);
            document.getElementById('backup-upload-btn').addEventListener('click', () => document.getElementById('backup-upload-input').click());
            document.getElementById('backup-upload-input').addEventListener('change', handleBackupUpload);
            // --- FIN LISTENERS DE BACKUP/SYNC ---

            // --- LISTENERS DE TRANSFERENCIA QR (A√ëADIDOS) ---
            document.getElementById('show-qr-transfer-btn').addEventListener('click', () => showTransferQr());
            document.getElementById('show-qr-receive-btn').addEventListener('click', () => startReceiveScanner());
            document.getElementById('stop-receive-scan-btn').addEventListener('click', () => stopReceiveScanner(true));
            // --- FIN LISTENERS DE TRANSFERENCIA QR ---

            showAppMessage("Aplicaci√≥n lista (datos locales).", 'success');
            console.log("App inicializada con localStorage.");
        }

        // --- PWA INSTALACI√ìN ---
        function setupPwaInstall() {
            if (!installModalBtn || !installBtnInModal) return; // Ensure elements exist

            // 1. Mostrar el bot√≥n de la app si el navegador lo permite
            // Lo mostramos por defecto, en el beforeinstallprompt se configura la acci√≥n
            installModalBtn.classList.remove('hidden');
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                console.log("Evento beforeinstallprompt disparado. PWA disponible para instalaci√≥n.");
            });

            // 2. Manejar la instalaci√≥n desde el bot√≥n DENTRO del modal
            installBtnInModal.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`Resultado de instalaci√≥n: ${outcome}`);
                    deferredPrompt = null;
                    // Esconder el modal y el bot√≥n del modal despu√©s de un intento
                    hideInstallModal();
                    installModalBtn.classList.add('hidden'); 
                } else {
                    // Si el bot√≥n est√° visible pero el prompt no est√° capturado (caso raro o despu√©s de rechazo)
                    showAppMessage("Instalaci√≥n fallida. Utiliza el men√∫ del navegador.", 'error');
                }
            });

            // 3. Manejar la instalaci√≥n ya completada (esconder el bot√≥n)
            window.addEventListener('appinstalled', () => {
                showAppMessage("¬°Aplicaci√≥n instalada con √©xito! Reanudando en la versi√≥n instalada.", 'success');
                console.log("App instalada como PWA. Ocultando bot√≥n.");
                installModalBtn.classList.add('hidden');
                deferredPrompt = null;
            });

            // 4. Si la app ya est√° instalada o se ejecuta como PWA, ocultar el bot√≥n
            if (window.matchMedia('(display-mode: standalone)').matches || 
                navigator.standalone === true) {
                installModalBtn.classList.add('hidden');
                console.log("La aplicaci√≥n ya se est√° ejecutando en modo PWA. Bot√≥n de instalaci√≥n oculto.");
            }
        }

        // --- SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => {
                        console.log("Service Worker registrado:", reg);
                        // initializePush(reg); // Deshabilitado, requiere VAPID key
                    })
                    .catch(err => console.error("Error al registrar Service Worker:", err));
            });
        }

        // --- LOCALSTORAGE FUNCTIONS ---
        function loadPrendasFromStorage() {
            try {
                const stored = localStorage.getItem('qrPrendas');
                if (stored) {
                    prendas = JSON.parse(stored);
                    console.log(`Cargadas ${prendas.length} prendas desde localStorage.`);
                } else {
                    prendas = [];
                }
            } catch (error) {
                console.error("Error cargando localStorage:", error);
                showAppMessage("Error al cargar datos locales. Usando memoria temporal.", 'error');
                prendas = [];
            }
        }

        function savePrendasToStorage() {
            try {
                localStorage.setItem('qrPrendas', JSON.stringify(prendas));
                console.log(`Guardadas ${prendas.length} prendas en localStorage.`);
                syncToSharedStorage(); // Sincronizaci√≥n con el "Cat√°logo" (si existe)
            } catch (error) {
                console.error("Error guardando localStorage:", error);
                showAppMessage("Error al guardar datos. Se perder√°n al cerrar el navegador.", 'error');
            }
        }

        // Nueva funci√≥n para sincronizar con el cat√°logo de la segunda app (Manteniendo la funcionalidad original)
        function syncToSharedStorage() {
            const sharedProducts = prendas.map(p => ({
                id: p.id,
                image: p.fotoBase64 || 'https://placehold.co/300x250?text=Producto',
                name: p.tipos_de_ropa.join(' / ') + ' - Talle ' + p.talle,
                cashPrice: p.precioEfectivo,
                listPrice: p.precioLista,
                description: p.descripcion || 'Sin descripci√≥n',
                ultimo_escaneo: p.ultimo_escaneo, // Para filtrar no vendidos
                vendido: p.vendido || false
            }));
            localStorage.setItem('sharedProducts', JSON.stringify(sharedProducts));
            console.log('Sincronizado con sharedProducts para el cat√°logo.');
        }

        // --- FUNCI√ìN IMPORTANTE: BACKUP Y RESTORE (FUSIONADAS) ---

        // Funci√≥n para descargar el JSON de Backup (C√≥digo 2)
        function downloadBackup() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(prendas));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "backup_qr_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showAppMessage("Backup descargado. Env√≠alo al otro celular.", 'success');
        }

        // Funci√≥n de Merge de datos (utilizada por backup y QR receive) (NUEVO)
        function mergePrendas(importedPrendas) {
            let addedCount = 0;
            importedPrendas.forEach(impItem => {
                const existingIndex = prendas.findIndex(p => p.id === impItem.id);
                if (existingIndex === -1) {
                    prendas.push(impItem);
                    addedCount++;
                } else {
                    // Opcional: Si existe, se actualiza solo si la versi√≥n importada es m√°s nueva (e.g. si fue vendido)
                    // Por simplicidad, aqu√≠ solo se a√±ade si no existe (la filosof√≠a de backup/restore)
                }
            });
            savePrendasToStorage();
            setupHistoryDisplay();
            return addedCount;
        }

        // Funci√≥n para cargar el JSON de Backup (C√≥digo 2)
        function handleBackupUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedPrendas = JSON.parse(e.target.result);
                    if (!Array.isArray(importedPrendas)) throw new Error("Formato incorrecto");
                    
                    // L√≥gica de Fusi√≥n:
                    const addedCount = mergePrendas(importedPrendas);
                    showAppMessage(`Backup cargado. ${addedCount} prendas nuevas a√±adidas.`, 'success');
                } catch (error) {
                    console.error("Error al leer/procesar el archivo de backup:", error);
                    showAppMessage("Error al leer el archivo de backup. Verifica que sea un JSON v√°lido.", 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        // --- MANEJO DEL DOM Y NAVEGACI√ìN ---
        const mainMenu = document.getElementById('main-menu');
        const generationSection = document.getElementById('generation-section');
        const editSection = document.getElementById('edit-section');
        const scannerSection = document.getElementById('scanner-section');
        const historySection = document.getElementById('history-section');
        const metricsSection = document.getElementById('metrics-section');
        const reQrSection = document.getElementById('re-qr-section'); 
        const transferSection = document.getElementById('transfer-section'); // NUEVO
        const qrForm = document.getElementById('qr-form');
        const editForm = document.getElementById('edit-form');
        const qrDisplay = document.getElementById('qr-display');
        const reQrDisplay = document.getElementById('re-qr-display'); 
        const scanResult = document.getElementById('scan-result');
        const notSoldList = document.getElementById('not-sold-list');
        const soldList = document.getElementById('sold-list');
        const stockCount = document.getElementById('stock-count');
        const soldSum = document.getElementById('sold-sum');
        const speculationSum = document.getElementById('speculation-sum');
        const searchBar = document.getElementById('search-bar');
        const generateDescBtn = document.getElementById('generate-desc-btn');
        const analyzeStockRiskBtn = document.getElementById('analyze-stock-risk-btn'); 
        const geminiOutputSection = document.getElementById('gemini-output-section');
        const geminiOutputTitle = document.getElementById('gemini-output-title'); 
        const geminiOutput = document.getElementById('gemini-output');
        const copyDescBtn = document.getElementById('copy-desc-btn');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const tipoRopaContainer = document.getElementById('tipo-ropa-container');
        const editTipoRopaContainer = document.getElementById('edit-tipo-ropa-container');

        // NUEVAS REFERENCIAS PARA TRANSFERENCIA QR
        const qrTransferDisplay = document.getElementById('qr-transfer-display');
        const largeQrCanvas = document.getElementById('large-qr-canvas');
        const qrReceiveScannerContainer = document.getElementById('qr-receive-scanner-container');
        const receiverReader = document.getElementById('receiver-reader');
        const transferTitle = document.getElementById('transfer-title');
        const transferInstructions = document.getElementById('transfer-instructions');
        const stopReceiveScanBtn = document.getElementById('stop-receive-scan-btn');


        // A√±adir el nuevo elemento a la lista de secciones
        const sections = [generationSection, editSection, scannerSection, historySection, metricsSection, reQrSection, transferSection]; 

        function showView(viewId) {
            mainMenu.classList.add('hidden');
            sections.forEach(section => {
                if(section) section.classList.add('hidden'); // Verifica si existe
            });
            stopScanner();
            stopReceiveScanner(false); // Detener el esc√°ner de recepci√≥n tambi√©n
            if (geminiOutputSection) geminiOutputSection.classList.add('hidden');
            if (strategyModal) strategyModal.classList.add('hidden'); 
            if (manualSaleModal) manualSaleModal.classList.add('hidden'); // Ocultar el modal de venta manual
            if (installModal) installModal.classList.add('hidden'); // Ocultar el modal de instalaci√≥n
            if (viewId === 'main') {
                mainMenu.classList.remove('hidden');
            } else {
                const targetSection = document.getElementById(viewId);
                if (targetSection) targetSection.classList.remove('hidden');
            }
        }

        document.getElementById('show-generation-btn').addEventListener('click', () => {
            if (qrForm) qrForm.reset();
            if (qrDisplay) {
                qrDisplay.innerHTML = '';
                qrDisplay.classList.add('hidden');
            }
            
            // Resetear la foto y el preview al cambiar a la secci√≥n de generaci√≥n (UPDATED)
            currentPhotoBase64 = null;
            const cameraInput = document.getElementById('camera-photo-input');
            const importInput = document.getElementById('import-photo-input');
            const photoPreviewContainer = document.getElementById('photo-preview-container');
            if (cameraInput) cameraInput.value = '';
            if (importInput) importInput.value = '';
            if (photoPreviewContainer) photoPreviewContainer.classList.add('hidden');

            if (geminiOutputSection) geminiOutputSection.classList.add('hidden');
            resetCustomTipos();
            showView('generation-section');
        });

        document.getElementById('show-scanner-btn').addEventListener('click', () => {
            if (scanResult) scanResult.innerHTML = '';
            showView('scanner-section');
            startScanner();
        });

        document.getElementById('show-history-btn').addEventListener('click', () => {
            setupHistoryDisplay();
            showView('history-section');
        });

        document.getElementById('show-metrics-btn').addEventListener('click', () => {
            setupMetricsChart();
            setupCalendarMetrics(); 
            showView('metrics-section');
        });

        document.querySelectorAll('.back-to-menu').forEach(btn => {
            btn.addEventListener('click', () => showView('main'));
        });

        document.querySelectorAll('.back-to-history').forEach(btn => {
            btn.addEventListener('click', () => {
                showView('history-section');
                resetEditCustomTipos();
            });
        });
        
        // --- L√ìGICA DE AN√ÅLISIS ---
        async function analyzeTrend(prendaId) {
            const prenda = prendas.find(p => p.id === prendaId);
            if (!prenda) {
                showAppMessage("Prenda no encontrada para an√°lisis de tendencia.", 'error');
                return;
            }

            showAppMessage("‚ú® Buscando tendencias globales para el art√≠culo...", 'info');
            showModal("An√°lisis de Tendencia de Mercado", `<p class="text-center"><i class="fas fa-spinner fa-spin mr-2"></i> Buscando en tiempo real...</p>`);

            const itemType = prenda.tipos_de_ropa.join(', ');
            const queries = [`Tendencia de moda actual en Argentina para ${itemType}. ¬øEs popular?`, `fashion trends Argentina ${itemType}`];
            
            const systemPrompt = `Eres un experto en tendencias de moda y retail de Buenos Aires, Argentina. Tu tarea es analizar los datos de b√∫squeda recientes para determinar si el tipo de art√≠culo es tendencia actual. Responde con un an√°lisis conciso y claro (2-3 frases), indicando si el art√≠culo es: 'Tendencia Alta', 'Tendencia Media' o 'Tendencia Baja', y justifica brevemente tu conclusi√≥n basada en la informaci√≥n de b√∫squeda. La respuesta debe ser solo el an√°lisis en espa√±ol.`;

            try {
                const apiKey = ""; // Canvas provides this
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ parts: [{ text: queries[0] }] }],
                    tools: [{ "google_search": { queries: queries } }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`Error en la API de Gemini: ${response.status} - ${response.statusText}`);
                }
                
                const result = await response.json();
                const candidate = result.candidates?.[0];
                const generatedText = candidate?.content?.parts?.[0]?.text || "No se pudo generar el an√°lisis de tendencia.";

                let sourcesHtml = '';
                const groundingMetadata = candidate?.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    const sources = groundingMetadata.groundingAttributions
                        .map(attr => `<a href="${attr.web?.uri}" target="_blank" class="text-xs text-indigo-500 hover:underline">${attr.web?.title || 'Fuente sin t√≠tulo'}</a>`)
                        .join('<br>');
                    sourcesHtml = `<div class="mt-4 pt-3 border-t border-gray-100 dark:border-gray-700 text-left"><h5 class="text-sm font-semibold text-gray-600 dark:text-gray-300 mb-1">Fuentes:</h5>${sources}</div>`;
                }

                const htmlContent = `
                    <p class="font-bold text-gray-800 dark:text-gray-100">An√°lisis para Tipo de Prenda: ${itemType}</p>
                    <p class="text-gray-700 dark:text-gray-300">${generatedText}</p>
                    ${sourcesHtml}
                `;
                
                showModal("An√°lisis de Tendencia de Mercado", htmlContent);
                showAppMessage("An√°lisis de tendencia generado.", 'success');

            } catch (error) {
                console.error("Error al llamar a Gemini API para an√°lisis de tendencia:", error);
                showModal("Error de An√°lisis de Tendencia", `<p>No se pudo completar el an√°lisis de IA. Por favor, revise su conexi√≥n o reintente.</p><p class="text-sm text-red-500">${error.message}</p>`);
            }
        }

        async function analyzeStrategy(prendaId) {
            const prenda = prendas.find(p => p.id === prendaId);
            if (!prenda) {
                showAppMessage("Prenda no encontrada para an√°lisis.", 'error');
                return;
            }

            const d√≠asSinEscanear = Math.floor((new Date() - new Date(prenda.fecha_creacion)) / (1000 * 60 * 60 * 24));
            
            showAppMessage("‚ú® Analizando estrategia con IA...", 'info');
            showModal("An√°lisis de Estrategia de Stock", `<p class="text-center text-gray-800 dark:text-gray-100"><i class="fas fa-spinner fa-spin mr-2"></i> Generando recomendaci√≥n...</p>`);

            const prompt = `
                Act√∫a como un analista de inventario y estratega de precios para una peque√±a boutique de moda en Argentina. 
                Analiza los siguientes datos de un art√≠culo y proporciona una recomendaci√≥n clara y accionable.
                El an√°lisis debe constar de dos secciones, tituladas "### An√°lisis de Situaci√≥n" y "### Recomendaci√≥n de Estrategia", cada una con un p√°rrafo corto y conciso.
                Utiliza el idioma espa√±ol de Argentina.

                Datos del Art√≠culo:
                - Estado: En Stock (No Vendido)
                - Precio Efectivo: $${prenda.precioEfectivo} ARS
                - Precio de Lista: $${prenda.precioLista} ARS
                - Talle: ${prenda.talle}
                - Tipo: ${prenda.tipos_de_ropa.join(', ')}
                - Descripci√≥n: ${prenda.descripcion || 'Sin descripci√≥n detallada'}
                - D√≠as en Stock (Sin Escanear/Vender): ${d√≠asSinEscanear} d√≠as.
            `;

            try {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                };
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`Error en la API de Gemini: ${response.status} - ${response.statusText}`);
                }
                const result = await response.json();
                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar el an√°lisis. Intente de nuevo.";
                
                // Convertir Markdown a HTML b√°sico para el modal
                const htmlContent = generatedText.split('\n').map(line => {
                    if (line.startsWith('### ')) return `<h4 class="font-semibold text-gray-900 dark:text-gray-100 mt-4">${line.substring(4)}</h4>`;
                    if (line.trim() === '') return '';
                    return `<p>${line}</p>`;
                }).join('');
                
                showModal("An√°lisis de Estrategia de Stock para " + (prenda.tipos_de_ropa.join(' / ') || 'Prenda'), htmlContent);
                showAppMessage("Estrategia generada.", 'success');

            } catch (error) {
                console.error("Error al llamar a Gemini API para an√°lisis:", error);
                showModal("Error de An√°lisis", `<p>No se pudo completar el an√°lisis de IA. Por favor, revise su conexi√≥n o reintente.</p><p class="text-sm text-red-500">${error.message}</p>`);
            }
        }
        
        // --- L√ìGICA DE GENERACI√ìN DE DESCRIPCI√ìN INTELIGENTE (EXISTENTE) ---
        if (generateDescBtn) {
            generateDescBtn.addEventListener('click', async () => {
                const precioEfectivo = document.getElementById('precio-efectivo')?.value;
                const precioLista = document.getElementById('precio-lista')?.value;
                const talle = document.getElementById('talle')?.value;
                const descripcion = document.getElementById('descripcion')?.value;
                const tiposDeRopa = Array.from(document.querySelectorAll('input[name="tipo_ropa"]:checked')).map(cb => cb.value || cb.nextElementSibling?.value || '');
                if (!precioEfectivo || !precioLista || !talle || tiposDeRopa.length === 0) {
                    showAppMessage("Completa Precio Efectivo, Precio de Lista, Talle y Tipo de Ropa para generar la descripci√≥n.", 'error');
                    return;
                }
                generateDescBtn.disabled = true;
                generateDescBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Generando...`;
                const prompt = `
                    Act√∫a como un experto en marketing de moda para redes sociales en Argentina.
                    Crea una descripci√≥n atractiva y corta (2-3 frases) para una prenda de ropa y una idea creativa para una publicaci√≥n en Instagram (sin hashtags).
                    La respuesta debe estar en espa√±ol de Argentina y usar formato Markdown con los t√≠tulos "### Descripci√≥n del Producto" y "### Idea para Red Social".
                    Detalles de la prenda:
                    - Tipo: ${tiposDeRopa.join(', ')}
                    - Talle: ${talle}
                    - Precio Efectivo: $${precioEfectivo} ARS
                    - Precio de Lista: $${precioLista} ARS
                    - Descripci√≥n: ${descripcion || 'Ninguna'}
                `;
                try {
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                    };
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error(`Error en la API de Gemini: ${response.status} - ${response.statusText}`);
                    }
                    const result = await response.json();
                    const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (generatedText) {
                        if (geminiOutputTitle) geminiOutputTitle.textContent = "Sugerencia de la IA";
                        geminiOutput.value = generatedText;
                        geminiOutputSection.classList.remove('hidden');
                        showAppMessage("Descripci√≥n generada con √©xito.", 'success');
                    } else {
                        throw new Error("La respuesta de la API estaba vac√≠a.");
                    }
                } catch (error) {
                    console.error("Error al llamar a Gemini API:", error);
                    showAppMessage(`Error al generar descripci√≥n: ${error.message}`, 'error');
                } finally {
                    generateDescBtn.disabled = false;
                    generateDescBtn.innerHTML = `‚ú® Generar Descripci√≥n Inteligente`;
                }
            });
        }
        
        // --- L√ìGICA: AN√ÅLISIS DE RIESGO DE STOCK (GEMINI API) ---
        if (analyzeStockRiskBtn) {
            analyzeStockRiskBtn.addEventListener('click', async () => {
                const talle = document.getElementById('talle')?.value;
                const tiposDeRopa = Array.from(document.querySelectorAll('input[name="tipo_ropa"]:checked')).map(cb => cb.value || cb.nextElementSibling?.value || '');

                if (!talle || tiposDeRopa.length === 0) {
                    showAppMessage("Completa Talle y Tipo de Ropa para analizar el riesgo.", 'error');
                    return;
                }

                analyzeStockRiskBtn.disabled = true;
                analyzeStockRiskBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Analizando...`;
                
                // 1. Calculate Local Statistics
                let totalOfSameType = 0;
                let soldOfSameType = 0;
                
                // Find items that share at least one primary type AND the same size
                const targetTypes = tiposDeRopa.map(t => t.toLowerCase().trim());
                const targetTalle = talle.toLowerCase().trim();

                prendas.forEach(p => {
                    const pTalle = (p.talle || '').toLowerCase().trim();
                    const pTypes = (p.tipos_de_ropa || []).map(t => t.toLowerCase().trim());
                    
                    // Check if item matches size AND any of the selected types
                    const typeMatch = pTypes.some(pType => targetTypes.includes(pType));
                    
                    if (typeMatch && pTalle === targetTalle) {
                        totalOfSameType++;
                        if (p.ultimo_escaneo) {
                            soldOfSameType++;
                        }
                    }
                });

                const inStockOfSameType = totalOfSameType - soldOfSameType;
                
                const localStats = `
                    Estad√≠sticas locales para art√≠culos de tipo "${tiposDeRopa.join(' / ')}" en talle "${talle}":
                    - Total de unidades registradas (vendidas + en stock): ${totalOfSameType}
                    - Unidades vendidas (escaneadas): ${soldOfSameType}
                    - Unidades actualmente en stock (no vendidas): ${inStockOfSameType}
                `;
                
                const prompt = `
                    Act√∫a como un analista de riesgo de inventario experto en moda. 
                    Basado en la siguiente informaci√≥n, genera un an√°lisis de riesgo de stock para este tipo de art√≠culo. 
                    El resumen debe ser de 2 a 3 frases y debe concluir con una calificaci√≥n de riesgo: "Riesgo BAJO", "Riesgo MEDIO" o "Riesgo ALTO". 
                    Justifica tu calificaci√≥n de riesgo bas√°ndote en la proporci√≥n de stock vs. vendido. Si el total es 0, indica que no hay datos para analizar.
                    
                    ${localStats}
                `;

                try {
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                    };
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Error en la API de Gemini: ${response.status} - ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar el an√°lisis de riesgo. Intente de nuevo.";
                    
                    // Display result
                    if (geminiOutputTitle) geminiOutputTitle.textContent = "Resumen de Riesgo de Stock (IA)";
                    geminiOutput.value = generatedText;
                    geminiOutputSection.classList.remove('hidden');
                    showAppMessage("An√°lisis de riesgo generado.", 'success');

                } catch (error) {
                    console.error("Error al llamar a Gemini API para an√°lisis de riesgo:", error);
                    if (geminiOutputTitle) geminiOutputTitle.textContent = "Resumen de Riesgo de Stock (IA)";
                    geminiOutput.value = `Error: ${error.message}. No se pudo contactar a la IA.`;
                    geminiOutputSection.classList.remove('hidden');
                    showAppMessage(`Error al generar an√°lisis de riesgo: ${error.message}`, 'error');
                } finally {
                    analyzeStockRiskBtn.disabled = false;
                    analyzeStockRiskBtn.innerHTML = `‚ú® Analizar Riesgo de Stock`;
                }
            });
        }
        
        if (copyDescBtn) {
            copyDescBtn.addEventListener('click', () => {
                geminiOutput.select();
                document.execCommand('copy');
                showAppMessage("Texto copiado al portapapeles.", 'success');
            });
        }
        
        // --- TTS UTILITIES ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; // Int16Array
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcm16.length * bytesPerSample;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            /* RIFF identifier */
            view.setUint32(0, 0x52494646, false); // 'RIFF'
            /* file length */
            view.setUint32(4, 36 + dataSize, true);
            /* RIFF type */
            view.setUint32(8, 0x57415645, false); // 'WAVE'
            /* format chunk identifier */
            view.setUint32(12, 0x666d7420, false); // 'fmt '
            /* format chunk length */
            view.setUint32(16, 16, true);
            /* sample format (raw) */
            view.setUint16(20, 1, true); // PCM = 1
            /* channel count */
            view.setUint16(22, numChannels, true);
            /* sample rate */
            view.setUint32(24, sampleRate, true);
            /* byte rate (sample rate * block align) */
            view.setUint32(28, byteRate, true);
            /* block align (channel count * bytes per sample) */
            view.setUint16(32, blockAlign, true);
            /* bits per sample */
            view.setUint16(34, 16, true); // 16 bits = 2 bytes
            /* data chunk identifier */
            view.setUint32(36, 0x64617461, false); // 'data'
            /* data chunk length */
            view.setUint32(40, dataSize, true);

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }
        
        async function textToSpeech(prendaId) {
            if (isAudioPlaying) {
                showAppMessage("Ya se est√° generando audio. Por favor, espere.", 'info');
                return;
            }

            const prenda = prendas.find(p => p.id === prendaId);
            const ttsButton = document.getElementById(`tts-btn-${prendaId}`);
            if (!prenda || !ttsButton) return;

            // 1. Preparar el texto
            const textToSay = `Atenci√≥n. Prenda registrada: ${prenda.tipos_de_ropa.join(', ')}. Talle: ${prenda.talle}. Precio en efectivo: ${prenda.precioEfectivo} pesos argentinos. Precio de lista: ${prenda.precioLista} pesos. Descripci√≥n adicional: ${prenda.descripcion || 'No se proporcion√≥ descripci√≥n'}.`;

            isAudioPlaying = true;
            ttsButton.disabled = true;
            ttsButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Generando Audio...`;
            showAppMessage("Generando audio de los detalles...", 'info');
            
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: textToSay }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" } // Voz Kore para tono firme
                        }
                    }
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Error en la API de TTS: ${response.status} - ${response.statusText}`);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000; 
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();

                    audio.onended = () => {
                        isAudioPlaying = false;
                        ttsButton.disabled = false;
                        ttsButton.innerHTML = `<i class="fas fa-volume-up mr-2"></i> Escuchar Detalles`;
                        URL.revokeObjectURL(audioUrl);
                        showAppMessage("Reproducci√≥n finalizada.", 'success');
                    };
                    showAppMessage("Reproduciendo detalles...", 'success');
                } else {
                    throw new Error("Respuesta de audio no v√°lida o formato incorrecto.");
                }

            } catch (error) {
                console.error("Error al generar TTS:", error);
                showAppMessage(`Error de audio: ${error.message}`, 'error');
                isAudioPlaying = false;
                ttsButton.disabled = false;
                ttsButton.innerHTML = `<i class="fas fa-volume-up mr-2"></i> Error de Audio`;
            }
        }
        // --- FIN TTS UTILITIES ---

        // --- L√ìGICA DE TRANSFERENCIA QR (NUEVO) ---

        function showTransferQr() {
            showView('transfer-section');
            if(transferTitle) transferTitle.textContent = "üì§ Generar QR de Transferencia";
            if(transferInstructions) transferInstructions.innerHTML = `P√≠dele al dispositivo receptor que seleccione **"Recibir Datos por QR"** y escanea esta pantalla.`;
            if(qrReceiveScannerContainer) qrReceiveScannerContainer.classList.add('hidden');
            if(qrTransferDisplay) qrTransferDisplay.classList.remove('hidden');
            if(largeQrCanvas) largeQrCanvas.innerHTML = ''; // Limpiar el canvas anterior

            const dataString = JSON.stringify(prendas);
            const dataLength = dataString.length;

            if (dataLength > QR_MAX_SIZE) {
                largeQrCanvas.innerHTML = `<p class="text-lg text-red-600 font-bold p-4 border border-red-300 rounded-lg">
                    ‚ö†Ô∏è ¬°Advertencia de Tama√±o!
                    <br>
                    Tu historial es demasiado grande (${dataLength} caracteres) y podr√≠a fallar al escanearse.
                    <br>
                    Para evitar fallos de escaneo, usa la opci√≥n de **Descargar Backup (JSON)** y env√≠alo por email o WhatsApp.
                </p>`;
                showAppMessage("El historial es demasiado grande para un QR confiable, pero se generar√° de todas formas.", 'warning');
            }

            try {
                new QRCode(largeQrCanvas, {
                    text: dataString,
                    width: 256,
                    height: 256,
                    colorDark: "#4f46e5", // Indigo 600
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H // High error correction
                });
                showAppMessage("QR de transferencia generado. Escanea con el dispositivo receptor.", 'info');
            } catch (error) {
                console.error("Error al generar QR de transferencia:", error);
                largeQrCanvas.innerHTML = `<p class="text-red-500">Error al generar el QR. Intenta con el backup JSON.</p>`;
                showAppMessage("Error al generar el QR. Verifica el tama√±o de tus datos.", 'error');
            }
        }

        function startReceiveScanner() {
            showView('transfer-section');
            if(transferTitle) transferTitle.textContent = "üì• Recibir Datos por QR";
            if(transferInstructions) transferInstructions.innerHTML = `Escanea el QR de transferencia que te muestre el dispositivo emisor.`;
            if(qrTransferDisplay) qrTransferDisplay.classList.add('hidden');
            if(qrReceiveScannerContainer) qrReceiveScannerContainer.classList.remove('hidden');
            document.getElementById('receive-status').textContent = 'Esc√°ner activo. Apunta la c√°mara.';

            if (!receiverReader) return; // Asegurar que el elemento existe

            if (!html5QrCodeReceiver) {
                html5QrCodeReceiver = new Html5Qrcode("receiver-reader");
            }
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCodeReceiver.start({ facingMode: "environment" }, config, onReceiveScanSuccess, onReceiveScanFailure)
                .then(() => {
                    showAppMessage("Esc√°ner de recepci√≥n iniciado.", 'info');
                    if(stopReceiveScanBtn) stopReceiveScanBtn.classList.remove('hidden');
                })
                .catch(err => {
                    console.error("Error al iniciar esc√°ner de recepci√≥n:", err);
                    document.getElementById('receive-status').textContent = 'Error: No se pudo iniciar la c√°mara.';
                    showAppMessage("No se pudo iniciar la c√°mara para recibir.", 'error');
                });
        }

        function stopReceiveScanner(goBack = true) {
            if (html5QrCodeReceiver && html5QrCodeReceiver.isScanning) {
                html5QrCodeReceiver.stop().catch(err => console.log("Error al detener esc√°ner de recepci√≥n:", err));
                if(stopReceiveScanBtn) stopReceiveScanBtn.classList.add('hidden');
            }
            if(goBack) {
                showView('history-section');
            }
        }

        function onReceiveScanSuccess(decodedText, decodedResult) {
            stopReceiveScanner(false); // Detener el scanner, pero no volver al historial a√∫n

            document.getElementById('receive-status').textContent = 'QR detectado. Procesando datos...';
            showAppMessage("Datos recibidos. Procesando y fusionando historial...", 'info');

            try {
                const importedPrendas = JSON.parse(decodedText);
                if (!Array.isArray(importedPrendas)) throw new Error("Formato de datos QR incorrecto.");
                
                // Usar la funci√≥n de merge ya existente
                const addedCount = mergePrendas(importedPrendas);

                document.getElementById('receive-status').innerHTML = `<i class="fas fa-check-circle text-green-500 mr-2"></i> ¬°Transferencia exitosa! ${addedCount} prendas a√±adidas.`;
                showAppMessage(`Transferencia QR exitosa. ${addedCount} prendas a√±adidas.`, 'success');

                // Vuelve al historial autom√°ticamente despu√©s de un breve retraso
                setTimeout(() => showView('history-section'), 2000);

            } catch (error) {
                console.error("Error al procesar datos del QR de transferencia:", error);
                document.getElementById('receive-status').innerHTML = `<i class="fas fa-times-circle text-red-500 mr-2"></i> Error: ${error.message}`;
                showAppMessage(`Error en la recepci√≥n QR: ${error.message}. Usa el backup JSON.`, 'error');
                
                // Mostrar el bot√≥n de reintento/detener si hay un fallo
                if(stopReceiveScanBtn) stopReceiveScanBtn.classList.remove('hidden');
            }
        }

        function onReceiveScanFailure(error) {
            // Silencioso, solo muestra el error en la consola
        }

        // --- FIN L√ìGICA DE TRANSFERENCIA QR ---

        // --- L√ìGICA DE GENERACI√ìN DE QR (ACTUALIZADA PARA INCLUIR IMAGEN Y BOT√ìN TTS) ---
        if (qrForm) {
            qrForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(qrForm);
                const tiposDeRopa = Array.from(document.querySelectorAll('input[name="tipo_ropa"]:checked')).map(cb => cb.value || cb.nextElementSibling?.value || '');
                if (tiposDeRopa.length === 0) {
                    showAppMessage("Debes seleccionar al menos un tipo de ropa.", "error");
                    return;
                }
                const prendaId = crypto.randomUUID();
                const prendaData = {
                    id: prendaId,
                    precioEfectivo: formData.get('precioEfectivo'),
                    precioLista: formData.get('precioLista'),
                    talle: formData.get('talle'),
                    tipos_de_ropa: tiposDeRopa,
                    vendedora: formData.get('vendedora') || '',
                    descripcion: formData.get('descripcion') || '',
                    fecha_creacion: new Date().toISOString(),
                    ultimo_escaneo: null,
                    dias_transcurridos: 0,
                    fotoBase64: currentPhotoBase64,
                    manual_sale_reason: null, // Inicializa la raz√≥n de venta manual
                    vendido: false // Nuevo campo para sincronizaci√≥n
                };
                try {
                    console.log("[Registro] Guardando prenda con ID:", prendaId);
                    prendas.push(prendaData);
                    savePrendasToStorage();
                    console.log("[Registro] Prenda guardada en localStorage.");
                    showAppMessage("Prenda guardada localmente con √©xito.", 'success');
                    generateQrCode(prendaId, qrDisplay); // Usamos qrDisplay para la secci√≥n de Generaci√≥n
                    // sendPushNotification("Nueva prenda registrada", `Se ha generado un QR con ID: ${prendaId}`); // Revisitar notif.
                    qrForm.reset();
                    resetCustomTipos();
                    
                    // Limpiar estado de foto despu√©s de guardar
                    currentPhotoBase64 = null;
                    const cameraInput = document.getElementById('camera-photo-input'); 
                    const importInput = document.getElementById('import-photo-input'); 
                    const photoPreviewContainer = document.getElementById('photo-preview-container');
                    if (cameraInput) cameraInput.value = '';
                    if (importInput) importInput.value = '';
                    if (photoPreviewContainer) photoPreviewContainer.classList.add('hidden');

                    if (geminiOutputSection) geminiOutputSection.classList.add('hidden');
                } catch (error) {
                    console.error("[Registro] Error al guardar prenda:", error);
                    showAppMessage(`Error al guardar la prenda: ${error.message}`, 'error');
                }
            });
        }

        // Funci√≥n unificada para generar y mostrar el QR (CORRECCI√ìN CLAVE AQU√ç)
        function generateQrCode(prendaId, containerElement) {
            if (!containerElement) return;

            // Limpiar el contenedor anterior y mostrar
            containerElement.innerHTML = '';
            containerElement.classList.remove('hidden');

            const prenda = prendas.find(p => p.id === prendaId);
            if (!prenda) return;

            console.log(`[QR Detalle] Generando QR para ID: ${prendaId} en contenedor: ${containerElement.id}`);

            // 1. Crear y establecer el HTML (esto inserta todos los elementos con IDs en el DOM)
            const imageHtml = prenda.fotoBase64 ? 
                `<div class="mb-4 flex justify-center">
                    <img src="${prenda.fotoBase64}" alt="Foto de la Prenda" class="w-full max-h-48 object-contain rounded-lg shadow-md border border-gray-300 dark:border-gray-600">
                </div>` : 
                '';

            containerElement.innerHTML = `
                ${imageHtml}
                <h3 class="font-bold text-lg mb-4 text-gray-800 dark:text-gray-100">C√≥digo QR Generado para ID: ${prendaId.substring(0, 8)}...</h3>
                <div class="flex justify-center items-center gap-6 flex-wrap">
                    <div id="qrcode-canvas-${prendaId}" class="flex-shrink-0"></div>
                    <div class="mt-4 text-gray-700 dark:text-gray-300 text-left mx-auto max-w-sm flex-grow">
                        <p><strong>Precio Efectivo:</strong> $${prenda.precioEfectivo}</p>
                        <p><strong>Precio de Lista:</strong> $${prenda.precioLista}</p>
                        <p><strong>Talle:</strong> ${prenda.talle}</p>
                        <p><strong>Tipo de Ropa:</strong> ${prenda.tipos_de_ropa.join(', ')}</p>
                        <p><strong>Descripci√≥n:</strong> ${prenda.descripcion || 'Sin descripci√≥n'}</p>
                    </div>
                </div>
                
                <!-- BOT√ìN TTS -->
                <div class="mt-6 flex justify-center">
                    <button id="tts-btn-${prendaId}" data-id="${prendaId}" class="qr-action-btn py-2 px-4 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition" ${isAudioPlaying ? 'disabled' : ''}>
                        <i class="fas fa-volume-up mr-2"></i> Escuchar Detalles
                    </button>
                </div>

                <p class="text-sm text-gray-500 dark:text-gray-400 mt-4 mb-2 font-semibold">Opciones de acci√≥n:</p>
                <div class="flex flex-col md:flex-row justify-center gap-3 mt-2">
                    <button id="download-btn-${prendaId}" data-id="${prendaId}" class="qr-action-btn py-2 px-4 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition"><i class="fas fa-download mr-2"></i>Descargar</button>
                    <button id="print-btn-${prendaId}" data-id="${prendaId}" class="qr-action-btn py-2 px-4 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition"><i class="fas fa-print mr-2"></i>Imprimir</button>
                    <button id="share-btn-${prendaId}" data-id="${prendaId}" class="qr-action-btn py-2 px-4 bg-teal-500 text-white font-semibold rounded-lg shadow-md hover:bg-teal-600 transition"><i class="fas fa-share-alt mr-2"></i>Compartir</button>
                </div>`;

            // 2. Generar el QR CODE
            const qrCanvasContainer = document.getElementById(`qrcode-canvas-${prendaId}`);

            if (qrCanvasContainer) {
                try {
                    new QRCode(qrCanvasContainer, {
                        text: prendaId,
                        width: 180,
                        height: 180,
                        // Configurar colores del QR para dark mode si es necesario
                        colorDark: body.classList.contains('dark') ? "#ffffff" : "#000000",
                        colorLight: body.classList.contains('dark') ? "#1f2937" : "#ffffff", // gris-800 o blanco
                    });
                    console.log("[QR Detalle] QR generado en canvas.");
                } catch (error) {
                    console.error("[QR Detalle] Error al generar QR:", error);
                    qrCanvasContainer.innerHTML = '<p class="text-red-500">Error al generar QR</p>';
                    showAppMessage("Error al generar el c√≥digo QR visualmente.", 'error');
                }
            } else {
                    console.error("[QR Detalle] Error: El contenedor del QR no se encontr√≥ en el DOM.");
                    showAppMessage("Error: Elemento de visualizaci√≥n de QR no encontrado.", 'error');
            }

            // 3. Adjuntar los listeners DE FORMA AS√çNCRONA (Garantiza que el DOM est√° listo)
            setTimeout(() => {
                const ttsBtn = document.getElementById(`tts-btn-${prendaId}`);
                const downloadBtn = document.getElementById(`download-btn-${prendaId}`);
                const printBtn = document.getElementById(`print-btn-${prendaId}`);
                const shareBtn = document.getElementById(`share-btn-${prendaId}`);

                if (ttsBtn) ttsBtn.addEventListener('click', () => textToSpeech(prendaId));
                if (downloadBtn) downloadBtn.addEventListener('click', () => downloadCode(prendaId));
                if (printBtn) printBtn.addEventListener('click', () => printCode(prendaId));
                if (shareBtn) shareBtn.addEventListener('click', () => shareQrImage(prendaId));

                console.log("[QR Detalle] Listeners de acci√≥n adjuntados.");
            }, 0); // La clave es 0ms para diferir hasta el final del ciclo.
        }


        function getQrCanvas(prendaId) {
            // Busca el canvas dentro del contenedor din√°mico por su ID √∫nico
            const canvas = document.querySelector(`#qrcode-canvas-${prendaId} canvas`);
            if (!canvas) {
                console.error(`[Acci√≥n] No se encontr√≥ el canvas para el ID ${prendaId}.`);
            }
            return canvas;
        }

        // *** L√ìGICA DE DESCARGA - FOTO EXCLUIDA ***
        function downloadCode(prendaId) {
            const prenda = prendas.find(p => p.id === prendaId);
            const canvas = getQrCanvas(prendaId);
            if (!canvas || !prenda) {
                showAppMessage("Error: No se encontr√≥ el QR para descargar. Aseg√∫rate de que el QR est√© visible.", 'error');
                return;
            }
            // Crear un canvas combinado para incluir SOLO el QR y el texto
            const combinedCanvas = document.createElement('canvas');
            const ctx = combinedCanvas.getContext('2d');
            // Dimensiones fijas para QR + texto
            combinedCanvas.width = canvas.width + 50; 
            combinedCanvas.height = canvas.height + 140; 
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, combinedCanvas.width, combinedCanvas.height);
            
            // 1. Dibujar QR centrado (empezando arriba)
            const qrX = (combinedCanvas.width - canvas.width) / 2;
            let currentY = 10;
            ctx.drawImage(canvas, qrX, currentY);
            currentY += canvas.height + 30;

            // 2. Dibujar Texto
            ctx.fillStyle = '#000000';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            const infoText = `ID: ${prendaId.substring(0, 8)}...\nPrecio Efectivo: $${prenda.precioEfectivo}\nPrecio de Lista: $${prenda.precioLista}\nTalle: ${prenda.talle}\nTipo: ${prenda.tipos_de_ropa.join(', ')}`;
            const lines = infoText.split('\n');
            lines.forEach((line, index) => {
                ctx.fillText(line, combinedCanvas.width / 2, currentY + index * 20);
            });
            
            const link = document.createElement('a');
            link.href = combinedCanvas.toDataURL('image/png');
            link.download = `qr-prenda-${prendaId}.png`;
            link.click();
            showAppMessage("QR descargado (sin foto).", 'success');
        }

        // *** L√ìGICA DE IMPRESI√ìN - FOTO EXCLUIDA ***
        function printCode(prendaId) {
            const prenda = prendas.find(p => p.id === prendaId);
            const qrCanvas = getQrCanvas(prendaId);
            if (!qrCanvas || !prenda) {
                showAppMessage("Error: No se encontr√≥ el QR para imprimir. Aseg√∫rate de que el QR est√© visible.", 'error');
                return;
            }
            // La imagen HTML se ELIMINA para la impresi√≥n
            const infoText = `Precio Efectivo: $${prenda.precioEfectivo}\nPrecio de Lista: $${prenda.precioLista}\nTalle: ${prenda.talle}\nTipo: ${prenda.tipos_de_ropa.join(', ')}\nDescripci√≥n: ${prenda.descripcion || 'Sin descripci√≥n'}`;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html><head><title>Imprimir QR</title></head>
                <body style="text-align:center; margin-top: 50px;">
                    <img src="${qrCanvas.toDataURL()}" style="max-width: 100%; width: 180px;">
                    <p style="font-size: 14px; margin-top: 20px; white-space: pre-line;">${infoText}</p>
                </body></html>`);
            printWindow.document.close();
            printWindow.onload = () => printWindow.print();
        }

        // *** L√ìGICA DE COMPARTIR - FOTO EXCLUIDA (Solo comparte el QR Canvas y el texto) ***
        async function shareQrImage(prendaId) {
            const prenda = prendas.find(p => p.id === prendaId);
            const canvas = getQrCanvas(prendaId);
            if (!canvas || !prenda) {
                showAppMessage("Error: No se encontr√≥ el QR para compartir. Aseg√∫rate de que el QR est√© visible.", 'error');
                return;
            }
            try {
                // Para compartir se usa solo la imagen QR y el texto informativo
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                const infoText = `Detalles de la Prenda:\nPrecio Efectivo: $${prenda.precioEfectivo}\nPrecio de Lista: $${prenda.precioLista}\nTalle: ${prenda.talle}\nTipo: ${prenda.tipos_de_ropa.join(', ')}\nDescripci√≥n: ${prenda.descripcion || 'Sin descripci√≥n'}`;
                const file = new File([blob], `qr-prenda-${prendaId}.png`, { type: 'image/png' });
                const shareData = {
                    files: [file],
                    title: 'QR de Prenda',
                    text: infoText,
                };
                if (navigator.canShare && navigator.canShare(shareData)) {
                    await navigator.share(shareData);
                    showAppMessage('¬°Compartido con √©xito!', 'success');
                } else {
                    showAppMessage('No se puede compartir la imagen en este navegador. Intenta descargar y compartir manualmente.', 'info');
                }
            } catch (err) {
                console.error("Error al compartir imagen:", err);
                showAppMessage('Error al compartir la imagen.', 'error');
            }
        }

        // --- L√ìGICA DE ESCANEO ---
        function startScanner() {
            if (!document.getElementById('reader')) return;
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader");
            }
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                .catch(err => {
                    console.error("Error al iniciar esc√°ner:", err);
                    showAppMessage("No se pudo iniciar la c√°mara. Revisa permisos.", 'error');
                });
        }

        function stopScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.log("Error al detener esc√°ner:", err));
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            stopScanner();
            const readerDiv = document.getElementById('reader');
            if (readerDiv) readerDiv.style.display = 'none';
            showAppMessage("C√≥digo escaneado. Buscando datos locales...", "info");
            const prendaEncontrada = prendas.find(p => p.id === decodedText);
            if (prendaEncontrada) {
                if (!prendaEncontrada.ultimo_escaneo) {
                    const diasTranscurridos = Math.floor((new Date() - new Date(prendaEncontrada.fecha_creacion)) / (1000 * 60 * 60 * 24));
                    prendaEncontrada.dias_transcurridos = diasTranscurridos;
                }
                prendaEncontrada.ultimo_escaneo = new Date().toISOString();
                prendaEncontrada.manual_sale_reason = null; // Si se escanea, la venta es "normal"
                prendaEncontrada.vendido = true; // Nuevo campo para sincronizaci√≥n
                savePrendasToStorage();
                displayScannedData(prendaEncontrada);
                // sendPushNotification("Prenda escaneada", `Se ha escaneado un QR con ID: ${decodedText}`); // Revisitamos notif.
                showAppMessage("Prenda encontrada en tu historial local.", "success");
            } else {
                if (scanResult) scanResult.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded-lg shadow-md">Prenda no encontrada en tu historial local.</div>`;
                showAppMessage("Prenda no encontrada.", "error");
            }
            const scanAgainBtn = document.createElement('button');
            scanAgainBtn.innerHTML = `<i class="fas fa-qrcode mr-2"></i> Escanear de nuevo`;
            scanAgainBtn.className = 'w-full mt-4 bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-purple-700 transition';
            scanAgainBtn.onclick = () => {
                if (scanResult) scanResult.innerHTML = '';
                if (readerDiv) readerDiv.style.display = 'block';
                startScanner();
            };
            if (scanResult) scanResult.appendChild(scanAgainBtn);
        }

        function onScanFailure(error) {
            // Silencioso
        }

        function displayScannedData(data) {
            const fechaCreacion = new Date(data.fecha_creacion).toLocaleString('es-AR');
            const fechaEscaneo = data.ultimo_escaneo ? new Date(data.ultimo_escaneo).toLocaleString('es-AR') : 'No escaneada a√∫n';
            const diasTranscurridos = data.dias_transcurridos || (data.ultimo_escaneo ? Math.floor((new Date(data.ultimo_escaneo) - new Date(data.fecha_creacion)) / (1000 * 60 * 60 * 24)) : 0);
            
            // Muestra imagen si est√° disponible (S√ç debe aparecer en la vista de escaneo)
            const imageHtml = data.fotoBase64 ? 
                `<div class="mb-4 flex justify-center"><img src="${data.fotoBase64}" alt="Foto de la Prenda" class="w-full max-h-48 object-contain rounded-lg shadow-md border border-gray-300 dark:border-gray-600"></div>` : 
                '';

            if (scanResult) {
                scanResult.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border-t-4 border-indigo-500">
                        ${imageHtml}
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4">Detalle de la Prenda</h2>
                        <div class="space-y-2 text-gray-700 dark:text-gray-300">
                            <p><strong>ID:</strong> ${data.id.substring(0, 8)}...</p>
                            <p><strong>Precio Efectivo:</strong> $${data.precioEfectivo}</p>
                            <p><strong>Precio de Lista:</strong> $${data.precioLista}</p>
                            <p><strong>Talle:</strong> ${data.talle}</p>
                            <p><strong>Tipo de Ropa:</strong> ${data.tipos_de_ropa.join(', ')}</p>
                            <p><strong>Vendedora:</strong> ${data.vendedora || 'No especificada'}</p>
                            <p><strong>Descripci√≥n:</strong> ${data.descripcion || 'Sin descripci√≥n'}</p>
                            <p><strong>Fecha de Registro:</strong> ${fechaCreacion}</p>
                            <p><strong>√öltimo Escaneo:</strong> ${fechaEscaneo}</p>
                            <p><strong>D√≠as transcurridos:</strong> ${diasTranscurridos} d√≠a${diasTranscurridos !== 1 ? 's' : ''}</p>
                        </div>
                    </div>`;
            }
        }

        // --- L√ìGICA DE HISTORIAL (ACTUALIZADA PARA MOSTRAR IMAGEN, QR Y BOT√ìN VENTA MANUAL) ---
        function setupHistoryDisplay() {
            if (!notSoldList || !soldList || !stockCount || !soldSum || !speculationSum || !searchBar) return;
            console.log("Actualizando historial desde localStorage. Prendas:", prendas.length);
            if (prendas.length === 0) {
                notSoldList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">No hay prendas no vendidas.</p>';
                soldList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">No hay prendas vendidas.</p>';
                stockCount.textContent = 'Stock actual: 0';
                soldSum.textContent = 'Vendidos: $0';
                speculationSum.textContent = 'Especulaci√≥n: $0';
                return;
            }
            const searchTerm = searchBar.value.toLowerCase();
            const filteredPrendas = prendas.filter(p =>
                p.id.toLowerCase().includes(searchTerm) ||
                (p.talle || '').toLowerCase().includes(searchTerm) ||
                (p.tipos_de_ropa || []).join(' ').toLowerCase().includes(searchTerm) ||
                (p.vendedora || '').toLowerCase().includes(searchTerm) ||
                (p.descripcion || '').toLowerCase().includes(searchTerm)
            );
            const notSold = filteredPrendas.filter(p => !p.ultimo_escaneo);
            const sold = filteredPrendas.filter(p => p.ultimo_escaneo);
            const stock = notSold.length;
            stockCount.textContent = `Stock actual: ${stock}`;
            const totalNotSold = notSold.reduce((sum, p) => sum + parseFloat(p.precioEfectivo || 0), 0);
            const totalSold = sold.reduce((sum, p) => sum + parseFloat(p.precioEfectivo || 0), 0);
            const speculation = totalNotSold; // Especulaci√≥n es el valor total del stock actual (precio efectivo)
            soldSum.textContent = `Vendidos: $${totalSold.toFixed(2)}`;
            speculationSum.textContent = `Especulaci√≥n: $${speculation.toFixed(2)}`;
            
            // --- NO VENDIDOS (INCLUYE BOT√ìN VENTA MANUAL) ---
            notSoldList.innerHTML = '';
            notSold.forEach((prenda) => {
                const fecha = new Date(prenda.fecha_creacion).toLocaleString('es-AR');
                const diasTranscurridos = Math.floor((new Date() - new Date(prenda.fecha_creacion)) / (1000 * 60 * 60 * 24));
                
                // Preparar HTML para la miniatura de la foto
                const photoThumbHtml = prenda.fotoBase64 ? 
                    `<img src="${prenda.fotoBase64}" alt="Prenda" class="w-12 h-12 object-cover rounded-lg">` : 
                    `<div class="w-12 h-12 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center"><i class="fas fa-camera text-lg text-gray-500 dark:text-gray-400"></i></div>`;

                const item = document.createElement('div');
                // Ajuste de color de fondo y borde para dark mode
                item.className = 'p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 flex items-start';
                item.innerHTML = `
                    <!-- VISUAL BLOCK: Photo and QR -->
                    <div class="flex flex-col items-center mr-4 flex-shrink-0 space-y-1">
                        ${photoThumbHtml}
                        <!-- QR Placeholder (45x45px para ser compacto) -->
                        <div id="qr-thumb-${prenda.id}" class="w-[45px] h-[45px] border border-gray-300 dark:border-gray-600 rounded-sm p-[1px]"></div>
                    </div>
                    
                    <!-- DETAILS AND ACTIONS BLOCK -->
                    <div class="flex-grow">
                        <div class="flex justify-between items-center flex-wrap">
                            <div class="flex-grow min-w-[200px] mb-2 md:mb-0">
                                <p class="font-bold text-indigo-700 dark:text-indigo-400">${prenda.tipos_de_ropa.join(' / ')} - Talle: ${prenda.talle}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-300">Efectivo: $${prenda.precioEfectivo} / Lista: $${prenda.precioLista} - Registrado el ${fecha} (${diasTranscurridos} d√≠a${diasTranscurridos !== 1 ? 's' : ''} sin escanear)</p>
                            </div>
                            <div class="flex gap-2 flex-wrap">
                                <button data-id="${prenda.id}" class="manual-sale-btn bg-red-600 text-white text-sm font-semibold py-1 px-3 rounded-full hover:bg-red-700" title="Registrar venta sin escaneo"><i class="fas fa-hand-pointer"></i> Venta Manual</button>
                                <button class="view-qr-btn bg-indigo-500 text-white text-sm font-semibold py-1 px-3 rounded-full hover:bg-indigo-600" title="Ver QR, Foto y Opciones de Impresi√≥n"><i class="fas fa-qrcode"></i> QR</button>
                                <button class="trend-analyze-btn bg-pink-500 text-white text-sm font-semibold py-1 px-3 rounded-full hover:bg-pink-600">‚ú® Tendencia</button>
                                <button class="strategy-analyze-btn bg-purple-500 text-white text-sm font-semibold py-1 px-3 rounded-full hover:bg-purple-600">‚ú® Estrategia</button>
                                <button class="edit-btn bg-yellow-500 text-white text-sm font-semibold py-1 px-3 rounded-full hover:bg-yellow-600">Editar</button>
                                <button class="delete-btn bg-red-500 text-white text-sm font-semibold py-1 px-3 rounded-full hover:bg-red-600">Eliminar</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // 1. Agregar el elemento a la lista
                notSoldList.appendChild(item); 
                
                // 2. Generar el QR CODE justo despu√©s de agregarlo al DOM
                try {
                    new QRCode(document.getElementById(`qr-thumb-${prenda.id}`), {
                        text: prenda.id,
                        width: 45, // Tama√±o peque√±o para el historial
                        height: 45,
                        // Configurar colores del QR para dark mode si es necesario
                        colorDark: body.classList.contains('dark') ? "#ffffff" : "#000000",
                        colorLight: body.classList.contains('dark') ? "#1f2937" : "#ffffff",
                    });
                } catch (e) {
                    console.error("Error generating QR thumbnail:", e);
                }

                item.querySelector('.edit-btn').addEventListener('click', () => editPrenda(prenda.id));
                item.querySelector('.delete-btn').addEventListener('click', () => {
                    const password = prompt("Ingrese la contrase√±a para eliminar:");
                    if (password === DELETE_PASSWORD) {
                        deletePrenda(prenda.id);
                    } else {
                        showAppMessage("Contrase√±a incorrecta.", 'error');
                    }
                });
                item.querySelector('.strategy-analyze-btn').addEventListener('click', () => analyzeStrategy(prenda.id));
                item.querySelector('.trend-analyze-btn').addEventListener('click', () => analyzeTrend(prenda.id));
                item.querySelector('.view-qr-btn').addEventListener('click', () => viewQr(prenda.id));
                // Venta Manual Listener
                item.querySelector('.manual-sale-btn').addEventListener('click', (e) => showManualSaleModal(prenda.id)); 
            });
            
            // --- VENDIDOS ---
            soldList.innerHTML = '';
            sold.forEach((prenda) => {
                const fecha = new Date(prenda.fecha_creacion).toLocaleString('es-AR');
                const diasTranscurridos = prenda.dias_transcurridos || Math.floor((new Date(prenda.ultimo_escaneo) - new Date(prenda.fecha_creacion)) / (1000 * 60 * 60 * 24));
                
                const reasonDisplay = prenda.manual_sale_reason 
                    ? `<span class="text-red-600 dark:text-red-400 font-bold ml-2">(Manual: ${prenda.manual_sale_reason})</span>`
                    : '';

                // Preparar HTML para la miniatura de la foto
                const photoThumbHtml = prenda.fotoBase64 ? 
                    `<img src="${prenda.fotoBase64}" alt="Prenda" class="w-12 h-12 object-cover rounded-lg opacity-75">` : 
                    `<div class="w-12 h-12 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center opacity-75"><i class="fas fa-camera text-lg text-gray-500 dark:text-gray-400"></i></div>`;
                
                const item = document.createElement('div');
                item.className = 'p-4 bg-green-50 dark:bg-green-900/50 rounded-lg border border-green-300 dark:border-green-700 flex items-start'; // Color verde para vendidos
                item.innerHTML = `
                    <!-- VISUAL BLOCK: Photo and QR -->
                    <div class="flex flex-col items-center mr-4 flex-shrink-0 space-y-1">
                        ${photoThumbHtml}
                    </div>
                    <!-- DETAILS AND ACTIONS BLOCK -->
                    <div class="flex-grow">
                        <div class="flex justify-between items-center flex-wrap">
                            <div class="flex-grow min-w-[200px] mb-2 md:mb-0">
                                <p class="font-bold text-green-700 dark:text-green-400">${prenda.tipos_de_ropa.join(' / ')} - Talle: ${prenda.talle} ${reasonDisplay}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-300">Vendido el ${new Date(prenda.ultimo_escaneo).toLocaleString('es-AR')} - Precio: $${prenda.precioEfectivo}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">D√≠as en stock antes de vender: ${diasTranscurridos} d√≠a${diasTranscurridos !== 1 ? 's' : ''}</p>
                            </div>
                            <div class="flex gap-2 flex-wrap">
                                <button class="delete-btn bg-red-500 text-white text-sm font-semibold py-1 px-3 rounded-full hover:bg-red-600">Eliminar</button>
                            </div>
                        </div>
                    </div>
                `;
                
                soldList.appendChild(item);
                
                item.querySelector('.delete-btn').addEventListener('click', () => {
                    const password = prompt("Ingrese la contrase√±a para eliminar:");
                    if (password === DELETE_PASSWORD) {
                        deletePrenda(prenda.id);
                    } else {
                        showAppMessage("Contrase√±a incorrecta.", 'error');
                    }
                });
            });

            // If no items match the search, show messages
            if (notSold.length === 0 && searchTerm) {
                notSoldList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">No hay coincidencias en stock para la b√∫squeda.</p>';
            } else if (notSold.length === 0 && !searchTerm) {
                notSoldList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">No hay prendas no vendidas.</p>';
            }

            if (sold.length === 0 && searchTerm) {
                soldList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">No hay coincidencias vendidas para la b√∫squeda.</p>';
            } else if (sold.length === 0 && !searchTerm) {
                soldList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">No hay prendas vendidas.</p>';
            }
        } // End of setupHistoryDisplay

        // --- FUNCIONES CRUD Y HELPER FALTANTES ---
        
        function deletePrenda(id) {
            prendas = prendas.filter(p => p.id !== id);
            savePrendasToStorage();
            setupHistoryDisplay();
            showAppMessage(`Prenda ${id.substring(0, 8)}... eliminada.`, 'warning');
            if (reQrSection.classList.contains('hidden') === false) {
                showView('history-section');
            }
        }

        function viewQr(id) {
            showView('re-qr-section');
            generateQrCode(id, reQrDisplay); // Reutilizamos la funci√≥n de generaci√≥n en el contenedor de detalle
            window.scrollTo(0, 0);
        }

        function editPrenda(id) {
            const prenda = prendas.find(p => p.id === id);
            if (!prenda) {
                showAppMessage("Error: Prenda no encontrada para editar.", 'error');
                return;
            }
            editingId = id;
            fillEditForm(prenda);
            showView('edit-section');
            window.scrollTo(0, 0);
        }

        function fillEditForm(prenda) {
            document.getElementById('edit-id').value = prenda.id;
            document.getElementById('edit-precio-efectivo').value = prenda.precioEfectivo;
            document.getElementById('edit-precio-lista').value = prenda.precioLista;
            document.getElementById('edit-talle').value = prenda.talle;
            document.getElementById('edit-vendedora').value = prenda.vendedora;
            document.getElementById('edit-descripcion').value = prenda.descripcion;

            // Cargar foto Base64 en el contexto de edici√≥n (UPDATED)
            currentPhotoBase64 = prenda.fotoBase64 || null;
            const editPreview = document.getElementById('edit-photo-preview');
            const editContainer = document.getElementById('edit-photo-preview-container');

            if (prenda.fotoBase64) {
                if (editPreview) editPreview.src = prenda.fotoBase64;
                if (editContainer) editContainer.classList.remove('hidden');
            } else {
                if (editPreview) editPreview.src = '';
                if (editContainer) editContainer.classList.add('hidden');
            }
            // Limpiar inputs de archivo en la edici√≥n
            document.getElementById('edit-camera-photo-input').value = '';
            document.getElementById('edit-import-photo-input').value = '';


            // Marcar checkboxes de Tipos de Ropa, incluyendo din√°micos
            const container = document.getElementById('edit-tipo-ropa-container');
            if (container) {
                // Eliminar checkboxes din√°micos antiguos primero
                container.querySelectorAll('.custom-checkbox-edit').forEach(el => el.remove());
                
                // 1. Checkear los fijos
                const allCheckboxes = container.querySelectorAll('input[name="tipo_ropa"]');
                allCheckboxes.forEach(cb => cb.checked = false);

                // 2. Agregar como din√°micos si no existen, y marcar todos
                prenda.tipos_de_ropa.forEach(tipo => {
                    let checkbox = Array.from(allCheckboxes).find(cb => cb.value === tipo);
                    if (!checkbox) {
                        // Es un tipo din√°mico, crearlo y a√±adirlo
                        const newId = `edit-tipo_custom_${customTipoCount++}`;
                        const div = document.createElement('div');
                        div.className = 'flex items-center custom-checkbox-edit';
                        div.innerHTML = `
                            <input id="${newId}" name="tipo_ropa" type="checkbox" value="${tipo}" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="${newId}" class="ml-3 block text-sm text-gray-900 dark:text-gray-100">${tipo} (Personalizado)</label>
                            <button type="button" class="remove-custom-btn text-red-500 hover:text-red-700 ml-2 text-xs"><i class="fas fa-times"></i></button>`;
                        container.insertBefore(div, document.getElementById('add-edit-custom-tipo'));
                        checkbox = div.querySelector('input');

                        // Listener para eliminar din√°mico
                        div.querySelector('.remove-custom-btn').addEventListener('click', () => {
                            div.remove();
                            showAppMessage(`Tipo "${tipo}" eliminado.`, 'info');
                        });
                    }
                    // 3. Marcar checkbox (ya sea fijo o din√°mico reci√©n creado)
                    if (checkbox) checkbox.checked = true;
                });
            }
        }

        // Listener para el formulario de edici√≥n (UPDATED para foto)
        if (editForm) {
            editForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveEditedPrenda();
            });
        }

        function saveEditedPrenda() {
            const id = document.getElementById('edit-id').value;
            const index = prendas.findIndex(p => p.id === id);

            if (index === -1) {
                showAppMessage("Error al guardar: Prenda no encontrada.", 'error');
                return;
            }

            const newTipos = Array.from(document.querySelectorAll('#edit-tipo-ropa-container input[name="tipo_ropa"]:checked')).map(cb => cb.value);
            if (newTipos.length === 0) {
                showAppMessage("Debes seleccionar al menos un tipo de ropa.", "error");
                return;
            }

            prendas[index] = {
                ...prendas[index],
                precioEfectivo: document.getElementById('edit-precio-efectivo').value,
                precioLista: document.getElementById('edit-precio-lista').value,
                talle: document.getElementById('edit-talle').value,
                tipos_de_ropa: newTipos,
                vendedora: document.getElementById('edit-vendedora').value,
                descripcion: document.getElementById('edit-descripcion').value,
                fotoBase64: currentPhotoBase64 // Usar el estado global de la foto de edici√≥n
            };

            savePrendasToStorage();
            setupHistoryDisplay();
            showAppMessage(`Prenda ${id.substring(0, 8)}... actualizada.`, 'success');
            showView('history-section');
            resetEditCustomTipos();
        }

        // --- FUNCIONES PARA TIPOS DE ROPA DIN√ÅMICOS ---
        function setupCustomTipoListeners(container, buttonId) {
            const addButton = document.getElementById(buttonId);
            if (addButton) {
                addButton.addEventListener('click', () => {
                    const tipo = prompt("Introduce el nuevo tipo de ropa (ej: 'Vestido de Fiesta'):");
                    if (tipo && tipo.trim() !== '') {
                        const cleanedTipo = tipo.trim();
                        const newId = `${container.id.includes('edit') ? 'edit-' : ''}tipo_custom_${customTipoCount++}`;
                        const div = document.createElement('div');
                        div.className = `flex items-center ${container.id.includes('edit') ? 'custom-checkbox-edit' : 'custom-checkbox'}`;
                        div.innerHTML = `
                            <input id="${newId}" name="tipo_ropa" type="checkbox" value="${cleanedTipo}" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="${newId}" class="ml-3 block text-sm text-gray-900 dark:text-gray-100">${cleanedTipo} (Personalizado)</label>
                            <button type="button" class="remove-custom-btn text-red-500 hover:text-red-700 ml-2 text-xs"><i class="fas fa-times"></i></button>`;
                        
                        container.insertBefore(div, addButton.previousElementSibling); // Insertar antes del bot√≥n

                        div.querySelector('.remove-custom-btn').addEventListener('click', () => div.remove());
                    }
                });
            }
        }

        function resetCustomTipos() {
            const container = document.getElementById('tipo-ropa-container');
            if (container) {
                container.querySelectorAll('.custom-checkbox').forEach(el => el.remove());
                customTipoCount = 0;
            }
        }
        function resetEditCustomTipos() {
            const container = document.getElementById('edit-tipo-ropa-container');
            if (container) {
                container.querySelectorAll('.custom-checkbox-edit').forEach(el => el.remove());
            }
        }


        // --- FUNCIONES DE EXPORTACI√ìN Y REPORTES ---
        function formatPrendasForExport() {
            return prendas.map(p => ({
                ID: p.id,
                'Precio Efectivo': parseFloat(p.precioEfectivo),
                'Precio de Lista': parseFloat(p.precioLista),
                Talle: p.talle,
                'Tipo de Ropa': p.tipos_de_ropa.join(', '),
                Vendedora: p.vendedora,
                Descripci√≥n: p.descripcion,
                'Fecha de Creaci√≥n': new Date(p.fecha_creacion).toLocaleDateString('es-AR'),
                '√öltimo Escaneo (Venta)': p.ultimo_escaneo ? new Date(p.ultimo_escaneo).toLocaleDateString('es-AR') : 'NO VENDIDO',
                Vendido: p.ultimo_escaneo ? 'S√ç' : 'NO',
                'D√≠as en Stock antes de Vender': p.dias_transcurridos || (p.ultimo_escaneo ? Math.floor((new Date(p.ultimo_escaneo) - new Date(p.fecha_creacion)) / (1000 * 60 * 60 * 24)) : 0),
                'Raz√≥n Venta Manual': p.manual_sale_reason || 'N/A'
            }));
        }

        function exportToExcel() {
            const data = formatPrendasForExport();
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventario QR");
            XLSX.writeFile(wb, `Inventario_QR_${new Date().toISOString().slice(0, 10)}.xlsx`);
            showAppMessage("Datos exportados a Excel.", 'success');
        }

        function exportToCsv() {
            const data = formatPrendasForExport();
            if (data.length === 0) {
                showAppMessage("No hay datos para exportar.", 'error');
                return;
            }
            const csv = XLSX.utils.json_to_csv(data);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Inventario_QR_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
            URL.revokeObjectURL(link.href);
            showAppMessage("Datos exportados a CSV.", 'success');
        }

        let stockChartInstance = null;

        function setupMetricsChart() {
            const ctx = document.getElementById('stock-chart').getContext('2d');
            const typeCounts = {};
            const soldTypeCounts = {};

            prendas.forEach(p => {
                p.tipos_de_ropa.forEach(tipo => {
                    typeCounts[tipo] = (typeCounts[tipo] || 0) + 1;
                    if (p.ultimo_escaneo) {
                        soldTypeCounts[tipo] = (soldTypeCounts[tipo] || 0) + 1;
                    }
                });
            });

            const labels = Object.keys(typeCounts);
            const stockData = labels.map(label => typeCounts[label] - (soldTypeCounts[label] || 0));
            const soldData = labels.map(label => soldTypeCounts[label] || 0);

            if (stockChartInstance) {
                stockChartInstance.destroy();
            }

            // Determinar colores para el gr√°fico basado en el tema actual
            const isDark = body.classList.contains('dark');
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const labelColor = isDark ? '#ffffff' : '#000000';


            stockChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'En Stock',
                        data: stockData,
                        backgroundColor: 'rgba(79, 70, 229, 0.7)', // indigo-600
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Vendidos',
                        data: soldData,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)', // red-500
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor },
                            ticks: { color: labelColor }
                        },
                        x: {
                            grid: { color: gridColor },
                            ticks: { color: labelColor }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribuci√≥n de Stock vs. Ventas por Tipo de Prenda',
                            color: labelColor
                        },
                        legend: {
                            labels: {
                                color: labelColor
                            }
                        }
                    }
                }
            });
        }

        function setupCalendarMetrics() {
            const calendarDaysContainer = document.getElementById('calendar-days');
            if (!calendarDaysContainer) return;

            calendarDaysContainer.innerHTML = '';
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 = Sunday, 1 = Monday...
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const activity = {};
            prendas.forEach(p => {
                const creationDate = new Date(p.fecha_creacion);
                if (creationDate.getFullYear() === year && creationDate.getMonth() === month) {
                    const day = creationDate.getDate();
                    activity[day] = activity[day] || { created: 0, sold: 0 };
                    activity[day].created++;
                }
                if (p.ultimo_escaneo) {
                    const soldDate = new Date(p.ultimo_escaneo);
                    if (soldDate.getFullYear() === year && soldDate.getMonth() === month) {
                        const day = soldDate.getDate();
                        activity[day] = activity[day] || { created: 0, sold: 0 };
                        activity[day].sold++;
                    }
                }
            });
            
            // Add padding for the first week
            const startDay = (firstDayOfMonth) % 7; // Ajuste para Domingo (0)
            for (let i = 0; i < startDay; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'p-1';
                calendarDaysContainer.appendChild(emptyDiv);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const data = activity[day] || { created: 0, sold: 0 };
                let colorClass = 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300';
                let tooltip = `D√≠a ${day}:`;
                if (data.created > 0 && data.sold > 0) {
                    colorClass = 'bg-indigo-200 text-indigo-800 border-2 border-indigo-500 font-bold dark:bg-indigo-800 dark:text-indigo-200 dark:border-indigo-400';
                    tooltip += ` ${data.created} Reg. / ${data.sold} Ventas`;
                } else if (data.created > 0) {
                    colorClass = 'bg-green-200 text-green-800 font-semibold dark:bg-green-800 dark:text-green-200';
                    tooltip += ` ${data.created} Registros`;
                } else if (data.sold > 0) {
                    colorClass = 'bg-red-200 text-red-800 font-semibold dark:bg-red-800 dark:text-red-200';
                    tooltip += ` ${data.sold} Ventas`;
                } else {
                    tooltip += ` Sin actividad`;
                }

                if (day === now.getDate()) {
                    colorClass += ' ring-2 ring-offset-1 ring-yellow-500'; // Today highlight
                }
                
                const dayDiv = document.createElement('div');
                dayDiv.className = `p-1 rounded-md text-sm cursor-help ${colorClass}`;
                dayDiv.textContent = day;
                dayDiv.title = tooltip; // Usar title para el tooltip
                calendarDaysContainer.appendChild(dayDiv);
            }
        }

        // --- NOTIFICACIONES Y MENSAJES ---
        function showAppMessage(message, type = 'info', duration = 3000) {
            const container = document.getElementById('app-message');
            if (!container) return;

            const colorMap = {
                success: { bg: 'bg-green-500', icon: 'fas fa-check-circle' },
                error: { bg: 'bg-red-600', icon: 'fas fa-times-circle' },
                warning: { bg: 'bg-yellow-500', icon: 'fas fa-exclamation-triangle' },
                info: { bg: 'bg-blue-500', icon: 'fas fa-info-circle' }
            };

            const style = colorMap[type] || colorMap.info;

            const notification = document.createElement('div');
            notification.className = `${style.bg} text-white p-4 rounded-lg shadow-xl mb-3 flex items-center transform transition duration-500 opacity-0 translate-y-full`;
            notification.innerHTML = `<i class="${style.icon} mr-3"></i> ${message}`;

            container.appendChild(notification);

            // Mostrar la notificaci√≥n
            setTimeout(() => {
                notification.classList.remove('opacity-0', 'translate-y-full');
                notification.classList.add('opacity-100', 'translate-y-0');
            }, 10); // Peque√±o retraso para que la transici√≥n funcione

            // Ocultar y eliminar
            setTimeout(() => {
                notification.classList.remove('opacity-100', 'translate-y-0');
                notification.classList.add('opacity-0', 'translate-y-full');
                setTimeout(() => notification.remove(), 500);
            }, duration);
        }

        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        isPushEnabled = true;
                        console.log("Permiso de notificaciones concedido.");
                    } else {
                        isPushEnabled = false;
                        console.log("Permiso de notificaciones denegado.");
                    }
                });
            }
        }

        // --- INICIO DE LA APLICACI√ìN (MODIFIED) ---
        window.onload = checkLoginStatus;

    </script>

    <!-- Service Worker Placeholder (sw.js - NO GENERADO, solo referenciado para PWA) -->
    <script>
        // Este script es solo un PLACEHOLDER. El Service Worker completo requerir√≠a un archivo sw.js separado
        // y l√≥gica de cacheo y notificaciones push avanzada, que est√° fuera del alcance de un solo archivo HTML.
        // La funcionalidad de PWA (instalaci√≥n) s√≠ est√° implementada.
    </script>
</body>
</html>
