<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crypto & Assets Tracker</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#0f172a" />
  <meta name="description" content="Segu√≠ tus transacciones y ganancias en criptomonedas y activos" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚Çø</text></svg>" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to bottom right, #0f172a, #4c1d95, #0f172a);
      color: white;
      min-height: 100vh;
      padding: 1rem;
    }
    .chart-container {
      width: 100%;
      height: 300px;
    }
    #loadingBar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: #3B82F6;
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.3s ease-in-out;
      z-index: 1000;
    }
    #loadingBar.active {
      transform: scaleX(1);
    }
    #errorMessage {
      display: none;
      background: #ef4444;
      color: white;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      text-align: center;
    }
    #transactionListContainer, #cryptoProfitList, #assetVisibilityList, #portfolioList {
      max-height: 500px;
      overflow-y: auto;
      padding-right: 10px;
    }
    #transactionListContainer::-webkit-scrollbar, #cryptoProfitList::-webkit-scrollbar, #assetVisibilityList::-webkit-scrollbar, #portfolioList::-webkit-scrollbar {
      width: 8px;
    }
    #transactionListContainer::-webkit-scrollbar-track, #cryptoProfitList::-webkit-scrollbar-track, #assetVisibilityList::-webkit-scrollbar-track, #portfolioList::-webkit-scrollbar-track {
      background: #1f2937;
      border-radius: 10px;
    }
    #transactionListContainer::-webkit-scrollbar-thumb, #cryptoProfitList::-webkit-scrollbar-thumb, #assetVisibilityList::-webkit-scrollbar-thumb, #portfolioList::-webkit-scrollbar-thumb {
      background-color: #4c1d95;
      border-radius: 10px;
      border: 2px solid #1f2937;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 15px;
    }
    .calendar-day {
      background-color: #1f2937;
      padding: 10px 5px;
      border-radius: 8px;
      text-align: center;
      font-size: 0.85rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 70px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .calendar-day.empty {
      background-color: #111827;
      visibility: hidden;
    }
    .calendar-day-number {
      font-weight: bold;
      margin-bottom: 5px;
      color: #cbd5e0;
    }
    .calendar-day-profit {
      font-size: 0.75rem;
      font-weight: 600;
      word-break: break-all;
    }
    .calendar-day-profit.positive {
      color: #10B981;
    }
    .calendar-day-profit.negative {
      color: #EF4444;
    }
    .calendar-day-profit.zero {
      color: #9CA3AF;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      font-size: 1.2rem;
      font-weight: bold;
      color: #cbd5e0;
    }
    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      text-align: center;
      font-weight: bold;
      color: #9CA3AF;
      margin-bottom: 5px;
      font-size: 0.8rem;
    }
    .asset-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .asset-card-footer .graph-icon {
      cursor: pointer;
      font-size: 1.5rem;
      transition: transform 0.2s ease;
    }
    .asset-card-footer .graph-icon:hover {
      transform: scale(1.2);
    }
    .nav-button {
      @apply px-3 py-1 text-sm rounded-lg transition-all;
    }
    .nav-button.active {
      @apply bg-blue-600 text-white shadow-lg;
    }
    .nav-button:not(.active) {
      @apply bg-slate-700 hover:bg-slate-600;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: #1f2937;
      padding: 2rem;
      border-radius: 0.75rem;
      max-width: 90%;
      max-height: 90%;
      overflow-y: auto;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 1.5rem;
      cursor: pointer;
    }
    .asset-image-preview {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
      border: 2px solid #4c1d95;
    }
  </style>
</head>
<body>
  <!-- Barra de carga -->
  <div id="loadingBar"></div>

  <div class="max-w-6xl mx-auto">
    <!-- Mensaje de error -->
    <div id="errorMessage"></div>

    <!-- Encabezado con logo -->
    <div class="text-center mb-8">
      <span class="text-4xl">‚Çø</span>
      <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent mb-2">
        CRYPTO & ASSETS TRACKER
      </h1>
      <div class="flex flex-wrap justify-center gap-2 sm:gap-4 mt-4">
        <button id="dashboardBtn" class="nav-button active">
          üìä Dashboard
        </button>
        <button id="assetsBtn" class="nav-button">
          üìà Activos
        </button>
        <button id="profitBtn" class="nav-button">
          üí∞ Profit
        </button>
        <button id="historyBtn" class="nav-button">
          üïí Historial
        </button>
        <button id="chartsBtn" class="nav-button">
          üìâ Gr√°ficos
        </button>
      </div>
    </div>

    <!-- Vista Dashboard -->
    <div id="dashboardView" class="block">
      <!-- Bot√≥n de actualizaci√≥n y fuente de API -->
      <div class="flex justify-between items-center mb-4">
        <button id="refreshPrices" class="px-4 py-2 rounded-lg transition-all bg-green-600 hover:bg-green-700 shadow-md text-white">
          üîÑ Actualizar Precios
        </button>
        <div class="text-sm text-slate-400">Precios de CoinGecko API (Criptos) / Simulados (Acciones)</div>
      </div>

      <!-- Tarjetas de saldo -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-gradient-to-r from-yellow-600 to-orange-600 rounded-xl p-4 shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-sm font-semibold opacity-90">Saldo Total USD</h3>
              <p id="totalUSD" class="text-2xl font-bold">USD 0.00</p>
            </div>
            <span class="h-8 w-8 opacity-75">üíµ</span>
          </div>
        </div>
        <div class="bg-gradient-to-r from-blue-600 to-cyan-600 rounded-xl p-4 shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-sm font-semibold opacity-90">Saldo Total ARS</h3>
              <p id="totalARS" class="text-2xl font-bold">$0</p>
            </div>
            <span class="h-8 w-8 opacity-75">üá¶üá∑</span>
          </div>
        </div>
        <div class="bg-gradient-to-r from-orange-600 to-red-600 rounded-xl p-4 shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-sm font-semibold opacity-90">Saldo Total BTC</h3>
              <p id="totalBTC" class="text-2xl font-bold">‚Çø0.000000</p>
            </div>
            <span class="text-2xl opacity-75">‚Çø</span>
          </div>
        </div>
      </div>

      <!-- Mis Saldos por Activo -->
      <h3 class="text-xl font-semibold mb-4 text-blue-300">Mis Saldos por Activo</h3>
      <div id="individualAssetBalances" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
        <!-- Individual asset balances will be rendered here by JS -->
      </div>

      <!-- Filtro de Cartera -->
      <div class="mb-4">
        <h3 class="text-xl font-semibold mb-2 text-blue-300">Filtrar por Cartera</h3>
        <select id="portfolioFilter" class="bg-slate-800 text-white px-4 py-2 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none shadow-md">
          <option value="all">Todas las Carteras</option>
          <!-- Portfolio options will be populated here -->
        </select>
      </div>

      <!-- Activos en Cartera -->
      <h3 class="text-xl font-semibold mb-4 text-blue-300">Activos en Cartera</h3>
      <div id="allAssetCardsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 mb-6">
        <!-- Asset cards will be rendered here by JS -->
      </div>
      <button id="manageAssetsBtn" class="px-4 py-2 rounded-lg transition-all bg-purple-600 hover:bg-purple-700 shadow-md text-white mb-6">
        ‚öôÔ∏è Gestionar Activos
      </button>

      <!-- Selector de moneda -->
      <div class="mb-6 flex justify-center">
        <select id="currencySelect" class="bg-slate-800 text-white px-4 py-2 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none shadow-md">
          <option value="USD">USD - D√≥lar</option>
          <option value="EUR">EUR - Euro</option>
          <option value="ARS">ARS - Peso Argentino</option>
          <option value="MXN">MXN - Peso Mexicano</option>
          <option value="COP">COP - Peso Colombiano</option>
          <option value="BRL">BRL - Real Brasile√±o</option>
        </select>
      </div>

      <!-- Formulario de transacciones -->
      <div class="bg-slate-800 rounded-xl p-6 mb-6 shadow-lg">
        <h3 class="text-xl font-semibold mb-4 text-blue-300">Registrar Transacci√≥n</h3>
        <input type="hidden" id="editingTransactionId" value="">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
          <select id="transactionType" class="bg-slate-700 text-white px-3 py-2 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
            <option value="compra">Compra</option>
            <option value="venta">Venta</option>
            <option value="comision_compra">Comisi√≥n Compra</option>
            <option value="comision_venta">Comisi√≥n Venta</option>
          </select>
          <select id="transactionAsset" class="bg-slate-700 text-white px-3 py-2 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
            <!-- Options will be populated by JS -->
          </select>
          <input id="transactionAmount" type="number" placeholder="Cantidad" class="bg-slate-700 text-white px-3 py-2 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none" min="0" />
          <input id="transactionPrice" type="number" placeholder="Precio (USD)" class="bg-slate-700 text-white px-3 py-2 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none" min="0" />
          <input id="transactionDate" type="date" class="bg-slate-700 text-white px-3 py-2 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none" value="" />
          <textarea id="transactionNote" placeholder="A√±ade una nota (ej: 'Compra de BTC en Binance')" class="col-span-full bg-slate-700 text-white px-3 py-2 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none" rows="2"></textarea>
          <button id="addTransaction" class="col-span-full md:col-span-1 bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 px-4 py-2 rounded-lg transition-all shadow-md">
            ‚ûï Agregar
          </button>
          <button id="cancelEdit" class="col-span-full md:col-span-1 bg-gradient-to-r from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 px-4 py-2 rounded-lg transition-all shadow-md hidden">
            ‚ùå Cancelar Edici√≥n
          </button>
        </div>
      </div>

      <!-- Tarjetas de profit -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-gradient-to-r from-green-600 to-emerald-600 rounded-xl p-6 shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-lg font-semibold opacity-90">Profit Hoy</h3>
              <p id="todayProfit" class="text-3xl font-bold">USD 0.00</p>
            </div>
            <select id="todayProfitCurrencySelect" class="bg-slate-700 text-white px-2 py-1 rounded-lg text-sm">
              <option value="USD">USD</option>
              <option value="ARS">ARS</option>
              <option value="BTC">BTC</option>
            </select>
          </div>
        </div>
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-6 shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-lg font-semibold opacity-90">Profit Total</h3>
              <p id="totalProfit" class="text-3xl font-bold">USD 0.00</p>
            </div>
            <select id="totalProfitCurrencySelect" class="bg-slate-700 text-white px-2 py-1 rounded-lg text-sm">
              <option value="USD">USD</option>
              <option value="ARS">ARS</option>
              <option value="BTC">BTC</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Vista Activos -->
    <div id="assetsView" class="hidden">
      <h3 class="text-2xl font-semibold mb-4 text-blue-300">Todos Mis Activos</h3>
      <div class="mb-4">
        <select id="assetsPortfolioFilter" class="bg-slate-800 text-white px-4 py-2 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none shadow-md">
          <option value="all">Todas las Carteras</option>
          <!-- Portfolio options will be populated here -->
        </select>
      </div>
      <div id="allAssetsInAssetsView" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 mb-6">
        <!-- All visible asset cards will be rendered here by JS -->
      </div>
    </div>

    <!-- Vista Profit -->
    <div id="profitView" class="hidden">
      <div class="bg-slate-800 rounded-xl p-6 shadow-lg">
        <h3 class="text-2xl font-semibold mb-6 text-blue-300">Ganancias por Activo</h3>
        <div id="cryptoProfitList" class="space-y-4">
          <!-- Crypto and Stock profit details will be rendered here -->
        </div>
      </div>
    </div>

    <!-- Vista Historial -->
    <div id="historyView" class="hidden">
      <div class="bg-slate-800 rounded-xl p-6 shadow-lg">
        <h3 class="text-2xl font-semibold mb-6 text-blue-300">Historial de Transacciones</h3>
        <div id="transactionListContainer" class="space-y-4">
          <div id="transactionList"></div>
        </div>
      </div>
    </div>

    <!-- Vista Gr√°ficos -->
    <div id="chartsView" class="hidden">
      <div class="bg-slate-800 rounded-xl p-6 shadow-lg">
        <h3 class="text-2xl font-semibold mb-6 text-blue-300" id="chartsTitle">Gr√°ficos de Profit</h3>
        <button id="showOverallChartsBtn" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white mb-4 hidden">
          Ver Gr√°ficos Generales
        </button>
        <div id="overallCharts" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div>
            <h4 class="text-lg font-semibold mb-4 text-blue-300">Profit en USD vs Tiempo</h4>
            <div class="chart-container">
              <canvas id="usdChart"></canvas>
            </div>
          </div>
          <div>
            <h4 class="text-lg font-semibold mb-4 text-blue-300">Profit en BTC vs Tiempo</h4>
            <div class="chart-container">
              <canvas id="btcChart"></canvas>
            </div>
          </div>
        </div>
        <div id="individualAssetChartContainer" class="hidden">
          <h4 class="text-lg font-semibold mb-4 text-blue-300" id="individualAssetChartTitle"></h4>
          <div class="chart-container">
            <canvas id="individualAssetChart"></canvas>
          </div>
        </div>
        <h3 class="text-2xl font-semibold mb-6 text-blue-300">Almanaque de Ganancias Diarias</h3>
        <div class="bg-slate-700 rounded-xl p-4 shadow-md">
          <div class="calendar-header">
            <button id="prevMonthBtn" class="px-3 py-1 rounded-lg bg-blue-600 hover:bg-blue-700 text-white">‚Äπ</button>
            <span id="currentMonthYear"></span>
            <button id="nextMonthBtn" class="px-3 py-1 rounded-lg bg-blue-600 hover:bg-blue-700 text-white">‚Ä∫</button>
          </div>
          <div class="calendar-weekdays">
            <span>Dom</span><span>Lun</span><span>Mar</span><span>Mi√©</span><span>Jue</span><span>Vie</span><span>S√°b</span>
          </div>
          <div id="calendarGrid" class="calendar-grid">
            <!-- Calendar days will be rendered here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para Gestionar Activos -->
    <div id="manageAssetsModal" class="modal hidden">
      <div class="modal-content bg-slate-800 text-white rounded-xl p-6 shadow-lg">
        <button class="modal-close text-gray-400 hover:text-white" onclick="closeModal('manageAssetsModal')">√ó</button>
        <h2 class="text-2xl font-semibold mb-4 text-blue-300">Gestionar Activos</h2>
        <!-- Gesti√≥n de Carteras -->
        <div class="mb-6 bg-slate-700 p-4 rounded-lg shadow-inner">
          <h3 class="text-xl font-semibold mb-3">Gestionar Carteras</h3>
          <div class="flex gap-4 mb-4">
            <input type="text" id="newPortfolioName" placeholder="Nombre de la Cartera" class="bg-slate-600 text-white px-3 py-2 rounded-lg border border-slate-500 focus:border-blue-500 focus:outline-none flex-grow" />
            <button id="addPortfolioBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
              ‚ûï A√±adir Cartera
            </button>
          </div>
          <div id="portfolioList" class="space-y-2 max-h-40 overflow-y-auto bg-slate-600 p-3 rounded-lg border border-slate-500">
            <!-- Portfolio list will be rendered here -->
          </div>
        </div>
        <!-- A√±adir Nuevo Activo -->
        <div class="mb-6 bg-slate-700 p-4 rounded-lg shadow-inner">
          <h3 class="text-xl font-semibold mb-3">A√±adir Nuevo Activo Personalizado</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <input type="text" id="newAssetSymbol" placeholder="S√≠mbolo (ej: MYCOIN)" class="bg-slate-600 text-white px-3 py-2 rounded-lg border border-slate-500 focus:border-blue-500 focus:outline-none" />
            <input type="text" id="newAssetName" placeholder="Nombre (ej: Mi Cripto)" class="bg-slate-600 text-white px-3 py-2 rounded-lg border border-slate-500 focus:border-blue-500 focus:outline-none" />
            <select id="newAssetType" class="bg-slate-600 text-white px-3 py-2 rounded-lg border border-slate-500 focus:border-blue-500 focus:outline-none">
              <option value="crypto">Criptomoneda</option>
              <option value="stock">Acci√≥n / CEDEAR</option>
            </select>
            <input type="number" id="newAssetInitialPrice" placeholder="Precio Inicial (USD)" class="bg-slate-600 text-white px-3 py-2 rounded-lg border border-slate-500 focus:border-blue-500 focus:outline-none" min="0" step="0.01" />
            <input type="number" id="newAssetCedearRatio" placeholder="Ratio CEDEAR (solo acciones)" class="bg-slate-600 text-white px-3 py-2 rounded-lg border border-slate-500 focus:border-blue-500 focus:outline-none" min="1" value="1" step="0.1"/>
            <select id="newAssetPortfolio" class="bg-slate-600 text-white px-3 py-2 rounded-lg border border-slate-500 focus:border-blue-500 focus:outline-none">
              <option value="default">Cartera Predeterminada</option>
              <!-- Other portfolios will be populated here -->
            </select>
            <div class="col-span-full">
              <label for="newAssetImage" class="block text-sm font-medium text-slate-300 mb-1">Imagen del activo (opcional):</label>
              <input type="file" id="newAssetImage" accept="image/*" class="block w-full text-sm text-slate-500
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-violet-50 file:text-violet-700
                hover:file:bg-violet-100"/>
              <img id="newAssetImagePreview" class="asset-image-preview mt-2 hidden" src="#" alt="Vista previa de la imagen"/>
              <p class="text-xs text-slate-400 mt-1">Las im√°genes se guardan localmente y pueden ocupar espacio.</p>
            </div>
          </div>
          <button id="addNewAssetBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md w-full">
            ‚ûï A√±adir Activo
          </button>
        </div>
        <!-- Activos Visibles y Carteras -->
        <h3 class="text-xl font-semibold mb-3">Activos Visibles y Carteras</h3>
        <div id="assetVisibilityList" class="space-y-2 max-h-60 overflow-y-auto bg-slate-700 p-3 rounded-lg border border-slate-600">
          <!-- Asset checkboxes with portfolio selection will be rendered here -->
        </div>
        <button id="saveAssetVisibilityBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md w-full mt-4">
          Guardar Cambios
        </button>
      </div>
    </div>
  </div>

  <script>
    // Variables de estado
    let selectedAsset = 'BTC';
    let currency = 'USD';
    let currentView = 'dashboard';
    let transactions = [];
    let editingTransactionId = null;
    let newTransaction = {
      type: 'compra',
      asset: 'BTC',
      amount: '',
      price: '',
      date: new Date().toISOString().split('T')[0],
      note: ''
    };
    let predefinedAssets = {
      BTC: { name: 'Bitcoin', symbol: '‚Çø', price: 0, change: 0, type: 'crypto', color: 'bg-yellow-500' },
      ETH: { name: 'Ethereum', symbol: '‚óä', price: 0, change: 0, type: 'crypto', color: 'bg-gray-500' },
      BNB: { name: 'BNB', symbol: '‚¨¢', price: 0, change: 0, type: 'crypto', color: 'bg-yellow-400' },
      SOL: { name: 'Solana', symbol: 'S', price: 0, change: 0, type: 'crypto', color: 'bg-purple-500' },
      USDT: { name: 'Tether', symbol: '‚ÇÆ', price: 0, change: 0, type: 'crypto', color: 'bg-green-500' },
      AAPL: { name: 'Apple', symbol: 'AAPL', price: 0, change: 0, type: 'stock', cedearRatio: 10, color: 'bg-gray-400' },
      TSLA: { name: 'Tesla', symbol: 'TSLA', price: 0, change: 0, type: 'stock', cedearRatio: 15, color: 'bg-red-500' },
      AMZN: { name: 'Amazon', symbol: 'AMZN', price: 0, change: 0, type: 'stock', cedearRatio: 20, color: 'bg-orange-500' },
      MSFT: { name: 'Microsoft', symbol: 'MSFT', price: 0, change: 0, type: 'stock', cedearRatio: 10, color: 'bg-blue-500' },
      META: { name: 'Meta', symbol: 'META', price: 0, change: 0, type: 'stock', cedearRatio: 10, color: 'bg-purple-600' },
      NVDA: { name: 'NVIDIA', symbol: 'NVDA', price: 0, change: 0, type: 'stock', cedearRatio: 20, color: 'bg-green-600' },
      INTC: { name: 'Intel', symbol: 'INTC', price: 0, change: 0, type: 'stock', cedearRatio: 5, color: 'bg-blue-400' },
      MELI: { name: 'MercadoLibre', symbol: 'MELI', price: 0, change: 0, type: 'stock', cedearRatio: 6, color: 'bg-yellow-600' },
      GLOB: { name: 'Globant', symbol: 'GLOB', price: 0, change: 0, type: 'stock', cedearRatio: 3, color: 'bg-cyan-500' }
    };
    let customAssets = {};
    let allAssets = {};
    let visibleAssets = new Set();
    let assetDisplayModes = {};
    let portfolios = { default: 'Cartera Predeterminada' }; // Default portfolio
    let assetPortfolios = {}; // Stores which portfolio each asset belongs to {symbol: portfolioId}
    let selectedPortfolio = 'all'; // Filter for dashboard/assets view
    let loading = false;
    let usdChart = null;
    let btcChart = null;
    let individualAssetChart = null;
    let currentCalendarDate = new Date();
    let currentAssetChartSymbol = null;
    let newAssetImageBase64 = null; // To store the selected image as Base64

    const exchangeRates = {
      USD: 1,
      EUR: 0.92,
      ARS: 1285, // Updated fallback rate as per user's request
      MXN: 17.0,
      COP: 3900,
      BRL: 5.0,
    };

    // --- Utility Functions ---
    function loadCustomData() {
      const savedCustomAssets = localStorage.getItem('customAssets');
      if (savedCustomAssets) {
        customAssets = JSON.parse(savedCustomAssets);
      }
      const savedVisibleAssets = localStorage.getItem('visibleAssets');
      if (savedVisibleAssets) {
        visibleAssets = new Set(JSON.parse(savedVisibleAssets));
      } else {
        visibleAssets = new Set(Object.keys(predefinedAssets));
      }
      const savedPortfolios = localStorage.getItem('portfolios');
      if (savedPortfolios) {
        portfolios = JSON.parse(savedPortfolios);
      }
      const savedAssetPortfolios = localStorage.getItem('assetPortfolios');
      if (savedAssetPortfolios) {
        assetPortfolios = JSON.parse(savedAssetPortfolios);
      } else {
        // Assign all existing assets to the 'default' portfolio if no specific portfolio data exists
        Object.keys(predefinedAssets).forEach(symbol => {
          assetPortfolios[symbol] = 'default';
        });
      }
      allAssets = { ...predefinedAssets, ...customAssets };
      Object.keys(allAssets).forEach(symbol => {
        assetDisplayModes[symbol] = 'usd';
        // Ensure all assets have a portfolio assigned, default if missing
        if (!assetPortfolios[symbol]) {
            assetPortfolios[symbol] = 'default';
        }
      });
    }

    function saveCustomData() {
      localStorage.setItem('customAssets', JSON.stringify(customAssets));
      localStorage.setItem('visibleAssets', JSON.stringify(Array.from(visibleAssets)));
      localStorage.setItem('portfolios', JSON.stringify(portfolios));
      localStorage.setItem('assetPortfolios', JSON.stringify(assetPortfolios));
    }

    function loadTransactions() {
      const saved = localStorage.getItem('cryptoTransactions');
      if (saved) {
        transactions = JSON.parse(saved);
        updateBalances();
        updateCharts();
        updateTransactionHistory();
        updateCryptoProfitList();
        renderCalendar();
      }
    }

    function saveTransactions() {
      localStorage.setItem('cryptoTransactions', JSON.stringify(transactions));
    }

    function formatCurrency(amount, curr = currency) {
      let convertedAmount = amount * exchangeRates[curr];
      let prefix = '';
      let options = { minimumFractionDigits: 2, maximumFractionDigits: 2 };
      if (curr === 'USD') {
        prefix = 'USD ';
      } else if (curr === 'ARS') {
        prefix = '$';
        // For ARS, divide by 1000 and floor to remove the last three digits for large numbers
        if (convertedAmount >= 1000) {
          convertedAmount = Math.floor(convertedAmount / 1000);
          options = { minimumFractionDigits: 0, maximumFractionDigits: 0 };
        }
      } else if (curr === 'EUR') {
        prefix = '‚Ç¨';
      } else if (curr === 'MXN' || curr === 'COP') {
        prefix = '$';
      } else if (curr === 'BRL') {
        prefix = 'R$';
      }
      return `${prefix}${convertedAmount.toLocaleString('es-ES', options)}`;
    }

    function formatBTC(amount) {
      return `‚Çø${amount.toFixed(6)}`;
    }

    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => { errorEl.style.display = 'none'; }, 5000);
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
      document.getElementById(modalId).classList.remove('flex'); // Ensure flex is removed
    }

    // --- API and UI Update Functions ---
    async function fetchAssetPrices() {
      if (loading) return;
      loading = true;
      document.getElementById('refreshPrices').textContent = 'Actualizando...';
      document.getElementById('refreshPrices').disabled = true;
      document.getElementById('loadingBar').classList.add('active');
      try {
        // Fetch crypto prices from CoinGecko
        const cryptoResponse = await fetch(
          'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,binancecoin,solana,tether,num-ars&vs_currencies=usd&include_24hr_change=true'
        );
        if (!cryptoResponse.ok) throw new Error('Error al obtener datos de CoinGecko para criptos');
        const cryptoData = await cryptoResponse.json();

        // Update predefined crypto details
        Object.keys(predefinedAssets).forEach(symbol => {
          if (predefinedAssets[symbol].type === 'crypto') {
            const cgId = {
              BTC: 'bitcoin', ETH: 'ethereum', BNB: 'binancecoin', SOL: 'solana', USDT: 'tether'
            }[symbol];
            if (cryptoData[cgId]) {
              predefinedAssets[symbol].price = cryptoData[cgId].usd || 0;
              predefinedAssets[symbol].change = cryptoData[cgId].usd_24h_change || 0;
            }
          }
        });

        // Update ARS exchange rate if NUM ARS data is available, otherwise use fallback
        if (cryptoData['num-ars'] && cryptoData['num-ars'].usd > 0) {
          // If 1 NUM ARS = X USD, then 1 USD = 1/X ARS
          exchangeRates.ARS = 1 / cryptoData['num-ars'].usd; 
        } else {
          console.warn('No se pudo obtener el precio de NUM ARS, usando tasa predeterminada de 1285.');
          exchangeRates.ARS = 1285; // Fallback to a fixed rate as per user's request
        }

        // Simulate stock prices and changes for predefined stocks
        Object.keys(predefinedAssets).forEach(symbol => {
          if (predefinedAssets[symbol].type === 'stock') {
            const currentPrice = predefinedAssets[symbol].price > 0 ? predefinedAssets[symbol].price : (Math.random() * 200 + 50);
            const dailyChange = (Math.random() - 0.5) * 10;
            predefinedAssets[symbol].price = Math.max(0.01, currentPrice * (1 + dailyChange / 100));
            predefinedAssets[symbol].change = dailyChange;
          }
        });

        // Simulate stock prices for custom stocks and ensure custom cryptos have initial price/change
        Object.keys(customAssets).forEach(symbol => {
          if (customAssets[symbol].type === 'stock') {
            const currentPrice = customAssets[symbol].price > 0 ? customAssets[symbol].price : (Math.random() * 200 + 50);
            const dailyChange = (Math.random() - 0.5) * 10;
            customAssets[symbol].price = Math.max(0.01, currentPrice * (1 + dailyChange / 100));
            customAssets[symbol].change = dailyChange;
          } else if (customAssets[symbol].type === 'crypto' && !customAssets[symbol].price) {
            // Ensure custom cryptos have a price and change, if not set by user
            customAssets[symbol].price = customAssets[symbol].price || 0;
            customAssets[symbol].change = 0;
          }
        });

        // Recombine all assets (predefined with updated prices + custom assets)
        allAssets = { ...predefinedAssets, ...customAssets };

        updateAssetDisplay();
        updateTransactionFormPrice();
        updateBalances();
        updateCryptoProfitList();
        renderIndividualBalances();
        updateCharts();
        renderCalendar();
      } catch (error) {
        console.error('Error al obtener precios de activos:', error);
        showError('No se pudieron actualizar los precios. Verifica tu conexi√≥n.');
      } finally {
        loading = false;
        document.getElementById('refreshPrices').textContent = 'üîÑ Actualizar Precios';
        document.getElementById('refreshPrices').disabled = false;
        document.getElementById('loadingBar').classList.remove('active');
      }
    }

    function updateAssetDisplay() {
      const dashboardContainer = document.getElementById('allAssetCardsContainer');
      const assetsViewContainer = document.getElementById('allAssetsInAssetsView');
      dashboardContainer.innerHTML = '';
      assetsViewContainer.innerHTML = '';

      // Filter assets based on visibility and selected portfolio
      const assetsToDisplay = Object.entries(allAssets).filter(([symbol]) => {
        if (!visibleAssets.has(symbol)) return false;
        if (selectedPortfolio === 'all') return true;
        return assetPortfolios[symbol] === selectedPortfolio;
      });

      assetsToDisplay.forEach(([symbol, details]) => {
        const cardHtml = createAssetCardHtml(symbol, details);
        dashboardContainer.innerHTML += cardHtml;
        assetsViewContainer.innerHTML += cardHtml;
      });

      // Populate portfolio filters in dashboard and assets views
      const portfolioFilter = document.getElementById('portfolioFilter');
      const assetsPortfolioFilter = document.getElementById('assetsPortfolioFilter');
      [portfolioFilter, assetsPortfolioFilter].forEach(filter => {
        filter.innerHTML = '<option value="all">Todas las Carteras</option>'; // Always include 'All Portfolios'
        Object.entries(portfolios).sort(([, nameA], [, nameB]) => nameA.localeCompare(nameB)).forEach(([id, name]) => {
          const option = document.createElement('option');
          option.value = id;
          option.textContent = name;
          filter.appendChild(option);
        });
        filter.value = selectedPortfolio; // Set the current selected portfolio
      });

      // Attach event listeners for newly created buttons and graph icons
      const containers = [dashboardContainer, assetsViewContainer];
      containers.forEach(container => {
          // Re-attach click and dblclick listeners to the newly created elements
          container.querySelectorAll('.asset-card-button').forEach(button => {
              const symbol = button.dataset.assetSymbol;
              // Single click to cycle display mode
              button.addEventListener('click', () => {
                  cycleAssetCardDisplay(symbol);
              });
              // Double click to show chart
              button.addEventListener('dblclick', (event) => {
                  event.stopPropagation(); // Prevent single click from firing
                  showAssetChart(symbol);
              });
          });

          // Re-attach graph icon listeners
          container.querySelectorAll('.graph-icon').forEach(icon => {
              icon.addEventListener('click', (event) => {
                  event.stopPropagation(); // Prevent button click event from firing
                  showAssetChart(icon.dataset.assetSymbol);
              });
          });
      });

      // Update the transaction asset dropdown
      const transactionAssetSelect = document.getElementById('transactionAsset');
      transactionAssetSelect.innerHTML = ''; // Clear existing options
      Object.keys(allAssets).sort().forEach(symbol => { // Sort alphabetically
          // Only add assets that are part of the currently selected portfolio or 'all'
          if (selectedPortfolio === 'all' || assetPortfolios[symbol] === selectedPortfolio) {
              const option = document.createElement('option');
              option.value = symbol;
              option.textContent = allAssets[symbol].name;
              transactionAssetSelect.appendChild(option);
          }
      });
      // Set the selected value in the dropdown, or default to the first available asset
      transactionAssetSelect.value = allAssets[selectedAsset] && (selectedPortfolio === 'all' || assetPortfolios[selectedAsset] === selectedPortfolio) ? selectedAsset : Object.keys(allAssets)[0] || 'BTC';
    }

    // Helper function to create HTML for a single asset card
    function createAssetCardHtml(symbol, details) {
        const priceUSD = details.price;
        let priceARS = priceUSD * exchangeRates.ARS;
        if (details.type === 'stock' && details.cedearRatio) {
            priceARS = priceARS * details.cedearRatio; // Apply CEDEAR ratio for ARS price
        }

        const changeValue = details.change;
        const changeClass = changeValue >= 0 ? 'text-green-400' : 'text-red-400';
        const changeArrow = changeValue >= 0 ? '‚Üë' : '‚Üì';

        // Get current quantity held for the asset
        const assetHoldings = calculateTotalBalance().assetBalances[symbol] || 0;

        // Determine what to display based on assetDisplayModes
        const currentMode = assetDisplayModes[symbol] || 'usd';
        let mainDisplayValue = '';
        let subDisplayValue = '';

        if (currentMode === 'usd') {
            mainDisplayValue = formatCurrency(priceUSD, 'USD');
            subDisplayValue = `${changeArrow}${changeValue.toFixed(2)}%`;
        } else if (currentMode === 'ars') {
            mainDisplayValue = formatCurrency(priceARS, 'ARS');
            subDisplayValue = `${changeArrow}${changeValue.toFixed(2)}%`;
        } else if (currentMode === 'ratio' && details.type === 'stock') {
            mainDisplayValue = `Ratio: ${details.cedearRatio || 1}:1`;
            subDisplayValue = `Precio USD: ${formatCurrency(priceUSD, 'USD')}`;
        } else if (currentMode === 'quantity') {
            mainDisplayValue = `Cant: ${assetHoldings.toFixed(4)}`;
            subDisplayValue = `Valor: ${formatCurrency(assetHoldings * priceUSD, 'USD')}`;
        } else { // Fallback to USD if ratio/quantity not applicable or mode unknown
            mainDisplayValue = formatCurrency(priceUSD, 'USD');
            subDisplayValue = `${changeArrow}${changeValue.toFixed(2)}%`;
        }

        // Use image if available, otherwise use default symbol
        const assetImageHtml = details.image ? `<img src="${details.image}" alt="${details.name}" class="asset-image-preview">` : `<div class="text-2xl mb-1">${details.symbol}</div>`;


        return `
            <button class="asset-card-button p-4 rounded-xl transition-all transform hover:scale-105 shadow-md ${details.color || 'bg-slate-800'} hover:bg-opacity-80"
                    data-asset-symbol="${symbol}" data-display-mode="${currentMode}">
              ${assetImageHtml}
              <div class="font-semibold">${details.name}</div>
              <div id="card-main-display-${symbol}" class="text-sm opacity-75">${mainDisplayValue}</div>
              <div id="card-sub-display-${symbol}" class="text-xs opacity-75 text-slate-300 ${changeClass}">${subDisplayValue}</div>
              <div class="asset-card-footer">
                <span></span>
                <span class="graph-icon" data-asset-symbol="${symbol}" title="Ver gr√°fico de ${details.name}">üìâ</span>
              </div>
            </button>
        `;
    }

    // Cycles the display mode for a single asset card
    function cycleAssetCardDisplay(symbol) {
        const modes = ['usd', 'ars'];
        if (allAssets[symbol].type === 'stock') {
            modes.push('ratio');
        }
        modes.push('quantity');

        let currentIndex = modes.indexOf(assetDisplayModes[symbol]);
        let nextIndex = (currentIndex + 1) % modes.length;
        assetDisplayModes[symbol] = modes[nextIndex];

        // Re-render only the specific card's content
        updateSingleAssetCardDisplay(symbol);
    }

    // Updates the displayed content of a single asset card without re-rendering the whole grid
    function updateSingleAssetCardDisplay(symbol) {
        const cardButton = document.querySelector(`.asset-card-button[data-asset-symbol="${symbol}"]`);
        if (!cardButton) return;

        const details = allAssets[symbol];
        const priceUSD = details.price;
        let priceARS = priceUSD * exchangeRates.ARS;
        if (details.type === 'stock' && details.cedearRatio) {
            priceARS = priceARS * details.cedearRatio;
        }
        const changeValue = details.change;
        const changeClass = changeValue >= 0 ? 'text-green-400' : 'text-red-400';
        const changeArrow = changeValue >= 0 ? '‚Üë' : '‚Üì';
        const assetHoldings = calculateTotalBalance().assetBalances[symbol] || 0;

        const currentMode = assetDisplayModes[symbol];
        let mainDisplayValue = '';
        let subDisplayValue = '';

        if (currentMode === 'usd') {
            mainDisplayValue = formatCurrency(priceUSD, 'USD');
            subDisplayValue = `${changeArrow}${changeValue.toFixed(2)}%`;
        } else if (currentMode === 'ars') {
            mainDisplayValue = formatCurrency(priceARS, 'ARS');
            subDisplayValue = `${changeArrow}${changeValue.toFixed(2)}%`;
        } else if (currentMode === 'ratio' && details.type === 'stock') {
            mainDisplayValue = `Ratio: ${details.cedearRatio || 1}:1`;
            subDisplayValue = `Precio USD: ${formatCurrency(priceUSD, 'USD')}`;
        } else if (currentMode === 'quantity') {
            mainDisplayValue = `Cant: ${assetHoldings.toFixed(4)}`;
            subDisplayValue = `Valor: ${formatCurrency(assetHoldings * priceUSD, 'USD')}`;
        } else { // Fallback
            mainDisplayValue = formatCurrency(priceUSD, 'USD');
            subDisplayValue = `${changeArrow}${changeValue.toFixed(2)}%`;
        }

        cardButton.querySelector(`#card-main-display-${symbol}`).textContent = mainDisplayValue;
        const subDisplayEl = cardButton.querySelector(`#card-sub-display-${symbol}`);
        subDisplayEl.textContent = subDisplayValue;
        subDisplayEl.className = `text-xs opacity-75 text-slate-300 ${changeClass}`; // Update class for color
        cardButton.dataset.displayMode = currentMode; // Update data attribute
    }


    // Update the price field in the transaction form based on the selected asset
    function updateTransactionFormPrice() {
      if (allAssets[selectedAsset]) {
        document.getElementById('transactionPrice').value = allAssets[selectedAsset].price.toString();
      } else {
        document.getElementById('transactionPrice').value = '0'; // Default if asset not found
      }
    }

    // Calculate total balance across all assets in USD, ARS, and BTC equivalent
    function calculateTotalBalance() {
      const assetBalances = {};
      Object.keys(allAssets).forEach(symbol => {
          assetBalances[symbol] = 0;
      });

      transactions.forEach(t => {
        if (assetBalances[t.asset] !== undefined) { // Ensure the asset is tracked
            if (t.type === 'compra' || t.type === 'comision_compra') assetBalances[t.asset] += parseFloat(t.amount);
            else if (t.type === 'venta' || t.type === 'comision_venta') assetBalances[t.asset] -= parseFloat(t.amount);
        }
      });

      // Calculate total USD value of all asset holdings
      const totalUSD = Object.entries(assetBalances).reduce((total, [assetSymbol, amount]) => {
        const details = allAssets[assetSymbol];
        if (details) {
            return total + (amount * details.price); // Price is always in USD
        }
        return total;
      }, 0);

      return {
        usd: totalUSD,
        ars: totalUSD * exchangeRates.ARS, // Convert total USD to ARS
        btc: allAssets.BTC && allAssets.BTC.price > 0 ? totalUSD / allAssets.BTC.price : 0, // Convert total USD to BTC equivalent
        assetBalances // Return individual asset balances as well
      };
    }

    // Update the display of total balances (USD, ARS, BTC)
    function updateBalances() {
      const balances = calculateTotalBalance();
      document.getElementById('totalUSD').textContent = formatCurrency(balances.usd, 'USD');
      document.getElementById('totalARS').textContent = formatCurrency(balances.ars, 'ARS');
      document.getElementById('totalBTC').textContent = `‚Çø${balances.btc.toFixed(6)}`;
      updateProfit(); // Also update profit display
    }

    // Render individual asset balances
    function renderIndividualBalances() {
        const container = document.getElementById('individualAssetBalances');
        container.innerHTML = '';
        const balances = calculateTotalBalance().assetBalances;

        const assetsWithBalance = Object.entries(balances).filter(([, amount]) => amount > 0.000001); // Filter out negligible balances

        if (assetsWithBalance.length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center py-8 text-slate-400">
                    <span class="text-5xl mb-4 block opacity-50">üí∏</span>
                    <p>No tienes saldos en ning√∫n activo a√∫n.</p>
                </div>
            `;
            return;
        }

        assetsWithBalance.sort(([s1,], [s2,]) => allAssets[s1].name.localeCompare(allAssets[s2].name)).forEach(([symbol, amount]) => {
            const details = allAssets[symbol];
            if (!details) return; // Should not happen if filtered correctly

            const usdValue = amount * details.price;
            const arsValue = usdValue * exchangeRates.ARS;
            const btcValue = allAssets.BTC && allAssets.BTC.price > 0 ? usdValue / allAssets.BTC.price : 0;

            const div = document.createElement('div');
            div.className = `bg-slate-700 rounded-xl p-4 shadow-lg ${details.color ? details.color.replace('bg-', 'bg-opacity-20 border border-') : ''}`; // Add subtle color border
            div.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <div class="text-xl font-bold">${details.name} (${details.symbol})</div>
                    <div class="text-2xl">${details.symbol}</div>
                </div>
                <div class="text-sm text-slate-300 mb-1">Cantidad: <span class="font-semibold">${amount.toFixed(4)}</span></div>
                <div class="text-sm text-slate-300 mb-1">Valor USD: <span class="font-semibold">${formatCurrency(usdValue, 'USD')}</span></div>
                <div class="text-sm text-slate-300 mb-1">Valor ARS: <span class="font-semibold">${formatCurrency(arsValue, 'ARS')}</span></div>
                <div class="text-sm text-slate-300">Valor BTC: <span class="font-semibold">${formatBTC(btcValue)}</span></div>
            `;
            container.appendChild(div);
        });
    }

    // Calculate the average purchase price for each asset
    function calculateAveragePurchasePrice() {
      const assetHoldings = {};
      const totalSpent = {}; // Total USD spent on purchases for each asset
      const totalBought = {}; // Total quantity bought for each asset

      transactions.forEach(t => {
          if (!assetHoldings[t.asset]) {
              assetHoldings[t.asset] = 0;
              totalSpent[t.asset] = 0;
              totalBought[t.asset] = 0;
          }

          if (t.type === 'compra') {
              assetHoldings[t.asset] += parseFloat(t.amount);
              totalSpent[t.asset] += parseFloat(t.total); // total is already in USD
              totalBought[t.asset] += parseFloat(t.amount);
          } else if (t.type === 'venta') {
              assetHoldings[t.asset] -= parseFloat(t.amount);
          } else if (t.type === 'comision_compra' || t.type === 'comision_venta') {
              // Commissions are added to the cost basis of the asset
              totalSpent[t.asset] += parseFloat(t.total);
          }
      });

      const averagePrices = {}; // Average purchase price per unit in USD
      Object.keys(assetHoldings).forEach(asset => {
          if (totalBought[asset] > 0) {
              averagePrices[asset] = totalSpent[asset] / totalBought[asset];
          } else {
              averagePrices[asset] = 0; // No purchases, so average price is 0
          }
      });

      return { averagePrices, assetHoldings };
    }

    // Calculate the total unrealized profit from all assets based on average purchase price
    function calculateTotalProfit() {
      const { averagePrices, assetHoldings } = calculateAveragePurchasePrice();
      const profits = {};
      // Initialize all assets with 0 profit
      Object.keys(allAssets).forEach(asset => {
          const currentPrice = allAssets[asset].price || 0;
          const avgPurchasePrice = averagePrices[asset] || 0;
          const quantity = assetHoldings[asset] || 0;
          profits[asset] = (currentPrice - avgPurchasePrice) * quantity;
      });
      return Object.values(profits).reduce((total, profit) => total + profit, 0);
    }

    // Calculate today's unrealized profit based on 24h change
    function getTodayProfit() {
      const { assetHoldings } = calculateAveragePurchasePrice();
      let todayProfit = 0;
      Object.keys(assetHoldings).forEach(asset => {
        if (assetHoldings[asset] > 0 && allAssets[asset].change) {
          // Calculate the value change based on the 24h percentage change
          const priceChange = allAssets[asset].price * (allAssets[asset].change / 100);
          todayProfit += priceChange * assetHoldings[asset];
        }
      });
      return todayProfit;
    }

    // Update the display of today's profit and total profit
    function updateProfit() {
      const todayProfitElement = document.getElementById('todayProfit');
      const totalProfitElement = document.getElementById('totalProfit');
      const todayProfitCurrency = document.getElementById('todayProfitCurrencySelect').value;
      const totalProfitCurrency = document.getElementById('totalProfitCurrencySelect').value;

      const todayProfitUSD = getTodayProfit(); // Unrealized daily profit
      const totalProfitUSD = calculateTotalProfit(); // Total unrealized profit

      // Convert and display today's profit
      if (todayProfitCurrency === 'BTC' && allAssets.BTC && allAssets.BTC.price > 0) {
          todayProfitElement.textContent = formatBTC(todayProfitUSD / allAssets.BTC.price);
      } else {
          todayProfitElement.textContent = formatCurrency(todayProfitUSD, todayProfitCurrency);
      }

      // Convert and display total profit
      if (totalProfitCurrency === 'BTC' && allAssets.BTC && allAssets.BTC.price > 0) {
          totalProfitElement.textContent = formatBTC(totalProfitUSD / allAssets.BTC.price);
      } else {
          totalProfitElement.textContent = formatCurrency(totalProfitUSD, totalProfitCurrency);
      }
    }

    // Calculate unrealized profit per asset
    function calculateProfitPerAsset() {
        const { averagePrices, assetHoldings } = calculateAveragePurchasePrice();
        const profits = {};
        // Initialize all assets with 0 profit
        Object.keys(allAssets).forEach(asset => {
            const currentPrice = allAssets[asset].price || 0;
            const avgPurchasePrice = averagePrices[asset] || 0;
            const quantity = assetHoldings[asset] || 0;
            profits[asset] = (currentPrice - avgPurchasePrice) * quantity;
        });
        return profits;
    }

    // Update the display of profit per asset
    function updateCryptoProfitList() {
        const cryptoProfitList = document.getElementById('cryptoProfitList');
        cryptoProfitList.innerHTML = ''; // Clear existing list

        const profits = calculateProfitPerAsset(); // Get unrealized profit per asset

        const filteredProfits = Object.entries(profits).filter(([asset]) => {
            if (selectedPortfolio === 'all') return true;
            return assetPortfolios[asset] === selectedPortfolio;
        });

        const sortedProfits = filteredProfits.sort(([,a], [,b]) => b - a); // Sort by profit descending

        if (sortedProfits.length === 0 || sortedProfits.every(([,p]) => Math.abs(p) < 0.000001)) {
            cryptoProfitList.innerHTML = `
                <div class="text-center py-8 text-slate-400">
                    <span class="text-5xl mb-4 block opacity-50">üí∞</span>
                    <p>No hay ganancias registradas por activo a√∫n.</p>
                </div>
            `;
            return;
        }

        sortedProfits.forEach(([asset, profit]) => {
            // Only show assets with non-zero profit for clarity in this list
            if (Math.abs(profit) < 0.000001) return;

            const div = document.createElement('div');
            const profitClass = profit >= 0 ? 'text-green-400' : 'text-red-400';
            const symbolDisplay = allAssets[asset]?.symbol || asset; // Use symbol or just the asset name
            const nameDisplay = allAssets[asset]?.name || asset;
            const portfolioName = portfolios[assetPortfolios[asset]] || 'Sin Cartera'; // Get portfolio name

            div.className = 'bg-slate-700 rounded-lg p-4 flex items-center justify-between shadow-md';
            div.innerHTML = `
                <div class="flex items-center space-x-3">
                    ${allAssets[asset]?.image ? `<img src="${allAssets[asset].image}" alt="${nameDisplay}" class="asset-image-preview w-10 h-10">` : `<span class="text-3xl">${symbolDisplay}</span>`}
                    <div>
                        <div class="font-semibold text-xl">${nameDisplay}</div>
                        <div class="text-xs text-slate-500">Cartera: ${portfolioName}</div>
                    </div>
                </div>
                <div class="font-bold text-2xl ${profitClass}">
                    ${formatCurrency(profit, 'USD')}
                </div>
            `;
            cryptoProfitList.appendChild(div);
        });
    }

    // Get chart data for overall profit or a specific asset (cumulative transaction profit)
    function getChartData(assetSymbol = null) {
        const dailyProfits = {};

        // Calculate daily profit based on transactions
        transactions.forEach(t => {
            const date = t.date; // Date in YYYY-MM-DD format
            if (!assetSymbol || t.asset === assetSymbol) {
                let transactionProfit = 0;
                if (t.type === 'venta') transactionProfit = t.total;
                else if (['compra', 'comision_compra', 'comision_venta'].includes(t.type)) transactionProfit = -t.total;
                dailyProfits[date] = (dailyProfits[date] || 0) + transactionProfit;
            }
        });

        const sortedDates = Object.keys(dailyProfits).sort();
        const newChartData = [];
        let currentCumulativeProfit = 0;
        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0);

        if (sortedDates.length > 0) {
            const firstTransactionDate = new Date(sortedDates[0]);
            firstTransactionDate.setHours(0, 0, 0, 0);
            const dayBeforeFirst = new Date(firstTransactionDate);
            dayBeforeFirst.setDate(dayBeforeFirst.getDate() - 1);
            newChartData.push({ fecha: dayBeforeFirst.toISOString().split('T')[0], profit: 0 });

            let currentDate = new Date(firstTransactionDate);
            while (currentDate <= todayDate) {
                const dateString = currentDate.toISOString().split('T')[0];
                if (dailyProfits[dateString]) {
                    currentCumulativeProfit += dailyProfits[dateString];
                }
                newChartData.push({ fecha: dateString, profit: currentCumulativeProfit });
                currentDate.setDate(currentDate.getDate() + 1);
            }
        } else {
            newChartData.push({ fecha: todayDate.toISOString().split('T')[0], profit: 0 });
        }
        return newChartData;
    }

    // Update Chart.js graphs
    function updateCharts() {
      // Destroy all existing charts
      if (usdChart) usdChart.destroy();
      if (btcChart) btcChart.destroy();
      if (individualAssetChart) individualAssetChart.destroy();

      // Hide/show chart containers based on currentAssetChartSymbol
      const overallChartsContainer = document.getElementById('overallCharts');
      const individualAssetChartContainer = document.getElementById('individualAssetChartContainer');
      const showOverallChartsBtn = document.getElementById('showOverallChartsBtn');
      const chartsTitle = document.getElementById('chartsTitle');

      if (currentAssetChartSymbol) {
          overallChartsContainer.classList.add('hidden');
          individualAssetChartContainer.classList.remove('hidden');
          showOverallChartsBtn.classList.remove('hidden');
          chartsTitle.textContent = `Gr√°fico de Profit: ${allAssets[currentAssetChartSymbol]?.name || currentAssetChartSymbol}`;
          document.getElementById('individualAssetChartTitle').textContent = `Profit en USD de ${allAssets[currentAssetChartSymbol]?.name || currentAssetChartSymbol} vs Tiempo`;

          const assetChartData = getChartData(currentAssetChartSymbol);
          const ctxIndividual = document.getElementById('individualAssetChart').getContext('2d');
          individualAssetChart = new Chart(ctxIndividual, {
              type: 'line',
              data: {
                  labels: assetChartData.map(d => d.fecha),
                  datasets: [{
                      label: `Profit ${allAssets[currentAssetChartSymbol]?.name || currentAssetChartSymbol} (USD)`,
                      data: assetChartData.map(d => d.profit),
                      borderColor: allAssets[currentAssetChartSymbol]?.color || '#3B82F6', // Use asset color if available
                      borderWidth: 3,
                      fill: false,
                      pointRadius: 4,
                      pointBackgroundColor: allAssets[currentAssetChartSymbol]?.color || '#3B82F6'
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                      x: { grid: { color: '#374151' }, ticks: { color: '#cbd5e0' } },
                      y: { grid: { color: '#374151' }, ticks: { color: '#cbd5e0' } }
                  },
                  plugins: {
                      tooltip: {
                          backgroundColor: '#1F2937', borderColor: '#374151', borderWidth: 1, cornerRadius: 8,
                          callbacks: { label: function(context) { return `Profit: ${formatCurrency(context.raw, 'USD')}`; } }
                      },
                      legend: { labels: { color: '#cbd5e0' } }
                  }
              }
          });
      } else {
          overallChartsContainer.classList.remove('hidden');
          individualAssetChartContainer.classList.add('hidden');
          showOverallChartsBtn.classList.add('hidden');
          chartsTitle.textContent = 'Gr√°ficos de Profit';

          const overallChartData = getChartData(); // Get overall data

          // USD Profit Chart
          const ctxUSD = document.getElementById('usdChart').getContext('2d');
          usdChart = new Chart(ctxUSD, {
            type: 'line',
            data: {
              labels: overallChartData.map(d => d.fecha),
              datasets: [{
                label: 'Profit USD',
                data: overallChartData.map(d => d.profit), // Data is already in USD
                borderColor: '#10B981', // Green
                borderWidth: 3,
                fill: false,
                pointRadius: 4,
                pointBackgroundColor: '#10B981'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { grid: { color: '#374151' }, ticks: { color: '#cbd5e0' } },
                y: { grid: { color: '#374151' }, ticks: { color: '#cbd5e0' } }
              },
              plugins: {
                tooltip: {
                  backgroundColor: '#1F2937', borderColor: '#374151', borderWidth: 1, cornerRadius: 8,
                  callbacks: { label: function(context) { return `Profit: ${formatCurrency(context.raw, 'USD')}`; } }
                },
                legend: { labels: { color: '#cbd5e0' } }
              }
            }
          });

          // BTC Profit Chart
          const ctxBTC = document.getElementById('btcChart').getContext('2d');
          btcChart = new Chart(ctxBTC, {
            type: 'line',
            data: {
              labels: overallChartData.map(d => d.fecha),
              datasets: [{
                label: 'Profit BTC',
                data: overallChartData.map(d => allAssets.BTC && allAssets.BTC.price > 0 ? d.profit / allAssets.BTC.price : 0),
                borderColor: '#F59E0B', // Orange
                borderWidth: 3,
                fill: false,
                pointRadius: 4,
                pointBackgroundColor: '#F59E0B'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { grid: { color: '#374151' }, ticks: { color: '#cbd5e0' } },
                y: { grid: { color: '#374151' }, ticks: { color: '#cbd5e0' } }
              },
              plugins: {
                tooltip: {
                  backgroundColor: '#1F2937', borderColor: '#374151', borderWidth: 1, cornerRadius: 8,
                  callbacks: { label: function(context) { return `Profit: ${formatBTC(context.raw)}`; } }
                },
                legend: { labels: { color: '#cbd5e0' } }
              }
            }
          });
      }
    }

    // Function to show a specific asset's chart
    function showAssetChart(assetSymbol) {
        currentAssetChartSymbol = assetSymbol;
        document.getElementById('chartsBtn').click(); // Navigate to charts view
        // updateCharts() will be called by chartsBtn click, and it will render the specific chart
    }

    // Function to show overall charts
    function showOverallCharts() {
        currentAssetChartSymbol = null;
        updateCharts(); // Re-render charts to show overall ones
    }

    // Add or update a transaction
    function saveOrUpdateTransaction() {
      const amount = document.getElementById('transactionAmount').value;
      const price = document.getElementById('transactionPrice').value;
      const note = document.getElementById('transactionNote').value; // Get the note

      if (!amount || !price || parseFloat(amount) <= 0 || parseFloat(price) <= 0) {
        showError('Por favor, completa la cantidad y el precio con valores positivos.');
        return;
      }

      const transactionData = {
        type: document.getElementById('transactionType').value,
        asset: document.getElementById('transactionAsset').value, // Changed from crypto to asset
        amount: parseFloat(amount),
        price: parseFloat(price), // Price is always in USD
        date: document.getElementById('transactionDate').value,
        total: parseFloat(amount) * parseFloat(price), // Total value in USD
        timestamp: new Date().toISOString(), // Timestamp for sorting
        note: note // Save the note
      };

      if (editingTransactionId) {
        // Update existing transaction
        const index = transactions.findIndex(t => t.id === editingTransactionId);
        if (index !== -1) {
          transactions[index] = { ...transactions[index], ...transactionData };
        }
        editingTransactionId = null; // Clear editing state
        document.getElementById('addTransaction').textContent = '‚ûï Agregar'; // Change button back
        document.getElementById('cancelEdit').classList.add('hidden'); // Hide cancel button
      } else {
        // Add new transaction
        transactionData.id = Date.now(); // Assign a unique ID for new transactions
        transactions.unshift(transactionData); // Add to the beginning of the array
      }

      saveTransactions(); // Save to localStorage
      // Clear form inputs
      document.getElementById('transactionAmount').value = '';
      document.getElementById('transactionPrice').value = allAssets[selectedAsset]?.price.toString() || '0';
      document.getElementById('transactionType').value = 'compra';
      document.getElementById('transactionAsset').value = selectedAsset; // Set dropdown to current asset
      document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('transactionNote').value = ''; // Clear note field

      // Update all displays
      updateBalances();
      updateCharts(); // Update charts (overall or specific)
      updateTransactionHistory();
      updateCryptoProfitList(); // Update profit list after transaction
      renderCalendar(); // Re-render calendar
      renderIndividualBalances(); // Update individual balances
      updateAssetDisplay(); // Re-render asset cards to update quantities
    }

    // Function to populate the form for editing a transaction
    function editTransaction(id) {
      const transactionToEdit = transactions.find(t => t.id === id);
      if (transactionToEdit) {
        document.getElementById('editingTransactionId').value = transactionToEdit.id;
        editingTransactionId = transactionToEdit.id;

        document.getElementById('transactionType').value = transactionToEdit.type;
        document.getElementById('transactionAsset').value = transactionToEdit.asset; // Changed to asset
        document.getElementById('transactionAmount').value = transactionToEdit.amount;
        document.getElementById('transactionPrice').value = transactionToEdit.price;
        document.getElementById('transactionDate').value = transactionToEdit.date;
        document.getElementById('transactionNote').value = transactionToEdit.note || ''; // Populate note

        document.getElementById('addTransaction').textContent = '‚úÖ Actualizar';
        document.getElementById('cancelEdit').classList.remove('hidden');

        // Scroll to the top of the dashboard view to show the form
        document.getElementById('dashboardView').scrollIntoView({ behavior: 'smooth' });
        // Switch to dashboard view if not already there
        document.getElementById('dashboardBtn').click();
      }
    }

    // Function to cancel editing and reset the form
    function cancelEdit() {
        editingTransactionId = null;
        document.getElementById('editingTransactionId').value = '';
        document.getElementById('transactionAmount').value = '';
        document.getElementById('transactionPrice').value = allAssets[selectedAsset]?.price.toString() || '0';
        document.getElementById('transactionType').value = 'compra';
        document.getElementById('transactionAsset').value = selectedAsset; // Set dropdown to current asset
        document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('transactionNote').value = ''; // Clear note field
        document.getElementById('addTransaction').textContent = '‚ûï Agregar';
        document.getElementById('cancelEdit').classList.add('hidden');
    }

    // Delete a transaction
    function deleteTransaction(id) {
      transactions = transactions.filter(t => t.id !== id);
      saveTransactions();
      updateBalances();
      updateCharts(); // Update charts (overall or specific)
      updateTransactionHistory();
      updateCryptoProfitList(); // Update profit list after transaction
      renderCalendar(); // Re-render calendar
      renderIndividualBalances(); // Update individual balances
      updateAssetDisplay(); // Re-render asset cards to update quantities
      if (editingTransactionId === id) { // If deleting the currently edited transaction
          cancelEdit();
      }
    }

    // Update the transaction history list display
    function updateTransactionHistory() {
      const transactionList = document.getElementById('transactionList');
      transactionList.innerHTML = ''; // Clear existing list
      if (transactions.length === 0) {
        transactionList.innerHTML = `
          <div class="text-center py-8 text-slate-400">
            <span class="text-5xl mb-4 block opacity-50">üïí</span>
            <p>No hay transacciones registradas.</p>
          </div>
        `;
      } else {
        // Sort transactions by timestamp (most recent first) for display
        transactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(t => {
          const div = document.createElement('div');
          div.className = 'bg-slate-700 rounded-lg p-4 flex flex-col sm:flex-row items-start sm:items-center justify-between shadow-md';
          div.innerHTML = `
            <div class="flex items-center space-x-4 mb-2 sm:mb-0">
              <div class="p-2 rounded-full ${
                t.type === 'compra' || t.type === 'comision_compra' ? 'bg-red-600' :
                t.type === 'venta' ? 'bg-green-600' : 'bg-purple-600'
              }">
                ${t.type === 'compra' ? '‚ûñ' : t.type === 'venta' ? '‚ûï' : 'üíµ'}
              </div>
              <div>
                <div class="font-semibold text-lg">${t.type.replace('_', ' ').toUpperCase()} ${allAssets[t.asset]?.name || t.asset}</div>
                <div class="text-sm text-slate-400">${t.amount} √ó ${formatCurrency(t.price, 'USD')}</div>
                ${t.note ? `<div class="text-xs text-slate-500 mt-1">Nota: ${t.note}</div>` : ''}
              </div>
            </div>
            <div class="text-right flex items-center space-x-2">
              <div>
                <div class="font-semibold text-xl ${t.type === 'compra' || t.type === 'comision_compra' ? 'text-red-400' : 'text-green-400'}">
                  ${t.type === 'compra' || t.type === 'comision_compra' ? '-' : '+'}${formatCurrency(t.total, 'USD')}
                </div>
                <div class="text-sm text-slate-400 flex items-center justify-end">
                  üóìÔ∏è ${new Date(t.date).toLocaleDateString('es-ES')}
                </div>
              </div>
              <button class="edit-btn bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full mr-2" data-id="${t.id}" title="Editar">
                ‚úèÔ∏è
              </button>
              <button class="delete-btn bg-red-600 hover:bg-red-700 text-white p-2 rounded-full" data-id="${t.id}" title="Eliminar">
                üóëÔ∏è
              </button>
            </div>
          `;
          transactionList.appendChild(div);
        });
        // Add event listeners for delete and edit buttons
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = parseInt(btn.getAttribute('data-id'));
            deleteTransaction(id);
          });
        });
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = parseInt(btn.getAttribute('data-id'));
            editTransaction(id);
          });
        });
      }
    }

    // --- Calendar Functions ---

    function getDailyProfits() {
        const dailyProfits = {};
        transactions.forEach(t => {
            const date = t.date; // Date in YYYY-MM-DD format
            let profit = 0;
            if (t.type === 'venta') profit = t.total;
            else if (['compra', 'comision_compra', 'comision_venta'].includes(t.type)) profit = -t.total;
            
            dailyProfits[date] = (dailyProfits[date] || 0) + profit;
        });
        return dailyProfits;
    }

    function renderCalendar() {
        const calendarGrid = document.getElementById('calendarGrid');
        calendarGrid.innerHTML = ''; // Clear existing calendar
        
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        
        document.getElementById('currentMonthYear').textContent = `${monthNames[month]} ${year}`;

        // Get the first day of the month (0 = Sunday, 1 = Monday, ...)
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        // Get the number of days in the current month
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const dailyProfits = getDailyProfits();

        // Add empty cells for days before the 1st of the month
        for (let i = 0; i < firstDayOfMonth; i++) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'calendar-day empty';
            calendarGrid.appendChild(emptyDiv);
        }

        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const profit = dailyProfits[dateString] || 0;
            const profitClass = profit > 0 ? 'positive' : (profit < 0 ? 'negative' : 'zero');
            const formattedProfit = formatCurrency(profit, 'USD'); // Display daily profit in USD

            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            dayDiv.innerHTML = `
                <div class="calendar-day-number">${day}</div>
                <div class="calendar-day-profit ${profitClass}">${formattedProfit}</div>
            `;
            calendarGrid.appendChild(dayDiv);
        }
    }

    function changeMonth(delta) {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
        renderCalendar();
    }

    // --- Portfolio Management Functions ---
    function addPortfolio() {
        const newPortfolioName = document.getElementById('newPortfolioName').value.trim();
        if (!newPortfolioName) {
            showError('El nombre de la cartera no puede estar vac√≠o.');
            return;
        }
        const newPortfolioId = `portfolio-${Date.now()}`;
        portfolios[newPortfolioId] = newPortfolioName;
        saveCustomData();
        renderPortfolioList();
        populatePortfolioDropdowns(); // Update dropdowns after adding
        document.getElementById('newPortfolioName').value = ''; // Clear input
        showError(`Cartera '${newPortfolioName}' a√±adida con √©xito.`);
    }

    function deletePortfolio(id) {
        if (id === 'default') {
            showError('No se puede eliminar la cartera predeterminada.');
            return;
        }
        if (!confirm(`¬øEst√°s seguro de que quieres eliminar la cartera "${portfolios[id]}"? Los activos en esta cartera se mover√°n a "Cartera Predeterminada".`)) {
            return;
        }
        delete portfolios[id];
        // Reassign assets from deleted portfolio to 'default'
        Object.keys(assetPortfolios).forEach(assetSymbol => {
            if (assetPortfolios[assetSymbol] === id) {
                assetPortfolios[assetSymbol] = 'default';
            }
        });
        saveCustomData();
        renderPortfolioList();
        populatePortfolioDropdowns(); // Update dropdowns after deleting
        updateAssetDisplay(); // Re-render assets with updated portfolios
        updateCryptoProfitList(); // Re-render profit list
        showError('Cartera eliminada con √©xito.');
    }

    function renderPortfolioList() {
        const portfolioListContainer = document.getElementById('portfolioList');
        portfolioListContainer.innerHTML = '';
        Object.entries(portfolios).sort(([, nameA], [, nameB]) => nameA.localeCompare(nameB)).forEach(([id, name]) => {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-2 bg-slate-500 rounded-lg';
            div.innerHTML = `
                <span class="text-white">${name}</span>
                ${id !== 'default' ? `<button class="delete-portfolio-btn bg-red-600 hover:bg-red-700 text-white p-1 rounded-full text-xs" data-id="${id}">üóëÔ∏è</button>` : ''}
            `;
            portfolioListContainer.appendChild(div);
        });
        document.querySelectorAll('.delete-portfolio-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                deletePortfolio(e.target.dataset.id);
            });
        });
    }

    function populatePortfolioDropdowns() {
        const newAssetPortfolioSelect = document.getElementById('newAssetPortfolio');
        const portfolioFilter = document.getElementById('portfolioFilter');
        const assetsPortfolioFilter = document.getElementById('assetsPortfolioFilter');

        [newAssetPortfolioSelect, portfolioFilter, assetsPortfolioFilter].forEach(selectElement => {
            selectElement.innerHTML = ''; // Clear existing options
            if (selectElement.id !== 'newAssetPortfolio') { // Add 'All Portfolios' option only to filters
                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = 'Todas las Carteras';
                selectElement.appendChild(allOption);
            }
            Object.entries(portfolios).sort(([, nameA], [, nameB]) => nameA.localeCompare(nameB)).forEach(([id, name]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = name;
                selectElement.appendChild(option);
            });
            // Set the selected value based on context
            if (selectElement.id === 'newAssetPortfolio') {
                selectElement.value = 'default';
            } else {
                selectElement.value = selectedPortfolio;
            }
        });
    }

    // --- Manage Assets Modal Functions ---
    function renderManageAssetsList() {
        const listContainer = document.getElementById('assetVisibilityList');
        listContainer.innerHTML = ''; // Clear existing list

        // Combine all assets and sort them alphabetically by name
        const sortedAssets = Object.entries(allAssets).sort(([, a], [, b]) => a.name.localeCompare(b.name));

        sortedAssets.forEach(([symbol, details]) => {
            const isChecked = visibleAssets.has(symbol);
            const currentPortfolio = assetPortfolios[symbol] || 'default'; // Get current portfolio

            let portfolioOptionsHtml = '';
            Object.entries(portfolios).sort(([, nameA], [, nameB]) => nameA.localeCompare(b.name)).forEach(([id, name]) => {
                portfolioOptionsHtml += `<option value="${id}" ${currentPortfolio === id ? 'selected' : ''}>${name}</option>`;
            });

            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-2 bg-slate-600 rounded-lg';
            div.innerHTML = `
                <div class="flex items-center space-x-2 flex-grow">
                    <input type="checkbox" id="toggle-${symbol}" class="form-checkbox h-5 w-5 text-blue-600 rounded" ${isChecked ? 'checked' : ''} data-symbol="${symbol}">
                    <label for="toggle-${symbol}" class="cursor-pointer">${details.name} (${symbol}) - ${details.type === 'crypto' ? 'Cripto' : 'Acci√≥n'}</label>
                </div>
                <select class="asset-portfolio-select bg-slate-600 text-white px-2 py-1 rounded-lg border border-slate-500" data-symbol="${symbol}">
                    ${portfolioOptionsHtml}
                </select>
            `;
            listContainer.appendChild(div);
        });

        // Attach event listeners for checkboxes
        listContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const symbol = e.target.dataset.symbol;
                if (e.target.checked) {
                    visibleAssets.add(symbol);
                } else {
                    visibleAssets.delete(symbol);
                }
                saveCustomData(); // Save changes immediately
                updateAssetDisplay(); // Re-render dashboard/assets views
            });
        });

        // Attach event listeners for portfolio selection dropdowns
        listContainer.querySelectorAll('.asset-portfolio-select').forEach(select => {
            select.addEventListener('change', (e) => {
                const symbol = e.target.dataset.symbol;
                assetPortfolios[symbol] = e.target.value;
                saveCustomData(); // Save changes immediately
                updateAssetDisplay(); // Re-render views to reflect portfolio changes
                updateCryptoProfitList(); // Re-render profit list
            });
        });
    }

    function addNewAsset() {
        const symbol = document.getElementById('newAssetSymbol').value.toUpperCase().trim();
        const name = document.getElementById('newAssetName').value.trim();
        const type = document.getElementById('newAssetType').value;
        const initialPrice = parseFloat(document.getElementById('newAssetInitialPrice').value);
        const cedearRatio = parseFloat(document.getElementById('newAssetCedearRatio').value);
        const portfolioId = document.getElementById('newAssetPortfolio').value;

        if (!symbol || !name || isNaN(initialPrice) || initialPrice <= 0) {
            showError('Por favor, completa S√≠mbolo, Nombre y Precio Inicial v√°lidos.');
            return;
        }
        if (allAssets[symbol]) {
            showError(`El activo con s√≠mbolo '${symbol}' ya existe.`);
            return;
        }

        const newAsset = {
            name: name,
            symbol: symbol, // Use the provided symbol
            price: initialPrice,
            change: 0, // Initial change is 0
            type: type,
            color: 'bg-indigo-500' // Default color for custom assets
        };

        if (type === 'stock') {
            newAsset.cedearRatio = isNaN(cedearRatio) || cedearRatio < 1 ? 1 : cedearRatio;
        }
        
        // Add the image if one was selected
        if (newAssetImageBase64) {
            newAsset.image = newAssetImageBase64;
        }

        customAssets[symbol] = newAsset;
        visibleAssets.add(symbol); // New asset is visible by default
        assetPortfolios[symbol] = portfolioId; // Assign to selected portfolio
        allAssets = { ...predefinedAssets, ...customAssets }; // Update combined assets

        // Initialize display mode for the new asset
        assetDisplayModes[symbol] = 'usd';

        saveCustomData();
        updateAssetDisplay();
        updateTransactionFormPrice(); // Update form dropdown
        updateCryptoProfitList(); // Update profit list
        renderManageAssetsList(); // Re-render the list in the modal
        renderIndividualBalances(); // Update individual balances

        // Clear form fields and reset image preview
        document.getElementById('newAssetSymbol').value = '';
        document.getElementById('newAssetName').value = '';
        document.getElementById('newAssetInitialPrice').value = '';
        document.getElementById('newAssetCedearRatio').value = '1';
        document.getElementById('newAssetPortfolio').value = 'default'; // Reset to default
        document.getElementById('newAssetImage').value = ''; // Clear file input
        document.getElementById('newAssetImagePreview').src = '#';
        document.getElementById('newAssetImagePreview').classList.add('hidden');
        newAssetImageBase64 = null; // Clear base64 data

        showError(`Activo '${name}' (${symbol}) a√±adido con √©xito.`);
    }


    // --- Event Listeners ---

    // Navigation buttons
    document.getElementById('dashboardBtn').addEventListener('click', () => {
      currentView = 'dashboard';
      document.getElementById('dashboardView').classList.remove('hidden');
      document.getElementById('assetsView').classList.add('hidden');
      document.getElementById('profitView').classList.add('hidden');
      document.getElementById('historyView').classList.add('hidden');
      document.getElementById('chartsView').classList.add('hidden');
      // Update button styles
      document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
      document.getElementById('dashboardBtn').classList.add('active');
      updateAssetDisplay(); // Ensure asset cards are up-to-date
      renderIndividualBalances(); // Ensure individual balances are up-to-date
    });

    document.getElementById('assetsBtn').addEventListener('click', () => {
      currentView = 'assets';
      document.getElementById('assetsView').classList.remove('hidden');
      document.getElementById('dashboardView').classList.add('hidden');
      document.getElementById('profitView').classList.add('hidden');
      document.getElementById('historyView').classList.add('hidden');
      document.getElementById('chartsView').classList.add('hidden');
      // Update button styles
      document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
      document.getElementById('assetsBtn').classList.add('active');
      updateAssetDisplay(); // Re-render asset cards
    });

    document.getElementById('profitBtn').addEventListener('click', () => {
      currentView = 'profit';
      document.getElementById('profitView').classList.remove('hidden');
      document.getElementById('dashboardView').classList.add('hidden');
      document.getElementById('assetsView').classList.add('hidden');
      document.getElementById('historyView').classList.add('hidden');
      document.getElementById('chartsView').classList.add('hidden');
      // Update button styles
      document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
      document.getElementById('profitBtn').classList.add('active');
      updateCryptoProfitList(); // Ensure profit list is up-to-date
    });

    document.getElementById('historyBtn').addEventListener('click', () => {
      currentView = 'history';
      document.getElementById('historyView').classList.remove('hidden');
      document.getElementById('dashboardView').classList.add('hidden');
      document.getElementById('assetsView').classList.add('hidden');
      document.getElementById('profitView').classList.add('hidden');
      document.getElementById('chartsView').classList.add('hidden');
      // Update button styles
      document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
      document.getElementById('historyBtn').classList.add('active');
      updateTransactionHistory(); // Ensure history is up-to-date
    });

    document.getElementById('chartsBtn').addEventListener('click', () => {
      currentView = 'charts';
      document.getElementById('chartsView').classList.remove('hidden');
      document.getElementById('dashboardView').classList.add('hidden');
      document.getElementById('assetsView').classList.add('hidden');
      document.getElementById('profitView').classList.add('hidden');
      document.getElementById('historyView').classList.add('hidden');
      // Update button styles
      document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
      document.getElementById('chartsBtn').classList.add('active');
      updateCharts(); // Ensure charts are up-to-date (will show overall by default or specific if set)
      renderCalendar(); // Ensure calendar is up-to-date
    });

    // Asset selection dropdown for transaction form
    document.getElementById('transactionAsset').addEventListener('change', (e) => {
      selectedAsset = e.target.value;
      updateTransactionFormPrice(); // Update price in form based on selected asset
    });

    document.getElementById('transactionType').addEventListener('change', (e) => {
      newTransaction.type = e.target.value;
    });

    document.getElementById('transactionAmount').addEventListener('input', (e) => {
      newTransaction.amount = e.target.value;
    });

    document.getElementById('transactionPrice').addEventListener('input', (e) => {
      newTransaction.price = e.target.value;
    });

    document.getElementById('transactionDate').addEventListener('input', (e) => {
      newTransaction.date = e.target.value;
    });

    document.getElementById('transactionNote').addEventListener('input', (e) => {
        newTransaction.note = e.target.value;
    });

    // Add/Update transaction button click
    document.getElementById('addTransaction').addEventListener('click', saveOrUpdateTransaction);
    // Cancel edit button click
    document.getElementById('cancelEdit').addEventListener('click', cancelEdit);
    // Refresh prices button click
    document.getElementById('refreshPrices').addEventListener('click', fetchAssetPrices);

    // Calendar navigation buttons
    document.getElementById('prevMonthBtn').addEventListener('click', () => changeMonth(-1));
    document.getElementById('nextMonthBtn').addEventListener('click', () => changeMonth(1));

    // Show overall charts button
    document.getElementById('showOverallChartsBtn').addEventListener('click', showOverallCharts);

    // Manage Assets button
    document.getElementById('manageAssetsBtn').addEventListener('click', () => {
        renderManageAssetsList(); // Populate the list when modal opens
        renderPortfolioList(); // Populate portfolio list in modal
        populatePortfolioDropdowns(); // Populate dropdowns in modal
        document.getElementById('manageAssetsModal').classList.remove('hidden');
        document.getElementById('manageAssetsModal').classList.add('flex'); // Ensure it's flex for centering
    });

    // Add New Asset button in modal
    document.getElementById('addNewAssetBtn').addEventListener('click', addNewAsset);

    // Add Portfolio button in modal
    document.getElementById('addPortfolioBtn').addEventListener('click', addPortfolio);

    // Save Asset Visibility button in modal (optional, as checkboxes update immediately)
    document.getElementById('saveAssetVisibilityBtn').addEventListener('click', () => {
        // The checkboxes already update `visibleAssets` and save to local storage on change.
        // This button just provides a confirmation/closure.
        closeModal('manageAssetsModal');
        showError('Visibilidad de activos y carteras guardada.');
    });

    // Profit currency selectors
    document.getElementById('todayProfitCurrencySelect').addEventListener('change', updateProfit);
    document.getElementById('totalProfitCurrencySelect').addEventListener('change', updateProfit);

    // Portfolio filter dropdowns
    document.getElementById('portfolioFilter').addEventListener('change', (e) => {
        selectedPortfolio = e.target.value;
        updateAssetDisplay(); // Re-render asset cards based on new filter
        updateCryptoProfitList(); // Re-render profit list based on new filter
        renderIndividualBalances(); // Re-render individual balances
        // Also update the other portfolio filter to match
        document.getElementById('assetsPortfolioFilter').value = selectedPortfolio;
    });

    document.getElementById('assetsPortfolioFilter').addEventListener('change', (e) => {
        selectedPortfolio = e.target.value;
        updateAssetDisplay(); // Re-render asset cards based on new filter
        updateCryptoProfitList(); // Re-render profit list based on new filter
        renderIndividualBalances(); // Re-render individual balances
        // Also update the other portfolio filter to match
        document.getElementById('portfolioFilter').value = selectedPortfolio;
    });

    // Event listener for new asset image input
    document.getElementById('newAssetImage').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                newAssetImageBase64 = e.target.result;
                const preview = document.getElementById('newAssetImagePreview');
                preview.src = newAssetImageBase64;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        } else {
            newAssetImageBase64 = null;
            document.getElementById('newAssetImagePreview').src = '#';
            document.getElementById('newAssetImagePreview').classList.add('hidden');
        }
    });


    // --- PWA Service Worker Registration (kept as is) ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(reg => console.log('Service Worker registrado'))
          .catch(err => console.error('Error al registrar Service Worker:', err));
      });
    }

    // --- Initial Setup on Page Load ---
    window.onload = function() {
        loadCustomData(); // Load custom assets, visibility, and portfolios first
        loadTransactions(); // Load existing transactions
        document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0]; // Set default date
        fetchAssetPrices(); // Fetch initial prices for all assets
        setInterval(fetchAssetPrices, 60000); // Refresh prices every 60 seconds
        updateAssetDisplay(); // Initial render of asset cards
        renderCalendar(); // Initial render of the calendar
        renderIndividualBalances(); // Initial render of individual balances
        populatePortfolioDropdowns(); // Populate all portfolio dropdowns
    };
  </script>
</body>
</html>

